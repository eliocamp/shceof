---
title: "Title Goes Here"
titlerunning:  Title
authors: 
- name: Elio Campitelli
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos, Buenos Aires, Argentina
    CONICET – Universidad de Buenos Aires, Centro de Investigaciones del Mar y la Atmósfera (CIMA), Buenos Aires, Argentina
    CNRS – IRD – CONICET – UBA, Instituto Franco‐Argentino para el Estudio del Clima y sus Impactos (UMI 3351 IFAECI), Buenos Aires, Argentina
  email: elio.campitelli@cima.fcen.uba.ar
  
- name:  Leandro B. Díaz
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos, Buenos Aires, Argentina
    CONICET – Universidad de Buenos Aires, Centro de Investigaciones del Mar y la Atmósfera (CIMA), Buenos Aires, Argentina
    CNRS – IRD – CONICET – UBA, Instituto Franco‐Argentino para el Estudio del Clima y sus Impactos (UMI 3351 IFAECI), Buenos Aires, Argentina
  
- name:  Carolina Vera
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos, Buenos Aires, Argentina
    CONICET – Universidad de Buenos Aires, Centro de Investigaciones del Mar y la Atmósfera (CIMA), Buenos Aires, Argentina
    CNRS – IRD – CONICET – UBA, Instituto Franco‐Argentino para el Estudio del Clima y sus Impactos (UMI 3351 IFAECI), Buenos Aires, Argentina

thanks: | 
  The research was supported by UBACyT20020170100428BA and the CLIMAX Project funded by Belmont Forum/ANR-15-JCL/-0002-01. Elio Campitelli was supported by a PhD grant from CONICET, Argentina.


 
keywords:

abstract: |
  abstract



date: "`r format(Sys.time(), '%d %B, %Y')`"

bibliography: 
  - references.bib
  - data.bib
  - packages.bib

bibstyle: spbasic
# bibstyle options spbasic(default), spphys, spmpsci
output: 
  bookdown::pdf_book: 
      base_format: rticles::springer_article
      latex_engine: "xelatex"
      citation_package: "natbib"
      # pandoc_args: ["--lua-filter=abstract-to-meta.lua"]
header-includes: 
 - \usepackage{gensymb}
 - \usepackage{subfig}
 - \usepackage[inline]{showlabels}
 - \usepackage{chngcntr}
 - \usepackage{natbib}
 - \usepackage{lineno}
 - \linenumbers 
---

<!-- cambiarn nomenclatura. Imaginario / real -> pasarlo a nombrar la fase -->

<!-- Chequear con ncep -->

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  cache = TRUE,
  comment = "#>",
  cache.extra = 42,
  cache.path = "../cache/paper/",
  fig.path = "../figures/",
  dpi = 300,
  dev = c("pdf", "png")
)



# ## Figure classes
# DefineClass <- function(class.opts) {
#     class.name <- deparse(substitute(class.opts))
#     class.fun <- function(options) {
#         class <- options[[class.name]]
#         class <- class.opts[[class]]
#         options[names(class)] <- class
#         options
#     }
#     invisible(knitr::opts_hooks$set(
#         setNames(list(class.fun), class.name)))
# }
# 
# page.width <- 210 - 30 - 25
# text.width <- page.width - 20
# text.height <- page.height <- 297 - 25 - 25
# 
# fig.class <- list(
#   colwidth = list(
#     fig.width = 5
#   ),
#     pagewidth = list(
#         fig.width = page.width/25.4,
#         out.width = paste0(page.width, "mm"),
#         # fig.align = "center",
#         fig.env = "figure*",
#         out.extra = " "
#     )
# )
# 
# DefineClass(fig.class)

width_column <- 3.6


library(metR)
library(data.table)
library(magrittr)
library(ggplot2)
library(tagger)
library(ggperiodic)
library(patchwork)
library(kableExtra)
library(shceof)



theme_set(theme_shceof(base_size = 10))

grid <- theme(panel.grid = element_line(color = "gray10", size = 0.4, linetype = 3))
no_grid <- theme(panel.grid = element_blank())

panel_background <- theme(panel.background = element_rect(fill = "#fbfbfb", color = NA), 
                          panel.ontop = FALSE,
                          tagger.panel.tag.background = ggplot2::element_rect(color = NA, 
                                                                              fill = "#fbfbfb"))

guide_colorstrip_bottom <- function(width = 15, height = 0.5, ...) {
  guide_colorstrip(title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}

guide_colorsteps_bottom <- function(width = 15, height = 0.5, even.steps = FALSE, ...) {
  guide_colorsteps(show.limits = TRUE, even.steps = even.steps,
                   title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}

axis_labs_smol <- theme(axis.text = element_text(size = 6))

pattern_dots <- ggplot2::ggproto("GeomDots", ggpattern::GeomPolygonPattern)
ggplot2::update_geom_defaults(pattern_dots, 
                              list(pattern = "circle",
                                   colour = NA,
                                   pattern_colour = "black",
                                   pattern_fill = "black",
                                   pattern_density = 0.05,
                                   pattern_alpha = 1,
                                   fill = NA,
                                   pattern_spacing = 0.025))

update_geom_defaults(GeomSmooth, list(colour = "#0d52bf"))


geom_contour_pval <- function(mapping, p.value = 0.01, size = 0.1, ...) {
  mapping2 <- mapping
  mapping2$fill <- aes(fill = NA)$fill
  list(
    stat_contour_filled(mapping2, breaks = c(0, p.value), fill = NA, geom = pattern_dots, ...),
    geom_contour2(mapping, breaks = p.value, size = size, ...)
  )
}


lab_lev <- AddSuffix(" hPa")
lab_cplx <- c(R = "Real", 
              I = "Imaginary")
lab_PC <- c(PC1 = "EOF1", 
            PC2 = "EOF2")

combine_lists <- function(...) {
  # browser(expr = length(x) != length(y))
  X <- list(...)
  names <- names(X[[1]])
  names(names) <- names
  lapply(names, function(n) {
    unlist(lapply(X, function(x) x[[n]]))
  })
}
```

```{r read-indices}
enso <- rsoi::download_oni(TRUE, data_path("raw", "oni.csv")) %>%
  as.data.table() %>%
  .[, .(time = lubridate::as_datetime(Date), oni = ONI)] %>%
  na.omit() %>%
  .[season(time) == "SON"] %>%
  .[, .(oni = mean(oni)), by = .(time = seasonally(time))]

sams <- readRDS(data_path("derived", "sam.Rds")) %>%
  .[season(time) == "SON"] %>%
  .[, dim :=  lubridate::days_in_month(time)] %>%
  .[, .(estimate = weighted.mean(estimate, dim)),
    by = .(lev, term, time = seasonally(time))]

levs <- unique(sams$lev)

for (l in seq_along(levs)[-1]) {
  cor <- sams[lev %in% levs[seq(l - 1, l)]] %>% 
    .[term == "full"] %>%
    dcast(time ~ lev, value.var = "estimate") %>% 
    setnames(., colnames(.), c("time", "old", "new")) %>% 
    .[, cor(old, new)]
  
  sams[lev == levs[l], estimate := sign(cor)*estimate]
}
```

```{r test-irlba}
has_irlba <- requireNamespace("rilba", quietly = TRUE)
if (has_irlba) {
  stop("If installed, metR::EOF uses irlba, but that package has a bug with complex matrices\n(see: https://github.com/bwlewis/irlba/issues/55). Uninstall irlba with renv::remove(\"irlba\") and try again.")
}

```

```{r read-data}
era5 <- ReadNetCDF(ERA5(), vars = c(hgt = "z",
                                    t = "t"),
                   subset = list(level = list(850, 700, 200, 50),
                                 latitude = -90:10)) %>% 
  normalise_coords() %>% 
  .[season(time) == "SON"] %>%
  .[, .(hgt = mean(hgt), 
        t = mean(t)), by = .(lev, lon, lat, time = seasonally(time))]
```

```{r compute-psi}
psi <- ReadNetCDF(ERA5(), vars = "vo",
                  subset = list(level = c(50, 200),
                                time = c("1979-01-01", "2019-12-01"))) %>%
  normalise_coords() %>%
  .[season(time) == "SON"] %>%
  .[, .(vo = mean(vo)), by = .(lon, lat, lev,time = seasonally(time))] %>%
  .[, solve_poisson(vo, lon, lat), by = .(lev, time)] %>%
  setnames("value", "psi") %>% 
  .[, psi.z := Anomaly(psi), by = .(time, lev, lat)] 
```


```{r o3}
o3 <- O3() %>% 
  ReadNetCDF(vars = c(toc = "tco3")) %>% 
  normalise_coords() %>% 
  .[, lon := ConvertLongitude(lon)] %>% 
  .[lat <= -20] %>% 
  .[, toc := toc/2.1415e-5] %>%    # transform to Dobson Units (https://sacs.aeronomie.be/info/dobson.php)
  .[, .(toc = mean(toc, na.rm = TRUE)), by = .(lon, lat, time = seasonally(time))]

o3wave_lats <- c(-70, -45)
```


```{r psa}
psa <- ReadNetCDF(ERA5(), vars = c(hgt = "z"),
                   subset = list(level = list(500),
                                 latitude = -90:0)) %>% 
  normalise_coords() %>% 
  .[, .(hgt = mean(hgt)), by = .(lon, lat, time = seasonally(time))] %>% 
  .[, value := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(lon, lat, season(time))] %>%
  EOF(value ~ time | lon + lat, n = 1:3, data = .)

psa <- lapply(psa, function(x) {
  copy(x)[, PC := fcase(PC == "PC1", "SAM", 
                        PC == "PC2", "PSA1", 
                        PC == "PC3", "PSA2")] 
})


psa_time <- psa$left[season(time) == "SON"]
```

# Introduction

# Data and Methods

## Data

We used monthly geopotential height, air temperature, ozone mixing ratio, and Total Ozone COlumn (TOC) at 2.5\degree\ longitude by 2.5\degree\ latitude of horizontal resolution and 37 vertical isobaric levels from ERA5 [@era5] for the period 1979 to 2019. We restricted most of our analysis to the post-satellite era to avoid any confounding factors arising from the incorporation of satellite observations, but we also used the preliminary back extension of ERA5 from 1950 to 1978 [@era5be] to look at long-term trends. We derived streamfunction at 200 hPa from ERA5 vorticity using the FORTRAN subroutine FISHPACK [@fishpack] and computed horizontal wave activity fluxes following @plumb1985. For precipitation data we used monthly data from the CPC Merged Analysis of Precipitation [@cmap], with a 2.5\degree\ resolution in latitude and longitude. This rainfall gridded dataset is based on information from different sources such as rain gauge observations, satellite
inferred estimations and the NCEP-NCAR reanalysis, and it is available since 1979 to present.

## Methods

\textcolor{red}{Aclarar qué a lo largo del trabajo se utilizan los datos de primavera y cómo se calcula eso. Tambień creo que acá se podría aclarar que el análisis se concentra en dos niveles para representar la estratósfera y la troposféra alta}

We computed the amplitude and phase of the zonal wave 1 by averaging variables (temperature, geopotential height, ozone mixing ratio and Total Ozone Column) `r knitr::combine_words(LatLabel(o3wave_lats))` for each Spring and computing the Fourier spectrum. 

We computed the level-dependent Southern Annular Mode (SAM) index as the leading EOF of year-round monthly geopotential height anomalies south of 20ºS at each level for the whole period [@baldwin2009]. We further split the SAM into its zonally symmetric and zonally asymmetric components (S-SAM and A-SAM indices respectively). These are obtained by projecting the zonally asymmetric and zonally symmetric part of the SAM spatial pattern onto monthly geopotential height fields [@campitelli2021]. Since the analysis here is only for the SON trimester, monthly values were averaged across trimesters. 

We also calculated the Pacific South American patterns (PSA1 and PSA2) as the third and fourth leading EOF of seasonal mean 500 hPa geopotential height with all seasons together following @mo2001. 

\textcolor{red}{Creo que habría que expandir un poco esta parte e ir comentando todoas las metodologías que vas usando: regresiones, tendencias, cómo evlauas significancia en cada caso, etc. }

## Complex Empirical Orthogonal Functions (cEOF)

(ref:eof-naive-cap) Spatial patterns of the leading 4 EOFs of zonal anomalies of geopotential height at 50 hPa and 200 hPa for the SON trimester and the period 1979 -- 2019 (arbitrary units). The numbers at the top-left of each panel ate the zonal variance explained by each EOF.


```{r compute-eof-naive}
eof_naive <- era5[lev %in% c(50, 200) & lat %between% c(-90, -20)] %>% 
  # .[, hgt := Anomaly(hgt), by = .(season(time), lon, lat, lev)] %>%
  .[, hgt  := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(time, lev, lat)] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1:4, data = .SD, suffix = "EOF"))), by = lev]

explained <- eof_naive[, eof[[1]]$sdev, by = lev] %>% 
  .[order(lev, EOF)] %>% 
  .[, scales::percent(r2, accuracy = .1)]

```

```{r eof-naive, fig.cap = "(ref:eof-naive-cap)", fig.width=3.7, fig.height=2.2}
eof_naive[, eof[[1]]$right, by = lev] %>%
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = hgt, fill = ..level..),
                    breaks = AnchorBreaks(0, 0.01, exclude = 0)) +
  geom_contour_tanaka(aes(z = hgt), breaks = AnchorBreaks(0, 0.01, exclude = 0), 
                    range = c(0.01, 0.2)) +
  
  geom_qmap(~.x[lat <= -20], size = 0.1) +
  scale_fill_divergent_discretised(guide = "none")  +
  scale_y_latitude() +
  scale_x_longitude() +
  coord_polar() +
  theme(axis.text = element_blank()) +
  facet_grid(lev~EOF, labeller = labeller(lev = lab_lev))  +
  tagger::tag_facets("rc")  +
  theme(panel.spacing = grid::unit(-.7, "lines"))
```

In traditional EOF analysis zonal waves appear as pairs of EOFs, usually degenerate, that represent similar patterns but shifted in phase \textcolor{red}{(Agregaría algunas referencias)}. For instance, Figure\ \@ref(fig:eof-naive) shows the leading 4 EOFs of zonally anomalous September through October \textcolor{red}{(November supongo. Sería bueno que ya arriba indiques lo de SON y ya después lo menciones directamente así)} geopotential height at 50 hPa and 200 hPa. It is clear that at 50 hPa the first two EOFs represent the same zonal wave 1 pattern and the last 2 represent the same zonal wave 3  \textcolor{red}{(No es visualmente obvia una estructura de onda 3. Solo se ven 4 centros)} pattern shifted by 1/4 wavelength. Similarly, EOFs 2 and 3 at 200 hPa represent the a zonal wave 3 pattern shifted by 1/4 wavelength. Since these pairs of EOFs seem to represent the same phase-varying structure, it would be desirable to combine them into a single index with amplitude and phase. 

Complex Empirical Orthogonal Functions (cEOF) is a useful method to characterise these waves [@horel1984]. This method involves augmenting the original fields with the Hilbert transform of the data and then computing the Singular Value Decomposition of it. In this work, instead of applying the Hilbert transform to the time series at each point, we apply it to each latitude circle at each moment in time. Since the latitude circle is a periodic domain, this procedure does not suffer from edge effects. The result of the cEOF is a set of complex spatial patterns and complex time series. The real and imaginary part of each spatial pattern represent two phases wave-like spatial pattern that are in quadrature. The magnitude and argument of each complex time series represent the amplitude and phase of each zonal wave. 


```{r corr-eofs}

background_palette <- grDevices::colorRampPalette(c("white", scales::muted("red")),
                                                  space = "Lab")
# 
# eof_naive[, eof[[1]]$left, by = lev] %>% 
#   .[, item := paste(lev, EOF, sep = "_")] %>% 
#   widyr::pairwise_cor(item, time, hgt) %>% 
#   setDT() %>%
#   # .[]
#   .[tstrsplit(item1, "_")[[1]] != tstrsplit(item2, "_")[[1]], ] %>% 
#   .[tstrsplit(item1, "_")[[1]] != 50] %>% 
#   .[, item1 := tstrsplit(item1, "_")[[2]]] %>%
#   .[, item2 := tstrsplit(item2, "_")[[2]]] %>% 
#   .[, r2 := round(correlation^2, 2)] %>% 
#   dcast(item1 ~ item2, value.var = "r2") %>% 
#   setnames("item1", "200 hPa") %>% 
#   kbl2(booktabs = TRUE, caption = "$R^2$ between pairs of EOFs of each level rounded to two decimals.") %>% 
#   # add_header_above(c("", "50 hPa" = 4)) %>% 
#   column_spec2(2:5,  background = spec_color2(.table[[.col]], option = background_palette, 
#                                               scale_from = c(0, 1)),
#                color = ifelse(.table[[.col]] > .5, "white", "black")) %>% 
#   add_header_above(c("", "50 hPa" = 4)) %>%
#   kable_classic()
```


```{r compute-ceof}
invisible(
  ReadNetCDF(ERA5(), vars = c(hgt = "z"),
             subset = list(latitude = -90:10,
                           level = list(200, 50))) %>%
    normalise_coords() %>%
    .[season(time) == "SON"] %>%
    .[, .(hgt = mean(hgt)), by = .(lev, lon, lat, time = seasonally(time))] %>%
    .[, season := season(time)] %>%
    {
      ceof <<- .[, .(eof = list(compute_ceof(.SD))), by = .(season)]
      ceof_splitted <<-  .[, levs := lev] %>%
        .[, .(eof = list(compute_ceof(.SD, n = 1:3))), by = .(season, levs)]
      
    }
)
```

```{r corr-ceof-splitted}
ceof_splitted[, eof[[1]]$left, by = .(lev = levs)] %>%
  copy() %>%
  .[, mag := abs(hgt)] %>%
  .[, item := paste(lev, PC, sep = "_")] %>%
  widyr::pairwise_cor(item, time, mag) %>%
  setDT() %>%
  # .[]
  .[tstrsplit(item1, "_")[[1]] != tstrsplit(item2, "_")[[1]], ] %>%
  .[tstrsplit(item1, "_")[[1]] != 50] %>%
  .[, item1 := tstrsplit(item1, "_")[[2]]] %>%
  .[, item2 := tstrsplit(item2, "_")[[2]]] %>%
  .[, r2 := round(correlation^2, 2)] %>%
  dcast(item1 ~ item2, value.var = "r2") %>%
  setnames("item1", "200 hPa") %>%
  kbl2(booktabs = TRUE, caption = "Coefficient of determination ($R^2$) of the absolute magnitude of complex EOFs between 200 hPa and 50 hPa computing EOF separatedly for each level.") %>%
  column_spec2(2:4, background = spec_color2(.table[[.col]], option = background_palette,
                                            scale_from = c(0, 1)),
               color = ifelse(.table[[.col]] > .5, "white", "black")) %>% 
  add_header_above(c("", "50 hPa" = 3)) %>%
  kable_classic() 
```

Another characteristic seen in Figure\ \@ref(fig:eof-naive) is that EOF1 at 200 hPa is very similar to EOF1 at 50 hPa  \textcolor{red}{(En la figura que yo veo, no diría que no similares. Aclara mejor a qué te referis)}. The zonal wave 3 structure in EOF2 and EOF3 at 200 hPa are also very similar to the one in EOF3 and EOF4 at 50 hPa, excecpt for the behaviour above the Indian Ocean. Furthermore, Table \@ref(tab:corr-ceof-splitted) shows the coefficient of determination between time series of the amplitude of each complex EOF across levels. There's a high degree of correlation between the respective EOF1 and EOF2 at each level. Both the spatial similarities and temporal correlations suggest some level of joint variability between levels. \textcolor{red}{(Revisar el parráfo considerando el comentario)}

Both observations \textcolor{red}{(¿Qué serían las dos osbervaciones?)}  motivate the decision of performing complex EOF jointly between levels. The computation of the EOFs was carried out using data from both levels at the same time, therefore, each complex EOF has a spatial component that depends on longitude, latitude and level, and a temporal component that depends only on time. 

The phase of principal components is defined up to an additive constant. For real principal components, this constant can be either 0 or $\pi$, corresponding to a change in sign. For complex principal components, it can be any number between 0 and $2\pi$ [@horel1984]. Since any choice is arbitrary and equally valid, we chose the phase of each EOF so that the real and imaginary parts are aligned with meaningful phases in our analysis. This procedure does not create a spurious correlation, it only takes whatever relationship that already exist and aligns it with a specific phase. 

```{r rotate_eofs}
rotate <- function(z, angle = 0) {
  complex(real = cos(angle), imaginary = sin(angle)) * z
}

angles <- seq(-pi, pi, by = .5*pi/180)

# rotations_pc1 <- lapply(angles, function(a) {
#   ceof$eof[[1]]$left[PC == "PC1"] %>%
#     copy() %>%
#     .[, hgt := rotate(hgt, a)] %>%
#     sep_ReIm() %>%
#     .[, .(mean = mean(hgt)), by = part] %>%
#     .[, rotation := a]
# }) %>%
#   rbindlist()
# 
# 
# best_rotation_pc1 <- rotations_pc1[part == "Real"][which.min(mean)]$rotation


wave1_o3 <- o3 %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(toc = weighted.mean(toc, w = cos(lat*pi/180), na.rm = TRUE)), by = .(time, lon)] %>% 
  .[, FitWave(toc, 1), by = .(time)] 

with_o3 <- ceof$eof[[1]]$left %>% 
  .[PC == "PC1"] %>% 
  .[wave1_o3, on = "time"]
  

rotations_o3 <- lapply(angles, function(a) {
  with_o3 %>% 
    copy() %>% 
    .[, hgt := rotate(hgt, a)] %>% 
    na.omit() %>% 
    sep_ReIm() %>% 
    .[, .(cor = cor(amplitude, hgt)), by = part] %>% 
    .[, rotation := a]
}) %>% 
  rbindlist()


best_rotation_pc1 <- rotations_o3[part == "Real"][which.max(cor)]$rotation


with_enso <-  cut(ceof$eof[[1]], 2)$left %>%
  copy() %>%
  .[enso, on = "time"] %>% 
  na.omit() 
  
rotations_pc2 <- lapply(angles, function(a) {
  with_enso %>%
    .[, hgt2 := rotate(hgt, a)] %>%
    .[, .(R = cor(Re(hgt2), oni),
          I = cor(Im(hgt2), oni))] %>%
    .[, rotation := a]
}) %>%
  rbindlist()

best_rotation_pc2 <- rotations_pc2[I > 0][which.min(abs(R))]$rotation


eof_rotated_left <- ceof$eof[[1]]$left %>%
  copy() %>%
  .[PC == "PC2", hgt := rotate(hgt, best_rotation_pc2)] %>%
  .[PC == "PC1", hgt := rotate(hgt, best_rotation_pc1)]

eof_rotated_right <-  ceof$eof[[1]]$right %>%
  copy() %>%
  .[PC == "PC2", hgt := rotate(hgt, best_rotation_pc2)] %>%
  .[PC == "PC1", hgt := rotate(hgt, best_rotation_pc1)]

ceof_unrotated <- copy(ceof)

ceof$eof[[1]]$left <- eof_rotated_left
ceof$eof[[1]]$right <- eof_rotated_right

ceof <- rbindlist(list(rotated = ceof,
                       unrotated = ceof_unrotated),
                  idcol = "rotation")

rotated <- function(x) x[rotation == "rotated"]
unrotated <- function(x) x[rotation == "unrotated"]
```

```{r check-rotation}
# Check that rotated and unrotated eofs
# predict the same fields (up to floating point errors)
bad_cells <- ceof[, predict(eof[[1]]), by = rotation] %>%
  .[, hgt := as.numeric(Re(hgt))] %>%
  dcast(time + lon + lat + lev ~ rotation, value.var = "hgt") %>%
  .[, dif := rotated - unrotated] %>%
  .[abs(rotated - unrotated)  > 1e-10]

if (nrow(bad_cells) != 0) {
  stop("Rotated and unrotated eofs are not equivalent!")
}

ceof <- ceof[rotation == "rotated"][, rotation := NULL][]
```


(ref:rotations-cap) a) Correlation of the Real and Imaginary EOF1 with wave 1 amplitude of  Total Ozone Column averaged between `r knitr::combine_words(LatLabel(o3wave_lats))` and b) $R^2$ between the Real and Imaginary EOF2 and the ONI index for different values of rotation. The vertical line marks the selected rotation, which maximises de correlation.


```{r rotations, fig.cap = "(ref:rotations-cap)", fig.width=width_column, fig.height=2.5}
r2 <- expression(`$r^2$` = paste("", "r", phantom()^{
    paste("2")
}, "", ""))


rotations_o3 %>%
  ggplot(aes(rotation, cor)) +
  geom_vline(xintercept = best_rotation_pc1) +
  geom_hline(yintercept = 0,  size = 0.2, color = "gray50") +
  geom_line(aes(color = part)) +
  scale_x_continuous("Rotation", breaks = seq(-pi, pi, by = 90*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  scale_y_continuous("Correlation") +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_cplx) +
  
rotations_pc2 %>%
  melt(id.vars = "rotation") %>%
  ggplot(aes(rotation, value^2)) +
  geom_hline(yintercept = 0,  size = 0.2, color = "gray50") +
  geom_vline(xintercept = best_rotation_pc2) +
  geom_line(aes(color = variable)) +
  scale_x_continuous("Rotation", breaks = seq(-pi, pi, by = 90*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  scale_y_continuous(r2) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_cplx) +
  
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "a", tag_suffix = ")")
```

\textcolor{red}{(No mostraría la figura 2. Me parece que agrega una complejidad extra y no sé entiende demasiado, sino se la explica muy bien)}

For the first complex principal component, the phase was chosen so that the time series corresponding to the real part has the maximum correlation with the zonal wave 1 of Total Ozone Column between `r knitr::combine_words(LatLabel(o3wave_lats))`. This also nearly minimises the correlation with the imaginary part (Figure\ \@ref(fig:rotations)a).

For the second complex principal component, the phase was chosen so that the coefficient of determination between the Oceanic Niño Index [@bamston1997] and the real part was minimized, which also nearly maximizes the correlation with the imaginary part (Figure\ \@ref(fig:rotations)b). 

## Computation procedures

We performed all analysis in this paper using the R programming language [@rcoreteam2020], using the data.table package [@dowle2020] and the metR package [@campitelli2020]. All graphics are made using ggplot2 [@wickham2009]. We downloaded data from reanalysis using the ecmwfr package [@hufkens2020] and indices of the ENSO with the rsoi package [@albers2020]. The paper was rendered using knitr and rmarkdown [@xie2015;@allaire2019].


# Results

## Zonal anomalies circulation modes (no me convence del todo, pero debería ser algo así)


```{r define-plot_ceof}
plot_ceof <- function(data, n = 1:2, formula = lev  ~  PC) {
  
  gdata <- data[, cut(eof[[1]], n)$right, by = .(season)]
  
  var <- data[, cut(eof[[1]], n)$sdev, by = .(season)] %>%
    .[, setNames(paste0(PC, " (", scales::percent(r2), ")"),
                 PC)]
  
  gdata %>%
    ggperiodic::periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    
    geom_contour_fill(aes(z = Re(hgt), fill = ..level..),
                      breaks = AnchorBreaks(0, 0.005, exclude = 0)) +
    geom_contour2(aes(z = Im(hgt),  linetype = factor(sign(..level..))),
                  breaks = AnchorBreaks(0, 0.005, exclude = 0)) +
    
    scale_fill_divergent_discretised(guide = "none") +
    
    
    geom_qmap(~ .x[lat <= -20]) +
    scale_x_longitude() +
    scale_y_latitude() +
    scale_linetype_manual(values = c("1" = 1, "-1" = 2), labels = c("1" = "+", "-1" = "-"),
                          guide = "none") +
    facet_grid(formula,
               labeller = labeller(lev = lab_lev,
                                   PC = var)) +
    coord_quickmap(ylim = c(NA, -20)) +
    theme(legend.title = element_blank())
}
```

```{r ceofs-1, fig.cap = "Spatial patterns of the leading 2 complex EOFs of zonal anomalies of geopotential height in 50 hPa and 200 hPa for the SON trimester and the period 1979 -- 2019. Real part in shading, imaginary part in contours", fig.width=width_column, fig.height=width_column}
ceof[season == "SON"] %>%
  plot_ceof() +
  coord_polar() +
  axis_labs_smol +
  tag_facets(tag = "cr")
```

```{r ceofs-2, fig.cap = "Time series of the leading 2 complex EOFs of zonal anomalies of geopotential height in 50 hPa and 200 hPa for the SON trimester and the period 1979 -- 2019.", fig.height=width_column, fig.width = width_column}
ceof %>%
  .[, eof[[1]]$left, by = season] %>%
  sep_ReIm(hgt) %>%
  .[season == "SON"] %>%
  # .[, hgt := scale(hgt), by = .(part, PC)] %>%
  ggplot(aes(time, hgt)) +
  geom_hline(yintercept = 0, size = 0.1, color = "gray30") +
  geom_line(aes(color = part)) +
  scale_x_datetime(NULL) +
  scale_y_continuous("EOF") +
  scale_color_brewer(NULL, palette = "Dark2") +
  facet_grid(PC ~ .) +
  theme(panel.spacing = grid::unit(1.5, "lines"))  +
  ggthemes::geom_rangeframe(sides = "lr", size = 0.1, color = "gray30") +
  panel_background
```

To describe the spatial and temporal variability of the circulation zonal anomalies, the spatial and temporal parts of the first two leading cEOFs of zonal anomalies of geopotential height at 50 hPa and 200 hPa are shown in Figures \@ref(fig:ceofs-1) and \@ref(fig:ceofs-2). The first mode (CEOF1) explains 82% of the variance, while the second mode (CEOF1) explains a smaller fraction (7%).  In the spatial patterns (Fig.\ \@ref(fig:ceofs-1)), the real (in shading) and the imaginary components (in contour) are in quadrature by construction, so that each cEOF describe a single wave-like pattern whose amplitude and position (i.e. phase) is controlled by the magnitude and phase of the complex temporal EOF. The wave patterns described by these cEOFs match the patterns seen in the traditional EOFs of Figure\ \@ref(fig:eof-naive): The first is mainly a wave 1, while the second is a wave 3. 

The temporal variability for both components of the cEOF1 have non zero mean (Fig.\ \@ref(fig:ceofs-2)). This is due to the fact that the geopotential fields that enter into the cEOFs algorithm are anomalies with respect to the zonal mean, not the time mean. As a consequence, the variability associated with the first cEOF includes variability that projects onto the mean zonally anomalous field.

\textcolor{red}{(Acá creo que habría que ampliar un poco más la discusión. diciendo en más detalle lo que se ve en la parte espacial (donde se ven los centros más importantes, qué diferencias hay entre estratósfera y troposféra) y temporal, por ej. qué tipo de variabilidad se observa, si están correlacionadas)}

```{r era_more}
pattern <- ceof$eof[[1]]$right %>%
  sep_ReIm() %>%
  setnames("hgt", "EOF")


era_more <- rbind( 
  ReadNetCDF(ERA5_BE(), vars = c(hgt = "z"),
             subset = list(latitude = range(pattern$lat),
                           level = list(200, 50))),
  ReadNetCDF(ERA5(), vars = c(hgt = "z"),
             subset = list(latitude = range(pattern$lat),
                           level = list(200, 50)))) %>%
  normalise_coords() %>%
  .[season(time) == "SON"] %>%
  .[, .(hgt = mean(hgt)), by = .(lev, lon, lat, time = seasonally(time))] %>%
  .[, season := season(time)] %>%
  .[, hgt := hgt/sd(hgt), by = .(lev)] %>%
  .[pattern, on = .NATURAL, allow.cartesian = TRUE] %>%
  .[, .(hgt = weighted.mean(hgt*EOF, w = cos(lat*pi/180))),  by = .(part, PC, time)] 

```

(ref:extended-series-cap) Time series extended using ERA5 back extended preliminary edition (period 1950 -- 1978) and ERA5 (period 1979 -- 2019). Each series is computed by projecting monthly geopotential height zonal anomalies standardised by level south of 20ºS onto the corresponding spatial pattern and scaled to zero mean and unit standard deviation.

```{r extended-series, fig.cap = "(ref:extended-series-cap)", fig.height=3, fig.width = 7, fig.env = "figure*"}
# Check that the extended index coincides with the
# original index.
cors <- era_more %>%
  .[sep_ReIm(ceof$eof[[1]]$left), on = c("time", "PC", "part")] %>%
  na.omit() %>%
  .[, cor(hgt, i.hgt), by = .(PC, part)]

if (any(cors$V1 < 0.98)) {
  stop("Extended indices didn't work!")
}


trends <- era_more %>%
  .[, FitLm(hgt, time, se = TRUE), by = .(part, PC)] %>%
  rm_intercept() %>%
  .[, p_val := Pvaluate(estimate, std.error, df)] %>%
  .[, p_report := report_p(p_val)]

# era_less <-   ceof %>%
#   .[, eof[[1]]$left, by = season] %>%
#   sep_ReIm(hgt) %>%
#   .[season == "SON"] %>% 
#   .[, hgt := as.numeric(scale(hgt)), by = .(part, PC)] 


era_more %>%
  copy() %>% 
  .[, ref := year(time) > 1979] %>% 
   # .[, hgt := scale(hgt, center = FALSE, scale = sd(hgt[ref])), by = .(part, PC)] %>%
  ggplot(aes(time, hgt*1e3)) +
  # Zero line + rangeframe
  geom_hline(data = ~.x[, mean(hgt)*1e3, by  = .(PC, part)], 
             aes(yintercept = V1), size = 0.1, color = "gray30") +
  ggthemes::geom_rangeframe(sides = "lr", size = 0.1, color = "gray30") +
  geom_line() +
  # geom_line(data = era_less) +
  scale_alpha_manual(values = c(1, 0.2)) +
  geom_smooth(method = "lm", color = "black") +
  scale_x_datetime(NULL, date_labels = "%Y") +
  scale_y_continuous("EOF") +
  
  facet_grid(PC ~ part, labeller = labeller(PC = lab_PC), scales = "free_y") +
  theme(panel.spacing = grid::unit(1.5, "lines"))  +
  tag_facets("cr") +
  panel_background
```

Figure\ \@ref(fig:extended-series) shows time series of the two complex EOFs extended beyond the satellite era using the preliminary ERA5 back extension going back to 1950. \textcolor{red}{(Me viene una duda metodológica que vendría bien aclarar. Cuando decis que lo extendes, ¿es que lo calculaste para todo ese período o que proyectas el modo en los otros tiempos?)} There is a significant upward trend in the real component of cEOF1 (Figure\ \@ref(fig:extended-series)a.1, p-value `r trends[part == "Real" & PC == "PC1"]$p_report`) and no significant trend in any of the complex components of cEOF2. The positive trend in the real cEOF1 translates into a positive trend in cEOF1 magnitude, but not in the phase (not shown). \textcolor{red}{(¿Qué interpretación se le podría dar a esto? ¿Que las amplitudes de las anomalías asociadas al modo son cada vez mayores?)}


## Regressions  (me parece que habría que decirlo de una forma más precisa o juntarlo a la sección anterior)


The spatial patterns shown in Figure\ \@ref(fig:ceofs-1) are derived by removing the zonally symmetric circulation, so they might not include all the variability that is actually associated with the cEOF time series. They are also idealised in that they are forced by construction, to be Hilbert transforms of each other \textcolor{red}{(¿Cómo se interpretaría esto?, la oración no es muy clara)}. To get a more realistic view of the real-world variability described by these cEOFs, we computed regression patterns of each cEOF with the complete geopotential fields. 

\textcolor{red}{(El parráfo anterior quizás hay que trabajarlo un poco más, porque tiene algunos términos que pueden no entenderse bien o que no son los más correctos ("real-world"). También quizás esto conviene directamente contarlo cuando se describe la metodología.)}

```{r compute-regression}
regr <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[season == "SON"] %>%
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))),
    by = .(season, PC)] %>%
  dcast(time ~ PC, value.var = c("Real", "Imaginary")) %>%
  .[melt(era5, id.vars = c("time", "lon", "lat", "lev")), on = "time", allow.cartesian = TRUE] %>%
  .[lev %in% c(850, 700, 200, 50)] %>%
  # .[variable == "hgt"] %>%
  .[, FitLm(value, Imaginary_PC1, Real_PC1, Imaginary_PC2, Real_PC2, se = TRUE),
    by = .(lev, lon, lat, variable)] %>%
  .[, c("term", "PC") := tstrsplit(term, "_")] %>%
  rm_intercept() %>%
  .[, term := factor_ReIm(term)]
```

```{r plot_regr}
plot_regr <- function(data, which_PC, which_levs, which_var) {
  data <- data %>%
    .[ PC %in% which_PC] %>%
    .[variable == which_var]
  
  var_title <- switch(which_var,
                      hgt = "Geopotential height",
                      t = "Temperature")
  lab_pc <- c(PC1 = "EOF1", PC2 = "EOF2")
  
  
  if (length(which_PC) > 1) {
    facet <- ggh4x::facet_nested(PC ~  term)
  } else {
    facet <- ggh4x::facet_nested(lev ~ PC +  term, labeller = labeller(lev = lab_lev, PC = lab_pc))
  }
  
  if ("lev" %in% colnames(data)) {
    data <- data[lev %in% which_levs]
  } else {
    data[, lev := which_levs]
  }

  data[lat <= -20] %>%
    # .[term == "I" & lev == 50] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(lev, PC, term)] %>%
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(exclude = 0), global.breaks = FALSE) +
    geom_contour_tanaka(aes(z = estimate), breaks = AnchorBreaks(exclude = 0), global.breaks = FALSE) +
    scale_fill_divergent(var_title, breaks = AnchorBreaks(0, exclude = 0),
                         guide = guide_colorstrip_bottom(15)) +
    geom_contour_pval(aes(z = p.value)) +
    
    geom_qmap(~ .x[lat <= -20]) +
    
    scale_x_longitude() +
    scale_y_latitude() +
    facet +
    coord_polar() +
    axis_labs_smol +
    tag_facets("rc")
}
```

(ref:eof1-regr-gh-cap) Regression coefficients of the real and imaginary part of the first complex EOF on SON geopotential height for the 1979 -- 2019 period. These coefficients come from multiple linear regression involving the real and imaginary part of both EFO2.

```{r eof1-regr-gh, fig.cap = "(ref:eof1-regr-gh-cap)", fig.height=1.2*width_column, fig.width=width_column, dependson="plot_regr"}
plot_regr(regr , "PC1", c(200, 50), "hgt") +
  # geom_contour2(data = ~copy(.x)[, estimate := Anomaly(estimate), by = .(term, lev, lat)],
  #              aes(z = estimate, linetype = factor(-sign(..level..))), 
  #              global.breaks = FALSE, breaks = AnchorBreaks(0, bins = 2, exclude = 0)) +
  # scale_linetype(guide = "none") +
  NULL

```

Figure\ \@ref(fig:eof1-regr-gh) shows regression patterns between geopotential height anomalies and cEOF1. At 50 hPa (Figure\ \@ref(fig:eof1-regr-gh) row a), both the Real and Imaginary EOF1 are associated with planetary wave 1 patterns, that are 90º off phase. Their phases coincide with the ones shown in Figure\ \@ref(fig:ceofs-1)a.1, with the positive centre of the real cEOF1 located towards the dateline, and the one of the Imaginary cEOF1 located over Eastern Antarctica. However, the cReal EOF1 pattern is substantially altered by the zonally symmetric circulation. Instead of a clear wave 1 pattern, the regression pattern can be better describes as a monopole with its centre displaced from the South Pole. 

The regression patterns at 200 hPa (Figure\ \@ref(fig:eof1-regr-gh) row b) are similarly influenced by the zonally symmetric circulation. It is only possible to distinguish partially the wave 1 pattern in relation with the real cEOF1 (Figure\ \@ref(fig:eof1-regr-gh)b.1). The imaginary cEOF1 shows a much more zonally symmetrical pattern resembling a negative Southern Annular Mode. 

With the exception of the imaginary cEOF1, it is clear that these patterns are very different than the fully zonally asymmetric versions (Fig.\ \@ref(fig:ceofs-1)), particularly at 200 hPa. Moreover, only in the stratosphere these patterns actually show a distinguishable wave 1 pattern shifted in phase by 90º. This should not be utterly surprising, since the spatial patterns of the *naive* EOFs only show this feature at 50 hPa (Fig.\ \@ref(fig:eof-naive)), suggesting that using the cEOF method is artificially generating a wave structure at 200hPa. Therefore, the magnitude and phase of the EOF1 are associated with the magnitude and phase of a zonal wave only in the stratosphere. While in the troposphere, they are associated with slightly off-centre monopoles.

(ref:eof2-regr-gh-cap) Same as Figure\ \@ref(fig:eof1-regr-gh) but for the second EOF.

```{r eof2-regr-gh, fig.cap = "(ref:eof2-regr-gh-cap)", fig.height=1.3*width_column, fig.width=width_column, dependson="plot_regr"}
plot_regr(regr, "PC2", c(200, 50), "hgt") 

```

Figure\ \@ref(fig:eof2-regr-gh) shows the regression pattern of geopotential height and the cEOF2. Unlike for cEOF1, in this case the regression patterns are similar to the fully zonally assymetric patterns from Figure\ \@ref(fig:ceofs-1). Although there are some differences (particularly in 50 hPa), the wave trains identified before are well characterised and patterns associated with the real cEOF2 are 90º out of phase with those associated with the imaginary cEOF2. Zonal wave 3 dominates all fields, but only in the western hemisphere, over the Pacific and Atlantic Oceans. cEOF2 then represents a equivalent barotropic wave train that is very similar to the the Pacific South American Patterns [@mo2001]. Comparing the location of the positive anomaly near 90ºW in column b of Figure\ \@ref(fig:eof2-regr-gh) with Figures 1.a and b from @mo2001, the real cEOF2 can roughly be identified with PSA2, while the imaginary cEOF2 resembles PSA1. This separation is not completely meaningful in this case, since by treating this pattern as a single wave train any one pair of orthogonal waves can characterise this variability \textcolor{red}{(No me quedo del todo claro el sentido de esta última oración. Si podes ampliarla o reescribirla de otra manera, mejor)}. 

```{r zonal-waves, fig.cap = "Amplitud de ondas zonales de la regresión con altura geopotencial (figuras anteriores)"}
# regr %>%
#   .[lat <= -20] %>%
#   .[lev %in% c(200, 50)] %>%
#   # .[PC == "PC1"] %>%
#   .[, FitWave(estimate, 0:3), by = .(lev, PC, term, lat)] %>%
#   # .[, pseudor2 := amplitudepseudor2^2/sum(amplitude^2), by = .(lev, PC, term, lat)] %>% 
#   ggplot(aes(lat, amplitude)) +
#   geom_line(aes(color = factor(k))) +
#   ggh4x::facet_nested(PC + lev ~ term, scales = "free", labeller = labeller(lev = lab_lev)) +
#   scale_color_brewer("Wavenumber", palette = "Dark2") +
#   scale_y_continuous("Amplitude") +
#   scale_x_latitude() +
#   coord_flip() +
#   panel_background
```

## cEOFs relationship with other variables

### Temperature and Ozone

(ref:eof1-regr-t-cap) Same as Figure\ \@ref(fig:eof1-regr-gh) but for air temperature.

```{r eof1-regr-t, fig.cap = "(ref:eof1-regr-t-cap)",  dependson="plot_regr", fig.height=1.3*width_column, fig.width=width_column}
plot_regr(regr, "PC1", c(200, 50), "t")
```


```{r t}
t <- ERA5() %>% 
  ReadNetCDF(vars = c("t", hgt = "z", "o3"), 
             subset = list(latitude = c(-90, -20))) %>% 
  normalise_coords() %>% 
  .[season(time) == "SON"] %>%
  .[, .(t = mean(t),
        o3 = mean(o3),
        hgt = mean(hgt)), by = .(lev, lon, lat, time = seasonally(time))]
```

(ref:t-vertical-cap) Regression coefficients between cEOF1 and zonal anomalies of mean air temperature (shaded) and ozone mixing ratio (contours, negative contours with dashed lines, labels in parts per billion by mass) averaged between 80ºS and 35ºS for the period 1979 -- 2019.

```{r lable_placement_min}
lable_placement_min <- function(direction = c("vertical", "horizontal"))  {
  direction <- direction[1]
  function(x, y) {
    if (direction == "vertical") {
      return(which.min(y))
    }
    else if (direction == "horizontal") {
      return(which.min(x))
    }
  }
}
```

```{r t-vertical, fig.cap = "(ref:t-vertical-cap)", fig.height=2.5, fig.width=width_column}
t %>% 
  .[lat %between% c(-80, -35)] %>% 
  .[, .(hgt = weighted.mean(hgt, cos(lat*pi/180)),
        o3 = weighted.mean(o3, cos(lat*pi/180)),
        t = weighted.mean(t, cos(lat*pi/180))), by = .(lev, time, lon)] %>%  
  melt(id.vars = c("lev", "time", "lon")) %>% 
  .[, value := Anomaly(value), by = .(time, lev, variable)] %>%
  .[cut(ceof$eof[[1]], 1)$left, on = "time"] %>% 
  sep_ReIm(format = "wider") %>% 
  .[, ":="(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))), by = .(PC)] %>% 
  .[, FitLm(value, Real, Imaginary, se = TRUE), by = .(lev, lon, variable)] %>% 
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)] %>% 
  # .[, z := metR:::standard_atmosphere$altitude(lev*100)] %>% 
  # .[, dz1 := c(NA, diff(estimate)/diff(z)) , by = .(term, lon, variable)] %>% 
  # .[, dz2 := c(diff(estimate)/diff(z), NA) , by = .(term, lon, variable)] %>% 
  # .[, dz := (dz1 + dz2)/2] %>% 
  # .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, variable)] %>%
  # .[lev < 900] %>% 
  ggplot(aes(lon, lev)) +
  geom_contour_fill(data = ~.x[variable == "t"],
                    aes(z = estimate, fill = ..level..),
                    breaks = AnchorBreaks(0, binwidth = 0.25, exclude = 0)) +
  geom_contour_tanaka(data = ~.x[variable == "t"],
                      aes(z = estimate),
                      breaks = AnchorBreaks(0, binwidth = 0.25, exclude = 0)) +
  geom_contour2(data = ~.x[variable == "o3"], 
                aes(z = estimate, linetype = factor(-sign(..level..))), 
                breaks = AnchorBreaks(0, exclude = 0)) +
  geom_text_contour(data = ~.x[variable == "o3"], 
                aes(z = estimate*1e9, label = signif(..level.., 2)),
                size = 2,
                skip = 1, stroke = 0.15, stroke.colour = "white", 
                label.placement = lable_placement_min(),
                breaks = AnchorBreaks(0, exclude = 0)) +
 
  scale_fill_divergent_discretised("Air temperature", guide = guide_colorsteps_bottom(15)) + 
  scale_y_level() +
  scale_linetype(guide = "none") +
  scale_x_longitude(ticks = 60) +
  facet_grid(~term) +
  axis_labs_smol +
  coord_cartesian(clip = "off")
```

Figure\ \@ref(fig:eof1-regr-t) shows regression patterns of air temperature at 50hPa and 200hPa onto cEOF1. In both levels, the distribution of temperature anomalies \textcolor{red}{(Ojo que cuando se habla de regresiones uno no muestra anomalías sino coeficientes de regresión)} mirror the geopotential height anomalies in 50 hPa (Fig. XX) \textcolor{red}{(Dar un poco más de detalle de lo que se ve, aunque sea lo mismo de antes)}. The vertical distribution of these patterns is shown in Figure\ \@ref(fig:t-vertical)) that shows the regression coefficientes between cEOF1 and zonal anomalies of air temperature and zonal anomalies of ozone mixing ratio averaged between 80ºS and 35ºS. Temperature zonal anomalies associated with cEOF1 show a clear wave 1 pattern for both real and imaginary components throughout the atmosphere above 200 hPa  \textcolor{red}{(¿Empiezan en 200 hPa los contornos?)}  with a change in sign above 10 hPa. Following hydrostatic balance, this is the level in which the geopotential anomaly have maximum amplitude (not shown). 

The maximum ozone anomalies are co-located with the minimum temperature anomalies above 10 hPa and with the maximum temperature anomalies below 10 hPa (Fig.\ \@ref(fig:t-vertical))); that is, the ozone zonal wave 1 is anticorrelated with the temperature zonal wave 1 in the upper stratosphere, and directly correlated in the upper stratosphere  \textcolor{red}{(¿Sabes si se le puede creer mucho a los datos allá arriba o agregamos alguna nota precautoria?)} . This change in phase is observed in ozone anomalies forced by planetary waves that reach the stratosphere. In the photochemically-dominated upper stratosphere, cold temperatures inhibit the destruction of ozone, and the advectively-dominated lower stratosphere, ozone anomalies are 90º out of phase with horizontal and vertical transport, which is 90º our of phase with temperature anomalies [@hartmann1979;@wirth1993;@smith1995].


```{r o3-t-phase}
# t %>% 
#   .[lat %between% c(-80, -35)] %>% 
#   .[, .(o3 = weighted.mean(o3, cos(lat*pi/180)),
#         t = weighted.mean(t, cos(lat*pi/180))), by = .(lev, time, lon)] %>%  
#   melt(id.vars = c("lev", "time", "lon")) %>% 
#   # .[, value := Anomaly(value), by = .(time, lev, variable)] %>%
#   .[cut(ceof$eof[[1]], 1)$left, on = "time"] %>% 
#   sep_ReIm(format = "wider") %>% 
#   .[, ":="(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))), by = .(PC)] %>% 
#   .[, FitLm(value, Real, Imaginary, se = TRUE), by = .(lev, lon, variable)] %>% 
#   rm_intercept() %>% 
#   .[, term := factor_ReIm(term)] %>% 
#   .[, FitWave(estimate, 1), by = .(lev, variable, term)] %>% 
#   dcast(lev + term ~ variable, value.var = c("phase", "amplitude")) %>%
#   ggplot(aes(lev, acos(cos(phase_t - phase_o3)))) +
#   geom_line(aes(color = term)) +
#   scale_x_level() +
#   scale_colour_brewer(NULL, palette = "Dark2") +
#   scale_y_continuous("Wave-1 phase difference\nbetween Temperature and Ozone",
#                      breaks = seq(-pi, pi, by = 30*pi/180),
#                      labels = function(x) paste0(round(x*180/pi, 5), "º"))  +
#   coord_flip()
```

```{r o3_regr} 
temp <- ceof$eof[[1]]$left %>% 
  .[PC == "PC1"] %>% 
  copy() %>% 
  sep_ReIm(format = "wider") %>% 
  .[, `:=`(Real = as.numeric(scale(Real)), 
           Imaginary = as.numeric(scale(Imaginary))),
    by = .(PC)]
o3_mean <- o3 %>% 
  .[, .(toc = mean(toc)), by = .(lon, lat)] %>% 
  .[, toc_z := Anomaly(toc), by = .(lat)]
o3_regr <- temp %>% 
  o3[., on = "time", allow.cartesian = TRUE] %>% 
  .[, FitLm(toc, Real, Imaginary, se = TRUE), by = .(lon, lat, PC)] %>% 
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)]
```

(ref:o3-regr-cap) Regression coefficients of SON mean Total Ozone Column anomalies onto the real (a) and imaginary (b) components of the cEOF1. On contours, the mean zonal anomaly of Total OZone Column (negative contours in dashed lines). ¿Units? For  the 1979 -- 2019 period. 
 
```{r o3-regr, fig.cap = "(ref:o3-regr-cap)", fig.height=3, fig.width = width_column}
o3_regr %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(PC, term)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..),
                    breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour2(data = periodic(o3_mean, lon = c(0, 360)),
                aes(z = toc_z, linetype = factor(-sign(..level..))), 
                breaks = AnchorBreaks(0, exclude = 0), 
                bins = 5) +
  geom_contour_tanaka(aes(z = estimate), breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_pval(aes(z = p.value)) +
  
  geom_qmap(~.x[lat <= -20]) +
  scale_fill_divergent_discretised("Total Ozone Column", 
                                   guide = guide_colorsteps_bottom(15)) + 
  scale_x_longitude() +
  scale_y_latitude() +
  scale_linetype(guide = "none") +
  coord_polar() +
  facet_grid(PC~term) +
  axis_labs_smol +
  tag_facets("panel")

```

Figure\ \@ref(fig:o3-regr) shows regression maps of EOF1 with fields of Total Ozone Column (TOC). It shows zonal wave 1 pattens in TOC associated with both phases of EOF1. Climatologically, the springtime Ozone minimum is located off the South Pole and towards the Weddell Sea [@wirth1993]. Thus, the Real EOF1 regression pattern (Figure\ \@ref(fig:o3-regr)a) coincides with the climatological position of the ozone hole while the one for the Imaginary EOF1 is shifted by 90º.



(ref:wave1-o3-cap) Relationship between EOF1 amplitude and phase with amplitude and phase of the zonal wave 1 in Total Ozone Column averaged between `r knitr::combine_words(LatLabel(o3wave_lats))` for the period 1979 -- 2019. 

```{r wave1-o3, fig.cap = "(ref:wave1-o3-cap)", fig.width=width_column, fig.height=width_column*.7}
wave1_o3 <- o3 %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(toc = mean(toc, na.rm = TRUE)), by = .(time, lon)] %>% 
  .[, FitWave(toc, 1), by = .(time)] 

temp <- ceof$eof[[1]]$left %>% 
  .[PC == "PC1"] %>% 
  .[wave1_o3, on = "time"]
  
# temp %>% 
#   copy() %>% 
#   na.omit() %>% 
#   sep_ReIm() %>% 
#   .[, hgt := scale(hgt), by  = .(part)] %>% 
#   ggplot(aes(amplitude, hgt)) +
#   geom_point() +
#   geom_smooth(method = "lm", color = "black") +
#   facet_grid(PC ~ part) +
#   panel_background
# temp %>% 
#   .[, correlate(amplitude, Mod(hgt))]
# 
# temp %>% 
#   .[, correlate(phase, Arg(hgt))]


correlation_statistics <- function(x, n, signif = 2) {
  z <- atanh(x)
  se <- 1/sqrt(n - 3)
  
  low <- qnorm(.025, mean = z, sd = se)
  low <- tanh(low)
  hig <- qnorm(.975, mean = z, sd = se)
  hig <- tanh(hig)
  
  p.value <- pnorm(abs(x)/se, lower.tail = FALSE)
  
  text <- paste0(signif(x, signif), " (CI: ",
                 signif(low, signif), " -- ", signif(hig, signif), ")")
  
  list(estimate = x, 
       p.value = p.value, 
       low = low,
       hig = hig,
       text = text
  )
}


wave_correlation <- temp %>% 
  na.omit() %>% 
  .[, .(cor = mean(cos(phase - Arg(hgt))),
        n = .N)] %>% 
  .[, correlation_statistics(cor, n)]

temp %>% 
  ggplot(aes(Mod(hgt), amplitude)) +
  scale_x_continuous("EOF1 Amplitude") +
  scale_y_continuous("O3 Wave-1\nAmplitude") +
  
temp %>% 
  copy() %>%
  na.omit() %>% 
  qwrap(phase = c(0, 2*pi) ~ c(-pi, pi)) %>% 
  ggplot(aes(Arg(hgt), phase)) +
  scale_x_continuous("EOF1 Phase",
                     breaks = seq(-pi, pi, by = 15*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  scale_y_continuous("O3 Wave-1\nPhase",
                     breaks = seq(-pi, pi, by = 30*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º"))  +
  plot_layout(ncol  = 1) &
  geom_point()  &
  geom_smooth(method = "lm") 


```

Indeed, Figure\ \@ref(fig:wave1-o3) shows the relationship between amplitude and phase of the planetary wave 1 in Total Ozone Column between 70ºS and 45ºS \textcolor{red}{(Habría que justifica mejor estas elecciones de bandas latitudinales a paritr del gráfico anterior)} and amplitude and phase of the EOF1. The correlation between the zonal wave 1 of ozone and EOF1 (computed as the mean cosine of the difference in phase) is `r wave_correlation$text`. As expected from the location of anomalies in Figure\ \@ref(fig:wave1-o3), the Real EOF1 drives the relationship with amplitude and the Imaginary EOF1 drives the relationship with phase (not shown). 


### PSA 

We will show that the EOF2 offers an alternative way of representing the PSA which has several advantages over using the second and third principal components. \textcolor{red}{(Esto queda raro porque estas adelantando la conclusión)}

(ref:psa-eof2-cap) Relationship between the Real and Imaginary parts of EOF2 and the PSA1 and PSA2 modes computed as the second and third EOFs of seasonal geopotential height anomalies [@mo2001]. For the period 1979 -- 2019.

```{r psa-eof2, fig.cap = "(ref:psa-eof2-cap)", fig.width=7, fig.height=3, fig.env="figure*"}
pc2 <- ceof$eof[[1]]$left[PC == "PC2"] %>% 
  copy() %>% 
  .[, PC := NULL] %>% 
  .[]

psa2 <- psa$left[PC == "PSA2"][season(time) == "SON"]

rotations_psa <- lapply(angles, function(a) {
  pc2 %>% 
    copy() %>% 
    .[, hgt := rotate(hgt, a)] %>% 
    .[psa2, on = "time"] %>% 
    .[, cor(value, Re(hgt))] 
}) 

psa_angle <- angles[which.min(unlist(rotations_psa))]

pc2[psa_time, on = "time"] %>% 
  .[PC != "SAM"] %>% 
  copy() %>% 
  # .[, hgt := rotate(hgt, psa_angle)] %>%
  sep_ReIm() %>% 
  ggplot(aes(value, hgt)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_smooth(method = "lm") + 
  scale_y_continuous("EOF2") +
  scale_x_continuous("PSA") +
  facet_grid(part ~ PC) +
  panel_background +
  tag_facets("rc")

```

The relationship between PSAs and the modes described from the cEOFs is also studied. Figure\ \@ref(fig:psa-eof2) shows the relationship between the two PSA indices and the Real and Imaginary phase of EOF2. As anticipated by Figure\ \@ref(fig:eof2-regr-gh), there is a strong correlation between PSA1 and Imaginary EOF2 (Figure\ \@ref(fig:psa-eof2)b.1), and between PSA2 and Real EOF2 (Figure\ \@ref(fig:psa-eof2)a.2). Conversely, there is no relationship between PSA1 and Real EOF2, and between PSA2 and Imaginary EOF2 (Figure\ \@ref(fig:psa-eof2) panels a.1 and b.2). So not only this EOF2 represents well both the spatial structure and temporal evolution of the PSA modes, but it's also possible to make a rather clean association between its two phases and the two PSA modes. 

This particular rotation of EOF2 is the one which maximises the relationship between ENSO and Imaginary EOF2. It is also the same that maximises this clean association between EFO2 parts and PSA modes. 

\textcolor{red}{(Lo del histograma habría que explicarlo con un pocoo más detalle porque no es tan trivial. Primero decir para qué se hace, qué se hace exactamente y después recien decir cuál es el resultado y qué información aporta)} 

The reason that the EOF analysis arrives to this optimal separation is that the imaginary cEOF is the most common phase (Figure\ \@ref(fig:phase-histogram)), so it naturally appears first when performing a Principal Component Analysis. 


(ref:phase-histogram-cap) Histogram showing phase distribution of EOF2 for the period 1979 -- 2019. \textcolor{red}{(También ampliar)} 

```{r phase-histogram, fig.cap = "(ref:phase-histogram-cap)", fig.width=width_column*.8, fig.height=2.5}
cut(ceof$eof[[1]], 2)$left %>% 
  .[, arg := Arg(hgt)] %>% 
  .[, w := Mod(hgt)/sum(Mod(hgt))] %>% 
  qwrap(arg = c(-pi, pi) ~  c(-pi - 1/4*pi, pi - 1/4*pi)) %>% 
  ggplot(aes(arg)) +
  geom_histogram(binwidth = 90*pi/180, center = 0, color = "black", fill = "gray70") +
  annotate("text",
           label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary"),
           color = "black", size = 3,
           y = 0.5, x = c(-pi, -pi/2, 0, pi/2), angle = 90, hjust = 0) +
  geom_rug() +
  scale_y_continuous("Number of years") +
  scale_x_continuous("Phase",
                     breaks = seq(-pi - 1/4*pi, pi - 1/4*pi, by = 90*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) 
```

By aligning he imaginary phase with the direction with maximum relationship with ENSO, we also aligned it with the phase of maximum occurrence of XXX. This is analogous to the method of @irving2016, who used reprojection and Fourier filtering to detect "PSA-like" variability and defined as the proper PSA using the peaks of the phase distribution (Compare our Figure\ \@ref:(phase-histogram) with their Figure 6). \textcolor{red}{(Amplia un poco la oración anterior que no queda del todo clara)} The advantage of our method is that it is much simpler to implement, it provides magnitude and phase naturally, and it facilitates the description of this mode as a propagating wave instead of as standing oscillation. As a consequence, the cEOF2 offers an alternative way of representing the PSA which has several advantages over using the second and third EOFs.

### SAM

(ref:sam-eof-vertical-cap) Coefficient of determination between the real and imaginary part of each EOF and the SAM, Asymmetric SAM (A-SAM) and Symmetric SAM (S-SAM) indices computed at each level according to @campitelli2021. Points mark estimates with p-value < 0.01 corrected for False Detection Rate [@benjamini1995].

```{r sam-eof-vertical, fig.cap = "(ref:sam-eof-vertical-cap)", fig.height=4, fig.width=width_column}
time <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(PC, part)]

sam_r2 <- sams %>%
  .[time, on = .NATURAL, allow.cartesian = TRUE] %>%
  .[, correlate(hgt, estimate), by = .(lev, term, part, PC)]


max_r2 <- sam_r2[part == "Imaginary" & term == "asym"] %>% 
  .[, .SD[which.max(estimate^2)], by = .(PC)]

sam_r2 %>%
  ggplot(aes(lev, estimate^2)) +
  geom_vline(xintercept = c(50, 200),  size = 0.2, color = "gray50") +
  geom_point(data = ~.x[p.adjust(p.value, "fdr") < 0.01], aes(color = term)) +
  geom_line(aes(color = term, size = term)) +
  scale_x_level() +
  scale_y_continuous(r2, limits = c(0, 1)) +
  scale_size_manual(guide = "none",
                    values = c(full = 1.2,
                               asym = 0.5,
                               sym = 0.5)) +
  scale_color_brewer(NULL, palette = "Dark2", labels = c(full = "SAM",
                                                         asym = "A-SAM",
                                                         sym = "S-SAM")) +
  facet_grid(part ~ PC, labeller = labeller(PC = c(PC1 = "EOF1", PC2 = "EOF2"))) +
  coord_flip() +
  tag_facets("rc") +
  panel_background
```

To explore the relationship between SAM and the modes described from the cEOF, it is computed the coefficient of determination between the cEOFs timeseries and the three SAM indices (SAM, A-SAM and S-SAM) at each level (Fig.\ \@ref(fig:sam-eof-vertical)). Both cEOFs bear some modest relationship with the full SAM index (thick green line in Figure\ \@ref(fig:sam-eof-vertical)), although not statistically significant at every level. 


 \textcolor{red}{(Esta explicación habría que hacerla más detallada. Explicar más sobre lo que se ve en cada panel y después ir interpretando.  )}
The split between A-SAM and S-SAM gives more insight into the nature of the relationship. The relationship between the SAM and ¿the imaginary EOF1? (Figure\ \@ref(fig:sam-eof-vertical).b1) is mediated by S-SAM in the troposphere, but by the A-SAM in the stratosphere.

The Imaginary EOF2 is related with the SAM through the A-SAM in the troposphere, with up to \textcolor{red}{(Acá aparece un -)} `r scales::percent(max_r2[PC == "PC2"]$estimate, 2)` of shared variance, reached at `r max_r2[PC == "PC2"]$lev` hPa (Figure\ \@ref(fig:sam-eof-vertical).b2). 

```{r eof-filtered, fig.cap = "Spatial pattern of the leading EOF of 200 hPa geopotential height with the variability of EOF2 filtered out South of 20º. Arbitrary units.", fig.width=2.5, fig.height=2.5}
eof_filtered <- era5 %>% 
  .[sep_ReIm(pc2, format = "wide")[, hgt := NULL], on = .NATURAL] %>% 
  .[lev == 200] %>% 
  .[lat <= -20] %>% 
  .[season(time) == "SON"] %>% 
  .[, hgt := resid(.lm.fit(cbind(1, Real, Imaginary), hgt)), .(lon, lat, lev, season(time))] %>%
  .[, eof := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(lon, lat, lev, season(time))] %>% 
  EOF(eof ~ lon + lat | time, n = 1, data = .) 


eof_filtered_cor <- eof_filtered$right[sams, on = "time"] %>% 
  .[lev == 200] %>% 
  .[, correlate(estimate, eof), by = term]

eof_filtered %>% 
  .$left %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = eof), breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = eof), breaks = AnchorBreaks(0, exclude = 0)) +
  scale_fill_divergent(guide = "none") +
  geom_qmap(~.x[lat <= -20]) +  
  scale_x_longitude() +
  scale_y_latitude() +
  coord_polar() +
  theme(axis.text = element_blank())
```

\textcolor{red}{(La discusión de los próximos parráfos me resulta confusa. Deberías aclarar mejor por qué mostras cada cosa que mostras y cómo se relaciona con lo que mostraste antes. También me resulta como un resultado que se va un poco de tema, por eso creo que debería estar mejor contada esta parte para poder incluirla)}

As a further illustration \textcolor{red}{(¿De qué?)}, Figure\ \@ref(fig:eof-filtered) shows the spatial pattern of the leading EOF of 200 hPa geopotential height when the variability associated with EOF2 is removed. The resulting pattern is an nearly zonally symmetrical annular mode. This mode is highly correlated with SAM (`r eof_filtered_cor[term == "full"]$text`), but only with the symmetrical part (`r eof_filtered_cor[term == "sym"]$text`). Note that the usual definition of the PSA modes as the second and third EOFs creates modes orthogonal to the SAM (defined as the first EOF) and thus impedes this kind of filtering.  

(ref:fake-eof-cap) EOFs of a synthetic data set of 41 times steps of geopotential height fields as the sum of the fields predicted by the EOF2 plus perfectly zonally symmetric SAM-like anomalies with random amplitude.

```{r fake_eof}
pattern <- eof_filtered$right %>% 
  .[era5[lev == 200], on = "time"] %>% 
  .[, FitLm(hgt, eof), by = .(lon, lat)] %>% 
  .[, estimate := mean(estimate), by = .(lat, term)] %>%
  dcast(lon + lat ~ term, value.var = "estimate")


set.seed(42)
fake_sam <- eof_filtered$right %>% 
  copy() %>% 
  .[, eof := sample(eof, replace = TRUE)]  %>%
  setnames("eof", "value") %>% 
  .[, pattern[, .(sam = value*eof), by = .(lon, lat)], by = time]

# fake_sam %>% 
#   .[time %in% unique(time)[1:4]] %>% 
#   ggplot(aes(lon, lat)) +
#   geom_contour_fill(aes(z = sam)) +
#   facet_wrap(~factor(time)) +
#   coord_polar()


fake_eof <- era5 %>% 
  .[sep_ReIm(pc2, format = "wide")[, hgt := NULL], on = .NATURAL] %>% 
  .[lev == 200] %>% 
  .[lat <= -20] %>% 
  .[season(time) == "SON"] %>% 
  .[, hgt := hgt - .lm.fit(cbind(1, Imaginary, Real), hgt)$residuals, .(lon, lat, lev, season(time))] %>% 
  .[, hgt := Anomaly(hgt), by = .(lat)] %>% 
  fake_sam[., on = .NATURAL] %>% 
  .[, hgt := hgt + sam] %>% 
  .[, eof := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(lon, lat, season(time))] %>% 
  EOF(eof ~ lon + lat | time, n = 1:3, data = .)  
```

```{r fake-eof, fig.cap = "(ref:fake-eof-cap)", fig.width=3.7, fig.height=1.7}
# era5 %>% 
#   .[sep_ReIm(pc2, format = "wide")[, hgt := NULL], on = .NATURAL] %>% 
#   .[lev == 200] %>% 
#   .[lat <= -20] %>% 
#   .[season(time) == "SON"] %>% 
#   .[, FitLm(hgt, Real, Imaginary), .(lon, lat)] %>% 
#   rm_intercept() %>% 
#   .[, .(lon, lat, eof = estimate, PC = term)] %>% 
#   rbind(pattern[, .(lon, lat, eof, PC = "SAM")]) %>% 
#   .[, PC := factor(PC, levels = c("SAM", "Imaginary", "Real"), ordered = TRUE)] %>% 
#   periodic(lon = c(0, 360)) %>% 
#   ggplot(aes(lon, lat)) +
#   geom_contour_fill(aes(z = eof), global.breaks = FALSE, breaks = AnchorBreaks(0, exclude = 0)) +
#   geom_contour_tanaka(aes(z = eof), global.breaks = FALSE,  breaks = AnchorBreaks(0, exclude = 0)) +
#   scale_fill_divergent(guide = "none") +
#   geom_qmap(~.x[lat <= -20]) +  
#   scale_x_longitude() +
#   scale_y_latitude() +
#   coord_polar() +
#   facet_wrap(~PC) +
#   axis_labs_smol +


fake_eof %>% 
  .$left %>% 
  copy() %>% 
  .[lat <= -20] %>% 
  # .[, eof := Anomaly(eof), by = .(lat, PC)] %>%
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = eof), global.breaks = FALSE, breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = eof), global.breaks = FALSE,  breaks = AnchorBreaks(0, exclude = 0)) +
  scale_fill_divergent(guide = "none") +
  geom_qmap(~.x[lat <= -20]) +  
  scale_x_longitude() +
  scale_y_latitude() +
  coord_polar() +
  facet_wrap(~PC) +
  theme(axis.text = element_blank())
```

This suggests that the asymmetric part of the SAM might be statistical contamination from one phase of the PSA. Figure\ \@ref(fig:fake-eof) serves as an illustration of this kind of statistical mixing of independent modes. If shows the leading (and only) EOFs of a synthetic dataset if `r uniqueN(fake_sam$time)` years created by adding a perfectly zonally symmetrical SAM-like pattern with random amplitudes taken from the real SAM, and geopotential height anomalies predicted by EFO2. Even though by construction this dataset has a perfectly symmetric SAM, the EOF decomposition mixes this mode with parts of the the zonally asymmetric EOF2 pattern, resulting in a pattern eerily similar to the real SAM pattern. 

This suggests that the zonal asymmetries of the SAM could very well be mostly a statistical artifact. Since many surface impacts are mediated by the asymmetric component, as well as the relationship between SAM and ENSO [@campitelli2021], this potential issue could affect the interpretability of many results involving the SAM. Studies on the relationship between the SAM and the PSA pattern would be particularly difficult to interpret. 

## Tropical sources

```{r regr_psi}
regr_psi <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), by = .(season, PC)] %>%
  .[psi, on = "time", allow.cartesian = TRUE] %>%
  .[season(time) == "SON"] %>%
  .[, FitLm(psi.z, Real, Imaginary, se = TRUE),by = .(lon, lat, lev, PC, season)] %>%
  rm_intercept() %>%
  .[, psi.z := Anomaly(estimate), by = .(PC, season, lev, lat)] %>%
  .[, c("fx", "fy") := shceof::WaveFlux(.SD, p = 200), by = .(lev, PC, season, term)] %>%
  .[, term := factor_ReIm(term)]
```

```{r sst}
sst <- ERA5_SST() %>%
  ReadNetCDF(vars = c("t" = "sst")) %>%
  normalise_coords() %>%
  .[season(time) == "SON"] %>%
  .[, .(t = mean(t)), by = .(lon, lat, time = seasonally(time))]
```

```{r regr_sst}
regr_sst <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), by = .(season, PC)] %>%
  .[sst, on = "time", allow.cartesian = TRUE] %>%
  .[season(time) == "SON"] %>%
  .[, FitLm(t, Imaginary, Real, se = TRUE), by = .(lon, lat, PC, season)] %>%
  rm_intercept() %>%
  .[, term := factor_ReIm(term)]
```

```{r enso_cor}
enso_cor <-  ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(PC, part)] %>%
  enso[., on = "time"] %>%
  na.omit() %>%
  .[, correlate(hgt, oni), by = .(PC, part)]
```

```{r plot_sst_psi}
plot_sst_psi <- function(which_pc, which_lev) {
  sst_gdata <- regr_sst[PC == which_pc] %>%
    .[lat %between% c(-90, 10)] %>%
    .[, p_val := Pvaluate(estimate, std.error, df, "fdr"), by = .(PC, term)] %>%
    .[, var := "SST"]
  
  regr_psi %>%
    .[PC == which_pc] %>%
    .[lev == which_lev] %>%
    # .[abs(estimate) > 1, estimate := NA] %>%
    .[lat %between% c(-90, 10)] %>%
    .[, p_val := Pvaluate(estimate, std.error, df, "fdr"), by = .(PC, term)] %>%
    .[, var := "Streamfunction"] %>%
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate*1e8, fill = ..level..),
                      breaks = AnchorBreaks(exclude = 0)) +
    geom_contour_pval(aes(z = p_val)) +
    geom_streamline(aes(dx = fx, dy = fy), min.L = 3, L = 10, n = 30,
                    size = 0.2, res = 2, nx = 25, ny = 15, 
                    arrow.angle = 14, arrow.length = 0.2) +
    geom_qmap(keep = .015) +
    scale_fill_divergent_discretised("Streamfunction", guide = "none") +
    ggnewscale::new_scale_fill() +
    
    geom_contour_fill(data = sst_gdata,
                      aes(z = estimate, fill = ..level..), breaks = AnchorBreaks(exclude = 0)) +
    geom_contour_pval(data = sst_gdata, aes(z = p_val)) +
    scale_fill_divergent_discretised("SST", guide = guide_colorsteps_bottom(order = 2)) +
    scale_x_longitude() +
    scale_y_latitude() +
    scale_mag(guide = "none") +
    facet_grid(term ~ var, labeller = labeller(PC = c(PC1 = "EOF1", PC2 = "EOF2"))) +
    coord_quickmap(ylim = c(NA, 10)) +
    theme(legend.box = "horizontal") +
    # ggh4x::facet_nested(term ~ PC) +
    axis_labs_smol +
    tag_facets("cr", position = "bl")
}
```

(ref:sst-psi-2-cap) Regression maps of EOF2 with SST (column a) and streamfunction zonal anomalies with their corresponding activity wave flux (column b). Areas marked with dots have p-values smaller than 0.05 adjusted for FDR.

```{r sst-psi-2,  fig.cap = "(ref:sst-psi-2-cap)", fig.width = 7, fig.height=4, dependson="plot_sst_psi", fig.env="figure*"}
plot_sst_psi(which_pc = "PC2", which_lev = 200)
```


Figure\ \@ref(fig:sst-psi-2) shows regression maps between EOF2 and Sea Surface Temperatures (SST) Streamfunction at 200 hPa. The Imaginary EOF2 is associated with strong positive SST anomalies on the Central Pacific and negative anomalies on an area across the North of Australia and New Zealand, the South Pacific Convergence Zone (SPCZ) (Figure\ \@ref(fig:sst-psi-2).a2). This pattern is almost canonically positive ENSO and indeed, the correlation between the Imaginary EOF2 and the Oceanic Niño Index [@bamston1997] is very high `r enso_cor[PC == "PC2" & part == "Imaginary"]$text`. Streamfunction anomalies show a coherent picture. The Imaginary EOF2 is associated with strong wave-like streamfunction anomalies emanating from the tropics (Figure\ \@ref(fig:sst-psi-2).b2). This is consistent with what we know of the effect of ENSO on the extratropics: SST anomalies initiate anomalous convection that excites Rossby waves that propagate meridionally towards higher latitudes \textcolor{red}{(REFS??)}.


Since the Real EOF2 represents just a different phase of the same wave train, one would expect that it would show a similar forcing pattern to the Imaginary EOF with a slight translation of its location. However, Figure\ \@ref(fig:sst-psi-2).a1 and b1 show that the Real EOF2 is not associated either with any significant SST nor streamfunction anomalies in the tropics. The correlation between the Real EOF2 and ENSO is also not significant (`r enso_cor[PC == "PC2" & part == "Real"]$cor_text`) \textcolor{red}{(No aparece el valor en el PDF)}. This lack of tropical signal suggests different natures of the different phases of the EOF2 wave train.

```{r enso-phase, fig.cap = "Relationship between ENSO and phase of EOF2 for the period 1979 -- 2019. Colours denote years with magnitude of EOF2 greater or smaller than the 50th percentile. Black line is the fit ONI ~ cos(phase) + sin(phase) computed by OLS weighted by the magnitude of EOF2.", fig.width = width_column, fig.height=3}
gdata <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[PC == "PC2"] %>% 
  # .[, hgt := Anomaly(hgt)] %>% 
  .[, arg := Arg(hgt)] %>%
  .[, mag := Mod(hgt)] %>%
  .[enso, on = "time"] %>%
  na.omit()
  


cor_enso_mag <- gdata[, correlate(mag, abs(oni))]

cor_enso_spearman <- gdata[, cor.test(mag, abs(oni), method = "spearman")]

cor_enso_mag_outlier <- gdata[oni < 1.5][, correlate(mag, abs(oni))]


cos_model <- gdata %>% 
  .[, lm(oni ~ I(sin(arg)) - 1, weights = mag )]



gdata %>% 
  ggplot(aes(arg, oni)) +
  geom_hline(yintercept = c(-0.5, 0, 0.5), size = 0.2, color = "gray50") +
  geom_vline(xintercept = 0, size = 0.2, color = "gray50") +
   annotate(shadowtext:::GeomShadowText,
           label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary", "+ Real"),
           color = "gray60", bg.colour = "white", bg.r = 0.2,
           size = 3,
           y = -Inf, x = c(-pi, -pi/2, 0, pi/2, pi), angle = 90, hjust = 0) +
  
  geom_smooth(data = ~qwrap(.x, arg = c(-pi, pi) ~ c(-2*pi, 2*pi)),
              method = "lm", aes(weight = mag),
              formula = y ~ I(sin(x)) -1,
              se = FALSE, color = "black", size = 0.5) +
  geom_point(aes(colour = mag >= quantile(mag, 0.5),
                 shape  = mag >= quantile(mag, 0.5)),
             size = 3) +

  scale_color_brewer(NULL, palette = "Dark2",
                     labels = c("TRUE"  = "|EOF2| > 50%",
                                "FALSE" = "|EOF2| < 50%")) +
  scale_shape_manual(NULL, values = c("TRUE" = 20,
                                      "FALSE" = 18),
                     labels = c("TRUE"  = "|EOF2| > 50%",
                                "FALSE" = "|EOF2| < 50%")) +
  scale_y_continuous("ONI") +
  scale_x_continuous("Phase",
                     breaks = seq(-pi, pi, by = 45*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  coord_cartesian(xlim = c(-pi, pi)) +
  panel_background
```

To better explore the relationship between tropical forcing and phase of the cEOF2, Figure\ \@ref(fig:enso-phase) plots the ONI index and the phase of the EOF2 for each SON trimester between 1979 and 2019, highlighting years in which the magnitude of EOF2 is above the median. In years with positive ONI, the phase of the EOF2 is mostly around +90º (corresponding with positive imaginary part) and vice versa. In years with near neutral ENSO, the phase of the EOF2 is much more variable. The black line in Figure\ \@ref(fig:enso-phase) is an harmonical fit of the relationship between ONI and cEOF2 phase. The $r^2$ corresponding to the fit is `r signif(summary(cos_model)$r.squared, 2)`, with p-value `r report_p(coef(summary(cos_model))[4])`, indicating a quasi-sinusoidal relation between these two variables.

Furthemore, Figure\ \@ref(fig:enso-phase) suggest that strong EOF2 years tend to coincide with strong ENSO years. The correlation between the absolute magnitude of the ONI and the magnitude of the EOF2 is `r cor_enso_mag$text`. This relationship, however, appears to be driven only by the three years with strongest ENSO events in the period (`r knitr::combine_words(year(gdata[order(-oni)][1:3]$time))`) which also coincide with the three years with strongest EOF2 magnitude. If those years are removed, the correlation becomes non-significant (`r cor_enso_mag_outlier$text`). Furthermore, even when using all the datapoints, the Spearman correlation --which is robust to outliers-- is also non-significant (`r signif(cor_enso_spearman$estimate, 2)`, p-value`r report_p(cor_enso_spearman$p.value)`). Therefore, the relationship between the magnitude of the cEOF2 train wave and ONI remains uncertain.

It could be concluded that the wave train represented by cEOF2 can be both part of the internal variability of the extratropical atmosphere or forced by tropical SSTs. In the former case, the wave train has little phase preference. However, when cEOF2 is excited by tropical SST variability, it tends to remain locked to the imaginary phase. This explains the relative overabundance of years with EOF2 near positive and negative imaginary phase in Figure\ \@ref(fig:phase-histogram). 

(ref:sst-psi-1-cap) Same as Figure\ \@ref(fig:sst-psi-2) but for EOF1.

```{r sst-psi-1, fig.cap = "(ref:sst-psi-1-cap)", fig.width = 7, fig.height=4, dependson="plot_sst_psi", fig.env = "figure*"}
plot_sst_psi(which_pc = "PC1", which_lev = 200)
```

Figure\ \@ref(fig:sst-psi-1) shows SST and streamfunction regression maps for EOF1. There is no significant pattern of SST anomalies associated with either the Real or Imaginary EOF1. Consistently, streamfunction anomalies do not show any tropical influence. Instead of that, the real and imaginary CEOF1 are associated with zonally wave activity fluxes in the extra-tropics, except for an equatorward flow from the coast of Antarctica around 150ºE in the real component.

## Precipitation

```{r cmap}
cmap <- ReadNetCDF(CMAP(), vars = c(pp = "precip"),
                   subset = list(lat = -90:10)) %>%
  normalise_coords() %>%
  .[, .(pp = mean(pp, na.rm = TRUE)), by = .(lon, lat, time = seasonally(time))]
```

```{r regr_pp}
regr_pp <- ceof[, eof[[1]]$left, by = season] %>%
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), by = .(season, PC)] %>%
  .[melt(cmap, id.vars = c("lon", "lat", "time")), on = "time", allow.cartesian = TRUE] %>%
  .[season == "SON"] %>%
  .[, FitLm(value, Imaginary, Real, se = TRUE), by = .(lon, lat, PC, variable, season)] %>%
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)]
```

```{r add_continents}
continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -13)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))

add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon &
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon &
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>%
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>%
    .[]
}
```

```{r plot_pp}
plot_pp <- function(data, which_pc, which_term = c("Real", "Imaginary"), which_continent = NULL) {
  filter_continent <- function(data) {
    if (!is.null(which_continent)) {
      data[continent == which_continent]
    } else {
      data
    }
    
  }
  data %>%
    .[PC %in% which_pc] %>%
    .[term %in% which_term] %>%
    .[, lev := "sfc"] %>%
    .[lat >= -60] %>%
    add_continent() %>%
    filter_continent() %>%
    # .[abs(estimate) <= 2] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "none"), by = .(lev, PC, term)] %>%
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    # geom_raster(aes(fill = estimate)) +
    geom_contour_fill(aes(z = estimate, fill = ..level..), 
                      breaks = AnchorBreaks(exclude = 0)) +
    geom_contour_tanaka(aes(z = estimate), breaks = AnchorBreaks(exclude = 0)) +
    
    # scale_fill_divergent() +
    scale_fill_divergent_discretised(NULL, 
                         # limits = c(-.8, .8),
                         # oob = scales::squish,
                         low = "#8E521C",
                         high = "#00665E",
                         guide = guide_colorsteps_bottom(15)) +
    # scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(15)) +
    geom_contour_pval(aes(z = p.value)) +
    geom_qmap(~.x %>% .[lat %between% c(-60, max(data$lat))] %>% add_continent() %>% filter_continent(),
              keep = 1) +
    
    scale_x_longitude(ticks = 15) +
    scale_y_latitude(ticks = 15) +
    ggh4x::facet_nested(term ~ PC) +
    axis_labs_smol +
    tag_facets("cr") +
    coord_quickmap()
}
```

```{r sesa}
sesa <- list(lon = c(300, 315),
             lat = c(-35, -22))
```

(ref:pp-america-cap) Regression of SON mean precipitation anomalies in South America (mm per day, shaded) and (column a) EOF1 the (row 1) Imaginary and (column 1) Real phase. For the 1979 -- 2018 period. Black contours with dots indicate areas with p-value smaller than 0.05 controlling for False Detection Rate.


```{r pp-america, fig.cap = "(ref:pp-america-cap)", fig.width=width_column, fig.height=width_column*1.1}
plot_pp(data = regr_pp, which_pc = c("PC1", "PC2"), which_continent = "america") 
  # annotate("rect", xmin = min(sesa$lon), xmax = max(sesa$lon), 
  #          ymin = min(sesa$lat), ymax = max(sesa$lat),
  #          fill = NA, color = "gray50", size = 0.3)
  #          
```

The influence of cEOFs variability in continental rainfall of extra-tropical Southern Hemisphere is also explored. We focus on South America and Oceania sectors, because there are not relevant signals in Southern Africa (not shown). 

Figure\ \@ref(fig:pp-america) shows regression maps of seasonal precipitation with each cEOF in South America. cEOF1 is associated with slight decreases in precipitation in Southern Brazil and Paraguay, although these are not statistically significant \@ref(fig:pp-america) column a. The strongest precipitation anomalies are the ones associated with the Imaginary EOF2. The positive anomalies on Southeastern South America (SESA) and Central Chile, and negative anomalies over South Atlantic Convergence Zone is a well known springtime precipitation signature of ENSO [@cai2020a] and it is also similar to the precipitation anomalies associated with the A-SAM [@campitelli2021]. This is not surprising considering the close relationship between the ONI, the Asymmetric SAM index and the Imaginary cEOF2 shown previously, but further consolidates the identification of this mode with the PSA pattern. The Real cEOF2, on the other hand, is associated with negative precipitation anomalies in a smaller area of SESA. There is a phase dependence of the precipitation anomalies in SESA (not shown), which resembles the relationship between ONI and the phase of EOF2. \textcolor{red}{(Podrías agregar acá el coeficiente de determinación)}

  (ref:pp-oceania-cap) As Figure\ \@ref(fig:pp-america) but for Oceania.

```{r box_australia}
box_australia <- data.frame(PC = "PC2", 
                            lon = c(130, 155),
                            lat = c(-40, -15))
```

```{r pp-oceania, fig.cap = "(ref:pp-oceania-cap)", fig.width=width_column, fig.height=width_column*.8}
plot_pp(regr_pp, c("PC1", "PC2"), which_continent =  "oceania") +
  geom_rect(data = box_australia, aes(xmin = min(lon), xmax = max(lon),
                                      ymin = min(lat), ymax = max(lat)),
            fill = NA, colour = "gray20") 
```

The precipitation anomalies in Oceania associated with EOF1 are also weak and not statistically significant (Figure\ \@ref(fig:pp-oceania) column a) whereas EFO2 is associated with large and expansive anomalies. The Real cEOF2 is associated with positive seasonal anomalies in Northern and Eastern Australia, and negative ones over New Zealand, while precipitation anomalies associated with Imaginary EOF2 are negative over all Eastern Australia. Again, these negative anomalies are similar to the springtime precipitation anomalies observed in relation with the Asymmetric SAM [@campitelli2021]. 
\textcolor{red}{(Habría que agregar alguna referencia del ENSO que es más conocido)}

(ref:australia-pp-phase-cap) Same as Figure\ \@ref(fig:enso-phase) but for precipitacion anomalies averaged between  `r knitr::combine_words(LonLabel(box_australia$lon))` and `r knitr::combine_words(LatLabel(box_australia$lat))` (box shown in Figure\ \@ref(fig:pp-oceania) column b).

```{r australia-pp-phase, fig.cap = "(ref:australia-pp-phase-cap)", fig.width = width_column, fig.height=3}
gdata <- cmap %>% 
  .[lon %between% box_australia$lon  & lat %between% box_australia$lat] %>% 
  .[, .(pp = weighted.mean(pp, cos(lat*pi/180))), by = time] %>% 
  .[, pp := Anomaly(pp), by = season(time)] %>% 
  .[ceof$eof[[1]]$left, on  = "time"] %>% 
  .[PC == "PC2"] %>% 
  .[, arg := Arg(hgt)] %>% 
  .[, mag := Mod(hgt)]

model <- lm(pp ~ I(sin(arg)) + I(cos(arg)) - 1, data = gdata)
fstatistic <- summary(model)$fstatistic
p_value <- pf(fstatistic["value"], fstatistic["numdf"], fstatistic["dendf"], 
        lower.tail = FALSE)

gdata %>% 
  ggplot(aes(Arg(hgt), pp)) +
  geom_hline(yintercept = 0, size = 0.2, color = "gray50") +
  geom_vline(xintercept = 0, size = 0.2, color = "gray50") +
  annotate(shadowtext:::GeomShadowText,
           label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary", "+ Real"),
           color = "gray60", bg.colour = "white", bg.r = 0.2,
           size = 3,
           y = -Inf, x = c(-pi, -pi/2, 0, pi/2, pi), angle = 90, hjust = 0) +
  
  geom_smooth(data = ~qwrap(.x, arg = c(-pi, pi) ~ c(-2*pi, 2*pi)),
              method = "lm", aes(weight = mag),
              formula = y ~ I(sin(x)) + I(cos(x)) -1,
              se = FALSE, color = "black", size = 0.5) +
    geom_point(aes(colour = mag >= quantile(mag, 0.5),
                 shape  = mag >= quantile(mag, 0.5)),
             size = 3) +


  scale_color_brewer(NULL, palette = "Dark2",
                     labels = c("TRUE"  = "|EOF2| > 50%",
                                "FALSE" = "|EOF2| < 50%")) +
  scale_shape_manual(NULL, values = c("TRUE" = 20,
                                      "FALSE" = 18),
                     labels = c("TRUE"  = "|EOF2| > 50%",
                                "FALSE" = "|EOF2| < 50%")) +
  scale_y_continuous("Precipitation anomaly") +
  scale_x_continuous("Phase",
                     breaks = seq(-pi, pi, by = 30*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  coord_cartesian(xlim = c(-pi, pi)) +
  panel_background
```

To better understand the relationship between precipitation anomalies over Western Australia and the EOF2, Figure\ \@ref(fig:australia-pp-phase) plots precipitation anomalies averaged over Eastern Australia (box in Figure\ \@ref(fig:pp-oceania)) as a function of EOF2 phase. The black line is the equation $\mathrm{Precipitation} = `r signif(coef(model)[1], 2)`\sin{(\mathrm{phase})} + `r signif(coef(model)[2], 2)`\cos{(\mathrm{phase})}$, whose coefficient we fitted by weighted least squares using the magnitude of the EFO2 as weight. 
\textcolor{red}{(Como te puse antes la ecuación como mucho la pondría sobre la figura)}
The $r^2$ corresponding to the fit is `r signif(summary(model)$r.squared, 2)`, with p-value `r report_p(p_value)`. There is a strong relationship between the phase of the EOF2 and precipitation anomalies in Eastern Australia, but Real and Imaginary phases we chose are not exactly aligned with the direction that maximises this relationship. If one were to perform a more in-depth analysis of the relationship between this pattern and precipitation in this region, one would conceivably align one of the axis (either the Real or the Imaginary) to the one that maximises it. 


(ref:pp-africa-cap) Same as Figure\ \@ref(fig:pp-america) but for South of Africa.

```{r pp-africa, fig.cap = "(ref:pp-africa-cap)"}
# plot_pp(regr_pp, c("PC1", "PC2"), which_continent = "africa")
```


# Conclusions



## Code availability {-}

A version-controlled repository of the code used to create this analysis, including the code used to download the data can be found at https://github.com/eliocamp/shceof.


# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
