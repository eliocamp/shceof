---
title: " Austral Spring Extratropical Southern Hemisphere zonally assymetric circulation"
titlerunning:  Title
authors: 
- name: Elio Campitelli
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos. Buenos Aires, Argentina.  
    CONICET – Universidad de Buenos Aires. Centro de Investigaciones del Mar y la Atmósfera (CIMA). Buenos Aires, Argentina.  
    CNRS – IRD – CONICET – UBA. Instituto Franco-Argentino para el Estudio del Clima y sus Impactos (IRL 3351 IFAECI). Buenos Aires, Argentina.
  email: elio.campitelli@cima.fcen.uba.ar
  
- name:  Leandro B. Díaz
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos. Buenos Aires, Argentina.
    CONICET – Universidad de Buenos Aires. Centro de Investigaciones del Mar y la Atmósfera (CIMA). Buenos Aires, Argentina.
    CNRS – IRD – CONICET – UBA. Instituto Franco-Argentino para el Estudio del Clima y sus Impactos (IRL 3351 IFAECI). Buenos Aires, Argentina.
  
- name:  Carolina Vera
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos. Buenos Aires, Argentina.
    CONICET – Universidad de Buenos Aires. Centro de Investigaciones del Mar y la Atmósfera (CIMA). Buenos Aires, Argentina.
    CNRS – IRD – CONICET – UBA. Instituto Franco-Argentino para el Estudio del Clima y sus Impactos (IRL 3351 IFAECI). Buenos Aires, Argentina.

thanks: | 
  The research was supported by UBACyT20020170100428BA and the CLIMAX Project funded by Belmont Forum/ANR-15-JCL/-0002-01. Elio Campitelli was supported by a PhD grant from CONICET, Argentina.


 
keywords:

abstract: |
  abstract



date: "`r format(Sys.time(), '%d %B, %Y')`"

bibliography: 
  - references.bib
  - data.bib
  - packages.bib

bibstyle: spbasic
# bibstyle options spbasic(default), spphys, spmpsci
output: 
  bookdown::pdf_book: 
      base_format: rticles::springer_article
      latex_engine: "xelatex"
      citation_package: "natbib"
      # pandoc_args: ["--lua-filter=abstract-to-meta.lua"]
header-includes: 
 - \usepackage{gensymb}
 - \usepackage{subfig}
 - \usepackage[inline]{showlabels}
 - \usepackage{chngcntr}
 - \usepackage{natbib}
 - \usepackage{lineno}
 - \linenumbers 
---

<!-- cambiarn nomenclatura. Imaginario / real -> pasarlo a nombrar la fase -->

<!-- Chequear con ncep -->

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  cache = TRUE,
  comment = "#>",
  cache.extra = 42,
  cache.path = "../cache/paper/",
  fig.path = "../figures/",
  dpi = 300,
  dev = c("pdf", "png")
)



# ## Figure classes
# DefineClass <- function(class.opts) {
#     class.name <- deparse(substitute(class.opts))
#     class.fun <- function(options) {
#         class <- options[[class.name]]
#         class <- class.opts[[class]]
#         options[names(class)] <- class
#         options
#     }
#     invisible(knitr::opts_hooks$set(
#         setNames(list(class.fun), class.name)))
# }
# 
# page.width <- 210 - 30 - 25
# text.width <- page.width - 20
# text.height <- page.height <- 297 - 25 - 25
# 
# fig.class <- list(
#   colwidth = list(
#     fig.width = 5
#   ),
#     pagewidth = list(
#         fig.width = page.width/25.4,
#         out.width = paste0(page.width, "mm"),
#         # fig.align = "center",
#         fig.env = "figure*",
#         out.extra = " "
#     )
# )
# 
# DefineClass(fig.class)

width_column <- 3.6


library(metR)
library(data.table)
library(magrittr)
library(ggplot2)
library(tagger)
library(ggperiodic)
library(patchwork)
library(kableExtra)
library(shceof)



theme_set(theme_shceof(base_size = 10))

grid <- theme(panel.grid = element_line(color = "gray10", size = 0.4, linetype = 3))
no_grid <- theme(panel.grid = element_blank())
grid_y <- theme(panel.grid.major.y = element_line(color = "gray60", size = 0.1))

panel_background <- theme(panel.background = element_rect(fill = "#fbfbfb", color = NA), 
                          panel.ontop = FALSE,
                          tagger.panel.tag.background = ggplot2::element_rect(color = NA, 
                                                                              fill = "#fbfbfb"))

guide_colorstrip_bottom <- function(width = 15, height = 0.5, ...) {
  guide_colorstrip(title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}

guide_colorsteps_bottom <- function(width = 15, height = 0.5, even.steps = FALSE, ...) {
  guide_colorsteps(show.limits = TRUE, even.steps = even.steps,
                   title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}

axis_labs_smol <- theme(axis.text = element_text(size = 6))

pattern_dots <- ggplot2::ggproto("GeomDots", ggpattern::GeomPolygonPattern)
ggplot2::update_geom_defaults(pattern_dots, 
                              list(pattern = "circle",
                                   colour = NA,
                                   pattern_colour = "black",
                                   pattern_fill = "black",
                                   pattern_density = 0.05,
                                   pattern_alpha = 1,
                                   fill = NA,
                                   pattern_spacing = 0.025))

update_geom_defaults(GeomSmooth, list(colour = "#0d52bf"))


geom_contour_pval <- function(mapping, p.value = 0.01, size = 0.1, ...) {
  mapping2 <- mapping
  mapping2$fill <- aes(fill = NA)$fill
  list(
    stat_contour_filled(mapping2, breaks = c(0, p.value), fill = NA, geom = pattern_dots, ...),
    geom_contour2(mapping, breaks = p.value, size = size, ...)
  )
}


lab_lev <- AddSuffix(" hPa")
lab_cplx <- c(R = "Real", 
              I = "Imaginary")


combine_lists <- function(...) {
  # browser(expr = length(x) != length(y))
  X <- list(...)
  names <- names(X[[1]])
  names(names) <- names
  lapply(names, function(n) {
    unlist(lapply(X, function(x) x[[n]]))
  })
}
```

```{r read-indices}
enso <- rsoi::download_oni(TRUE, data_path("raw", "oni.csv")) %>%
  as.data.table() %>%
  .[, .(time = lubridate::as_datetime(Date), oni = ONI)] %>%
  na.omit() %>%
  .[season(time) == "SON"] %>%
  .[, oni := oni*season_weights(time)] %>% 
  .[, .(oni = mean(oni)), by = .(time = seasonally(time))]

sams <- readRDS(data_path("derived", "sam.Rds")) %>%
  .[season(time) == "SON"] %>%
  .[, estimate := estimate*season_weights(time)] %>% 
  .[, .(estimate = mean(estimate)),
    by = .(lev, term, time = seasonally(time))]

levs <- unique(sams$lev)

for (l in seq_along(levs)[-1]) {
  cor <- sams[lev %in% levs[seq(l - 1, l)]] %>% 
    .[term == "full"] %>%
    dcast(time ~ lev, value.var = "estimate") %>% 
    setnames(., colnames(.), c("time", "old", "new")) %>% 
    .[, cor(old, new)]
  
  sams[lev == levs[l], estimate := sign(cor)*estimate]
}
```

```{r test-irlba}
has_irlba <- requireNamespace("rilba", quietly = TRUE)
if (has_irlba) {
  stop("If installed, metR::EOF uses irlba, but that package has a bug with complex matrices\n(see: https://github.com/bwlewis/irlba/issues/55). Uninstall irlba with renv::remove(\"irlba\") and try again.")
}

```

```{r read-data}
era5 <- ReadNetCDF(ERA5(), vars = c(hgt = "z",
                                    t = "t"),
                   subset = list(level = list(850, 700, 200, 50),
                                 latitude = -90:10)) %>% 
  normalise_coords() %>% 
  .[season(time) == "SON"] %>%
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w), 
        t = mean(t*w)), by = .(lev, lon, lat, time = seasonally(time))]
```

```{r compute-psi}
psi <- ReadNetCDF(ERA5(), vars = "vo",
                  subset = list(level = c(50, 200),
                                time = c("1979-01-01", "2019-12-01"))) %>%
  normalise_coords() %>%
  .[season(time) == "SON"] %>%
  .[, w := season_weights(time)] %>% 
  .[, .(vo = mean(vo*w)), by = .(lon, lat, lev, time = seasonally(time))] %>%
  .[, solve_poisson(vo, lon, lat), by = .(lev, time)] %>%
  setnames("value", "psi") %>% 
  .[, psi.z := Anomaly(psi), by = .(time, lev, lat)] 
```

```{r o3}
o3 <- O3() %>% 
  ReadNetCDF(vars = c(toc = "tco3")) %>% 
  normalise_coords() %>% 
  .[, lon := ConvertLongitude(lon)] %>% 
  .[lat <= -20] %>% 
  .[, toc := toc/2.1415e-5] %>%    # transform to Dobson Units (https://sacs.aeronomie.be/info/dobson.php)
  .[, w := season_weights(time)] %>% 
  .[, .(toc = mean(toc*w)), by = .(lon, lat, time = seasonally(time))]

o3wave_lats <- c(-75, -45)
```

```{r psa}
psa <- ReadNetCDF(ERA5(), vars = c(hgt = "z"),
                   subset = list(level = list(500),
                                 latitude = -90:0)) %>% 
  normalise_coords() %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lon, lat, time = seasonally(time))] %>% 
  .[, value := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(lon, lat, season(time))] %>%
  EOF(value ~ time | lon + lat, n = 1:3, data = .)

psa <- lapply(psa, function(x) {
  copy(x)[, PC := fcase(PC == "PC1", "SAM", 
                        PC == "PC2", "PSA1", 
                        PC == "PC3", "PSA2")] 
})


psa_time <- psa$left[season(time) == "SON"]
```

# Introduction

\textcolor{red}{Agregar parráfo que introduzca el problema del estudio de la ciriculación extra-tropical en SH, su variaiblidad y sus cambios. Quizás algo también de los impactos. También algo habría que decir de la primavera, ya que solo nos concentrmaos en esa estación}

The large-scale extratropical circulation in the Southern Hemisphere is strongly zonally symmetric, but its zonal departures are highly relevant for surface impacts and could be related to high-impact climate extremes.
Zonal asymmetries of extratropical circulation in the Southern Hemisphere strongly modulate weather systems and regional climate through latitudinal transport of heat, humidity, and momentum [@trenberth1980].

One typical way of describing the zonally asymmetric circulation is by the amplitude and phase of zonal waves obtained by Fourier decomposition of geopotential height at each latitude [e.g.
@vanloon1972;@trenberth1980;@turner2017].
This approach suggests that zonal waves 1 and 3 explained most of the variance of the tropospheric extratropical Southern Hemisphere circulation (@vanloon1972).
However, this methodology rely on the assumption that the circulation can be meaningfully understood in terms of zonal waves of constant amplitude along a latitude circle.
This is not valid for meridionally propagating waves or zonal waves with localised amplitudes.
In the case of the wave 3, for example, @trenberth1985 observed that it played a role in blocking events, but this was mostly due to increased amplitude of a longitudinally localised wave train instead of an hemispheric-scale zonal wave 3.

Another approach to characterising the Southern Hemisphere circulation is by using Empirical Orthogonal Functions (EOF, also known as Principal Component Analysis).
Within the EOF framework, the Southern Annular Mode (SAM) appears as the leading mode of variability of the tropospheric Southern Hemisphere circulation [@fogt2020] followed by the two Pacific--South American Patterns (PSA) [@mo2001].
The SAM represents a relatively zonally symmetric pattern of alternating low pressures in polar latitude and a ring of high pressures in high latitudes with an embedded wave 3 pattern that is more prominent in the Pacific sector.
The PSA1 and PSA2 describe the two out-of-phase sides of a meridionally propagating wave train that originates in the Eastern equatorial Pacific and travels towards the South Atlantic following a great-circle arch along the Antarctic Peninsula.
These patterns are derived by applying EOF to temporal anomalies, but @raphael2003 applied EOF methods specifically to zonal anomalies.

EOFs are more flexible than Fourier descomposition modes in the sense that they can characterise \textcolor{red}{Esto hay que exresarlo más claramente}.
Nonetheless, they are restricted to standing oscillation modes and could not represent properly propagating or phase-varying modes such as zonal waves.
Besides, a single EOF can also represent a mixture of two or more physical modes.
The inability of a single EOF to describe travelling waves is what forces the PSA pattern to be described by two EOFs.
@irving2016 characterises the Pacific--South American Pattern in a Fourier framework.
Being a meridionally propagating mode, the PSA cannot be correctly characterised by Fourier decomposition at each latitude circle, so they reprojected meridional wind fields so that the path of the PSA laid on the equator.
On this new projection, they could identify the PSA using Fourier decomposition.

Finally, another, hybrid, methodology commonly used consist on identifying particular features of interest and creating indices using simple methods such as averages and differences.
The Marshal SAM Index [@marshall2003], for example, tries to characterise the SAM by the average difference of sea level pressure between 40ºS and 65ºS, following @gong1999.
@raphael2004 used a similar methodology to describe the wave 3 in the Southern Hemisphere.
Instead of using Fourier to compute the amplitude and phase of the zonal wave, they averaged standardised geopotential height anomalies in three points representing the location of the ridges of the zonal wave 3 of the climatological mean.
This is equivalent to an index of the amplitude of the zonal wave 3 that projects into the phase of the zonal wave 3 of the mean field.
Similarly, @hobbs2010 propose that the zonally asymmetric circulation in the Southern Hemisphere can be described by the strength and location of two anticyclones located in the sub-Antarctic western hemisphere.
These methods are grounded on other methods to identify the centers of action for the described phenomena and can be useful to characterise features that are not readily apparent with Fourier or EOF methods.
The use of data of only specific regions or locations makes them suitable for easy computation and for extending into less quality data from the past, but also makes them not very robust and could not capture non-stationary behaviours of the patterns.

\textcolor{red}{Falta un parráfo que deje más claro por qué es necesario considerar un enfoque alternativo y cuál va a ser el beneficio de ello. También agregar qué se estudiara conjuntamente la troposfera y la estratósfera }

\textcolor{red}{Falta el objetivo que justifica el uso de la metodología}

In this paper we propose using complex Empirical Orthogonal Functions [@horel1984] as a robust extension of EOF analysis that is capable of describing rich structures with meridional and zonal propagation, and amplitude modulation such as the PSA.
We apply this method to characterise the Springtime zonally asymmetric circulation of the extratopical Southern Hemisphere.

\textcolor{red}{The data and methods are described in Section 2 :P ...}

# Data and Methods

## Data

We used monthly geopotential height, air temperature, ozone mixing ratio, and Total Ozone Column (TOC) at 2.5\degree longitude by 2.5\degree latitude of horizontal resolution and 37 vertical isobaric levels from ERA5 [@era5] for the period 1979 to 2019.
Most of our analysis was restricted to the post-satellite era to avoid any confounding factors arising from the incorporation of satellite observations, but we also used the preliminary back extension of ERA5 from 1950 to 1978 [@era5be] to look at long-term trends.
Streamfunction was derived from ERA5 vorticity at 200 hPa using the FORTRAN subroutine FISHPACK [@fishpack] and horizontal wave activity fluxes was computed following @plumb1985.
We usded Sea Surface Temperature (SST) monthly fields from Extended Reconstructed Sea Surface Temperature (ERSST) v5 [@huang2017] and precipitation monthly data from the CPC Merged Analysis of Precipitation [@cmap], with a 2.5\degree resolution in latitude and longitude.
This rainfall gridded dataset is based on information from different sources such as rain gauge observations, satellite inferred estimations and the NCEP-NCAR reanalysis, and it is available since 1979 to present.

## Methods

The study is restricted to the spring season, defined as the September-October-November (SON) trimester.
We compute seasonal means for the different variables, averaging monthly values weighted by the number of days in each month.
We use 200 hPa level to represent the high troposphere and 50 hPa to represent the lower stratosphere.

The amplitude of the zonal waves was defined through computing the Fourier transform of the spatial field at each latitude circle.
We computed the amplitude and phase of the zonal wave 1 by averaging (area-weighted) variables (temperature, geopotential height, ozone mixing ratio and Total Ozone Column) between `r knitr::combine_words(LatLabel(o3wave_lats))` for each SON and extracting the wave-1 component of the Fourier spectrum.
We chose this latitude band because it is wide enough to capture most of the relevant anomalies.

We computed the level-dependent Southern Annular Mode (SAM) index as the leading EOF of year-round monthly geopotential height anomalies south of 20ºS at each level for the whole period [@baldwin2009].
We further split the SAM into its zonally symmetric and zonally asymmetric components (S-SAM and A-SAM indices respectively).
These indices were obtained by projecting the zonally asymmetric and zonally symmetric part of the SAM spatial pattern onto monthly geopotential height fields, as proposed by @campitelli2021.
The Pacific South American patterns (PSA1 and PSA2) were calculated following @mo2001 as the third and fourth leading EOF of seasonal mean anomalies for SH 500 hPa geopotential height combining all seasons. 

Linear trends were computed by Ordinary Least Squares and the 95% confidence interval was computed assuming a t-distribution with the appropriate residual degrees of freedom [@wilks2011r].


## Complex Empirical Orthogonal Functions (cEOF)

(ref:eof-naive-cap) Spatial patterns of the leading 4 EOFs of SON zonal anomalies of geopotential height at 50 hPa south of 20\degree S for the 1979 -- 2019 period (arbitrary units).

```{r compute-eof-naive}
eof_naive <- era5[lev %in% c(50, 200) & lat %between% c(-90, -20)] %>% 
  # .[, hgt := Anomaly(hgt), by = .(season(time), lon, lat, lev)] %>%
  .[, hgt  := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(time, lev, lat)] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1:4, data = .SD, suffix = "EOF"))), 
    by = lev]

explained <- eof_naive[, eof[[1]]$sdev, by = lev] %>% 
  .[order(lev, EOF)] %>% 
  .[, scales::percent(r2, accuracy = .1)]

```

```{r eof-naive, fig.cap = "(ref:eof-naive-cap)", fig.width=2.5, fig.height=3.2}
eof_naive[, eof[[1]]$right, by = lev] %>%
  .[lev == 50] %>% 
  .[ , hgt := hgt/sd(hgt)] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = hgt, fill = ..level..),
                    breaks = AnchorBreaks(0, 1, exclude = 0)) +
  geom_contour_tanaka(aes(z = hgt), breaks = AnchorBreaks(0, 1, exclude = 0), 
                      range = c(0.01, 0.2)) +
  
  geom_qmap(~.x[lat <= -20], size = 0.1) +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(10))  +
  scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  scale_x_longitude() +
  coord_polar() +
  theme(axis.text = element_blank()) +
  facet_wrap(.~EOF, ncol = 2)  +
  tagger::tag_facets("rc")  +
  theme(panel.spacing = grid::unit(-.7, "lines")) +
  grid_y
```

In traditional EOF analysis zonal waves appear as pairs of EOFs, that could be degenerated representing similar patterns but shifted in phase [@horel1984].
For instance, Figure \@ref(fig:eof-naive) shows the leading 4 EOFs of SON geopotential height zonal anomalies at 50 hPa south of 20\degree S. 
It is clear that the first two EOFs represent the same zonal wave 1 pattern and the last two represent a same zonal wave pattern with shorter wavenumber and four centers of action shifted by 1/4 wavelength.
A similar EOF structure can be seen in 200 hPa (not shown).
Since each pair of EOFs seem to represent the same phase-varying structure, it would be desirable to combine them into a single index with amplitude and phase.

Complex Empirical Orthogonal Functions (cEOF) is a useful method to characterise zonal waves, considering phase-varying structures [@horel1984].
This method involves augmenting \textcolor{red}{No sé si es un vocabulario específico de usar este método, pero no me queda claro que se entiende por "augmenting" exactamente} the original fields with the Hilbert transform of the data and then computing the Singular Value Decomposition of it.
In this work, instead of applying the Hilbert transform to the time series at each point, we apply it to each latitude circle at each moment in time \textcolor{red}{Esta aclaración la haces por qué es la manera usual de hacer la metodología, si es asi aclaralo.}.
Since each latitude circle is a periodic domain, this procedure does not suffer from edge effects.
The result of the cEOF methodology is a set of complex spatial patterns and complex time series.
The real and imaginary part of each spatial pattern represent two phases wave-like spatial patterns that are in quadrature.
The magnitude and argument of each complex time series represent the amplitude and phase of each zonal wave.

```{r corr-eofs}

background_palette <- grDevices::colorRampPalette(c("white", scales::muted("red")),
                                                  space = "Lab")
# 
# eof_naive[, eof[[1]]$left, by = lev] %>% 
#   .[, item := paste(lev, EOF, sep = "_")] %>% 
#   widyr::pairwise_cor(item, time, hgt) %>% 
#   setDT() %>%
#   # .[]
#   .[tstrsplit(item1, "_")[[1]] != tstrsplit(item2, "_")[[1]], ] %>% 
#   .[tstrsplit(item1, "_")[[1]] != 50] %>% 
#   .[, item1 := tstrsplit(item1, "_")[[2]]] %>%
#   .[, item2 := tstrsplit(item2, "_")[[2]]] %>% 
#   .[, r2 := round(correlation^2, 2)] %>% 
#   dcast(item1 ~ item2, value.var = "r2") %>% 
#   setnames("item1", "200 hPa") %>% 
#   kbl2(booktabs = TRUE, caption = "$R^2$ between pairs of EOFs of each level rounded to two decimals.") %>% 
#   # add_header_above(c("", "50 hPa" = 4)) %>% 
#   column_spec2(2:5,  background = spec_color2(.table[[.col]], option = background_palette, 
#                                               scale_from = c(0, 1)),
#                color = ifelse(.table[[.col]] > .5, "white", "black")) %>% 
#   add_header_above(c("", "50 hPa" = 4)) %>%
#   kable_classic()
```

```{r compute-ceof}
invisible(
  ReadNetCDF(ERA5(), vars = c(hgt = "z"),
             subset = list(latitude = -90:10,
                           level = list(200, 50))) %>%
    normalise_coords() %>%
    .[season(time) == "SON"] %>%
    .[, w := season_weights(time)] %>% 
    .[, .(hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))] %>%
    .[, season := season(time)] %>%
    {
      ceof <<- .[, .(eof = list(compute_ceof(.SD))), by = .(season)]
      ceof_splitted <<-  .[, levs := lev] %>%
        .[, .(eof = list(compute_ceof(.SD, n = 1:3))), by = .(season, levs)]
      
    }
)
```

(ref:corr-ceof-splitted-cap) Coefficient of determination ($R^2$) of the absolute magnitude of complex EOFs between 200 hPa and 50 hPa computing EOF separatedly for each level. 
Background colour indicates the value of $R^2$.

```{r corr-ceof-splitted}
ceof_splitted[, eof[[1]]$left, by = .(lev = levs)] %>%
  copy() %>%
  .[, mag  := abs(hgt)] %>%
  .[, item := paste(lev, cEOF, sep = "_")] %>%
  widyr::pairwise_cor(item, time, mag) %>%
  setDT() %>%
  .[tstrsplit(item1, "_")[[1]] != tstrsplit(item2, "_")[[1]], ] %>%
  .[tstrsplit(item1, "_")[[1]] != 50] %>%
  .[, item1 := tstrsplit(item1, "_")[[2]]] %>%
  .[, item2 := tstrsplit(item2, "_")[[2]]] %>%
  .[, r2 := round(correlation^2, 2)] %>%
  dcast(item1 ~ item2, value.var = "r2") %>%
  setnames("item1", "200 hPa") %>%
  kbl2(booktabs = TRUE, caption = "(ref:corr-ceof-splitted-cap)") %>%
  column_spec2(2:4, background = spec_color2(.table[[.col]], option = background_palette,
                                            scale_from = c(0, 1)),
               color = ifelse(.table[[.col]] > .5, "white", "black")) %>% 
  add_header_above(c("", "50 hPa" = 3)) %>%
  kable_classic() 
```

The cEOF methodology is applied to SON geopotential height zonal anomalies south of 20\degree S at 50 and 200 hPa, representing a stratsopheric and upper troposhperic level respectively.
Table \@ref(tab:corr-ceof-splitted) shows the coefficient of determination between time series of the amplitude of each complex EOF (cEOF) across levels.
There's a high degree of correlation between the respective cEOF1 and cEOF2 at each level.
The spatial patterns of the 50 hPa and 200 hPa cEOFs are also similar (not shown).

Both the spatial pattern similarity and the high temporal correlation of cOEFs computed at 50 hPa and 200 hPa suggest that these are, to a large extent, modes of joint variability.
This motivates the decision of performing complex EOF jointly between levels.
The computation of the cEOFs was carried out using data from both levels at the same time, therefore, each cEOF has a spatial component that depends on longitude, latitude and level, and a temporal component that depends only on time.

The phase of principal components is defined up to an additive constant.
For real principal components, this constant can be either 0 or $\pi$, corresponding to a change in sign.
For complex principal components, it can be any number between 0 and $2\pi$ [@horel1984].
Since any choice is arbitrary and equally valid, we chose the phase of each cEOF so that the real and imaginary parts are aligned with meaningful phases in our analysis.
This procedure does not create a spurious correlation, it only takes whatever relationship that already exist and aligns it with a specific phase.

```{r rotate_eofs}
rotate <- function(z, angle = 0) {
  complex(real = cos(angle), imaginary = sin(angle)) * z
}

angles <- seq(-pi, pi, by = .5*pi/180)

# rotations_cEOF1 <- lapply(angles, function(a) {
#   ceof$eof[[1]]$left[cEOF == "cEOF1"] %>%
#     copy() %>%
#     .[, hgt := rotate(hgt, a)] %>%
#     sep_ReIm() %>%
#     .[, .(mean = mean(hgt)), by = part] %>%
#     .[, rotation := a]
# }) %>%
#   rbindlist()
# 
# 
# best_rotation_cEOF1 <- rotations_cEOF1[part == "Real"][which.min(mean)]$rotation


wave1_o3 <- o3 %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(toc = weighted.mean(toc, w = cos(lat*pi/180), na.rm = TRUE)), by = .(time, lon)] %>% 
  .[, FitWave(toc, 1), by = .(time)] 

with_o3 <- ceof$eof[[1]]$left %>% 
  .[cEOF == "cEOF1"] %>% 
  .[wave1_o3, on = "time"]
  

rotations_o3 <- lapply(angles, function(a) {
  with_o3 %>% 
    copy() %>% 
    .[, hgt := rotate(hgt, a)] %>% 
    na.omit() %>% 
    sep_ReIm() %>% 
    .[, .(cor = cor(amplitude, hgt)), by = part] %>% 
    .[, rotation := a]
}) %>% 
  rbindlist()


best_rotation_cEOF1 <- rotations_o3[part == "Real"][which.max(cor)]$rotation


with_enso <-  cut(ceof$eof[[1]], 2)$left %>%
  copy() %>%
  .[enso, on = "time"] %>% 
  na.omit() 
  
rotations_cEOF2 <- lapply(angles, function(a) {
  with_enso %>%
    .[, hgt2 := rotate(hgt, a)] %>%
    .[, .(R = cor(Re(hgt2), oni),
          I = cor(Im(hgt2), oni))] %>%
    .[, rotation := a]
}) %>%
  rbindlist()

best_rotation_cEOF2 <- rotations_cEOF2[I > 0][which.min(abs(R))]$rotation


eof_rotated_left <- ceof$eof[[1]]$left %>%
  copy() %>%
  .[cEOF == "cEOF2", hgt := rotate(hgt, best_rotation_cEOF2)] %>%
  .[cEOF == "cEOF1", hgt := rotate(hgt, best_rotation_cEOF1)]

eof_rotated_right <-  ceof$eof[[1]]$right %>%
  copy() %>%
  .[cEOF == "cEOF2", hgt := rotate(hgt, best_rotation_cEOF2)] %>%
  .[cEOF == "cEOF1", hgt := rotate(hgt, best_rotation_cEOF1)]

ceof_unrotated <- copy(ceof)

ceof$eof[[1]]$left <- eof_rotated_left
ceof$eof[[1]]$right <- eof_rotated_right

ceof <- rbindlist(list(rotated = ceof,
                       unrotated = ceof_unrotated),
                  idcol = "rotation")

rotated <- function(x) x[rotation == "rotated"]
unrotated <- function(x) x[rotation == "unrotated"]
```

```{r check-rotation}
# Check that rotated and unrotated eofs
# predict the same fields (up to floating point errors)
bad_cells <- ceof[, predict(eof[[1]]), by = rotation] %>%
  .[, hgt := as.numeric(Re(hgt))] %>%
  dcast(time + lon + lat + lev ~ rotation, value.var = "hgt") %>%
  .[, dif := rotated - unrotated] %>%
  .[abs(rotated - unrotated)  > 1e-10]

if (nrow(bad_cells) != 0) {
  stop("Rotated and unrotated eofs are not equivalent!")
}

ceof <- ceof[rotation == "rotated"][, rotation := NULL][]
```

(ref:rotations-cap) a) Correlation of the Real and Imaginary cEOF1 with wave 1 amplitude of Total Ozone Column averaged between `r knitr::combine_words(LatLabel(o3wave_lats))` and b) $R^2$ between the Real and Imaginary cEOF2 and the ONI index for different values of rotation. The vertical line marks the selected rotation, which maximises de correlation.

```{r rotations, fig.cap="(ref:rotations-cap)", fig.height=2.5, fig.width=width_column, include=FALSE}
r2 <- expression(`$r^2$` = paste("", "r", phantom()^{
    paste("2")
}, "", ""))


rotations_o3 %>%
  ggplot(aes(rotation, cor)) +
  geom_vline(xintercept = best_rotation_cEOF1) +
  geom_hline(yintercept = 0,  size = 0.2, color = "gray50") +
  geom_line(aes(color = part)) +
  scale_x_continuous("Rotation", breaks = seq(-pi, pi, by = 90*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  scale_y_continuous("Correlation") +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_cplx) +
  
rotations_cEOF2 %>%
  melt(id.vars = "rotation") %>%
  ggplot(aes(rotation, value^2)) +
  geom_hline(yintercept = 0,  size = 0.2, color = "gray50") +
  geom_vline(xintercept = best_rotation_cEOF2) +
  geom_line(aes(color = variable)) +
  scale_x_continuous("Rotation", breaks = seq(-pi, pi, by = 90*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  scale_y_continuous(r2) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_cplx) +
  
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "a", tag_suffix = ")")
```

For the first complex principal component, the phase was chosen so that the time series corresponding to the real part has the maximum correlation with the zonal wave 1 of Total Ozone Column between `r knitr::combine_words(LatLabel(o3wave_lats))`.
This also nearly minimises the correlation with the imaginary part.

For the second complex principal component, the phase was chosen so that the coefficient of determination between the Oceanic Niño Index [@bamston1997] and the real part was minimized, which also nearly maximizes the correlation with the imaginary part.

While we compute these complex pricipal components using data from 1979 to 2019, we extended the complex time series back to the 1950 -- 1978 period by projecting monthly geopotential height zonal anomalies standardised by level south of 20ºS onto the corresponding spatial patterns.

Each series is computed by projecting monthly geopotential height zonal anomalies standardised by level south of 20ºS onto the corresponding spatial pattern and scaled to zero mean and unit standard deviation.



We performed linear regressions to quantify the association between the cEOFs and other variables.
For each cEOF, we create regression maps by computing fitting a multiple linear model involving both the real and the imaginary part.
We evaluated statistical significance using a two-sided t-test and, in the case of regression maps, p-values were adjusted by controlling for the False Discovery Rate [@benjamini1995; @wilks2016] to avoid misleading results from the high number of regressions [@walker1914; @katz1991].

## Computation procedures

We performed all analysis in this paper using the R programming language [@rcoreteam2020], using data.table [@dowle2020] and metR [@campitelli2020] packages.
All graphics are made using ggplot2 [@wickham2009].
We downloaded data from reanalysis using the ecmwfr package [@hufkens2020] and indices of the ENSO with the rsoi package [@albers2020].
The paper was rendered using knitr and rmarkdown [@xie2015; @allaire2019].

# Results

## cEOF spatial patterns

```{r ceofs-1, fig.cap = "Spatial patterns for the two leading cEOFs of SON zonal anomalies of geopotential height at 50 hPa and 200 hPa for the 1979 -- 2019 period. The shading (contours) corresponds to real (imaginary) part. Arbitrary units.", fig.width=width_column, fig.height=width_column*1.2}

gdata <- ceof[, eof[[1]]$right, by = .(season)] %>% 
  copy() %>% 
  .[, hgt := hgt/sd(abs(hgt))]

var <- ceof[, eof[[1]]$sdev, by = .(season)] %>%
  .[, setNames(paste0(cEOF, " (", scales::percent(r2), ")"),
               cEOF)]


gdata %>%
  ggperiodic::periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  
  geom_contour_fill(aes(z = Re(hgt), fill = ..level..),
                    breaks = AnchorBreaks(0, 1, exclude = 0)) +
  geom_contour2(aes(z = Im(hgt),  linetype = factor(sign(..level..))),
                breaks = AnchorBreaks(0, 1, exclude = 0)) +
  
  scale_fill_divergent_discretised(guide = guide_colorsteps_bottom()) +
  
  
  geom_qmap(~ .x[lat <= -20]) +
  scale_x_longitude() +
    scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  scale_linetype_manual(values = c("1" = 1, "-1" = 2), labels = c("1" = "+", "-1" = "-"),
                        guide = "none") +
  facet_grid( lev  ~  cEOF,
             labeller = labeller(lev = lab_lev,
                                 cEOF = var)) +
  coord_quickmap(ylim = c(NA, -20)) +
  theme(legend.title = element_blank()) +
  coord_polar() +
  axis_labs_smol +
  tag_facets(tag = "cr") +
  grid_y
```

```{r ceofs-2, fig.cap = "Time series of the leading two cEOFs of zonal anomalies of geopotential height at 50 hPa and 200 hPa for the SON trimester and the period 1979 -- 2019.", fig.height=width_column, fig.width = width_column}
ceof %>%
  .[, eof[[1]]$left, by = season] %>%
  sep_ReIm(hgt) %>%
  .[season == "SON"] %>%
  # .[, hgt := scale(hgt), by = .(part, cEOF)] %>%
  ggplot(aes(time, hgt)) +
  geom_hline(yintercept = 0, size = 0.1, color = "gray30") +
  geom_line(aes(color = part)) +
  scale_x_datetime(NULL) +
  scale_y_continuous(NULL) +
  scale_color_brewer(NULL, palette = "Dark2") +
  facet_grid(cEOF ~ ., switch = "y") +
  theme(panel.spacing = grid::unit(1.5, "lines"), strip.placement = "outside")  +
  ggthemes::geom_rangeframe(sides = "lr", size = 0.1, color = "gray30") +
  panel_background
```

To describe the variability of the circulation zonal anomalies, the spatial and temporal parts of the first two leading cEOFs of zonal anomalies of geopotential height at 50 hPa and 200 hPa, compueted jointly at both levels, are shown in Figures \@ref(fig:ceofs-1) and \@ref(fig:ceofs-2).
The first mode (cEOF1) explains 82% of the variance, while the second mode (cEOF2) explains a smaller fraction (7%).
In the spatial patterns (Fig. \@ref(fig:ceofs-1)), the real and the imaginary components are in quadrature by construction, so that each cEOF describe a single wave-like pattern whose amplitude and position (i.e. phase) is controlled by the magnitude and phase of the temporal cEOF.
The wave patterns described by these cEOFs match the patterns seen in the traditional EOFs of Figure \@ref(fig:eof-naive).

The first cEOF (Fig. \@ref(fig:eof-naive) column a) is a hemispheric wave 1 pattern with maximum amplitude at high latitudes.
At 50 hPa the Real cEOF1 has the maximum of the wave 1 at 150ºE and at 200 hPa, the maximum is located at around 175ºE indicating a westerly shift in phase.
The second cEOF (Fig. \@ref(fig:eof-naive) column b) shows also a zonal wave-like structure with maximum amplitude at high latitudes, but with shorter spatial scales.
In particular, its dominant structure at both levels is a wave 3 but with larger amplitude in the pacific sector.
This modulated amplitude is especially apparent at 200 hPa.
There is no apparent phase shift, suggesting a rather barotropic structure.

The temporal variability for both components of the cEOF1 have non zero mean (Fig. \@ref(fig:ceofs-2)).
This is due to the fact that the geopotential fields that enter into the cEOFs algorithm are anomalies with respect to the zonal mean, not the time mean.
As a consequence, the variability associated with the cEOF1 includes variability that projects onto the mean zonally anomalous field.
There are no significant simultanous correlation between the time series.
Both cEOFs show year-to-year variability but show no evidence of decadal variabilty.
The relatively short timespan (`r diff(range(unique(year(era5$time))))` years) hampers our habilty to detect longer trends.

```{r era_more}
pattern <- ceof$eof[[1]]$right %>%
  sep_ReIm() %>%
  setnames("hgt", "EOF")


era_more <- rbind( 
  ReadNetCDF(ERA5_BE(), vars = c(hgt = "z"),
             subset = list(latitude = range(pattern$lat),
                           level = list(200, 50))),
  ReadNetCDF(ERA5(), vars = c(hgt = "z"),
             subset = list(latitude = range(pattern$lat),
                           level = list(200, 50)))) %>%
  normalise_coords() %>%
  .[season(time) == "SON"] %>%
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))] %>%
  .[, season := season(time)] %>%
  .[, hgt := hgt/sd(hgt), by = .(lev)] %>%
  .[pattern, on = .NATURAL, allow.cartesian = TRUE] %>%
  .[, .(hgt = weighted.mean(hgt*EOF, w = cos(lat*pi/180))),  by = .(part, cEOF, time)] 

```

(ref:extended-series-cap) Time series extended using ERA5 back extended preliminary edition (period 1950 -- 1978) and ERA5 (period 1979 -- 2019).
Each series is scaled to zero mean and unit standard deviation. 

```{r extended-series, fig.cap = "(ref:extended-series-cap)", fig.height=3, fig.width = 7, fig.env = "figure*"}
# Check that the extended index coincides with the
# original index.
cors <- era_more %>%
  .[sep_ReIm(ceof$eof[[1]]$left), on = c("time", "cEOF", "part")] %>%
  na.omit() %>%
  .[, cor(hgt, i.hgt), by = .(cEOF, part)]

if (any(cors$V1 < 0.98)) {
  stop("Extended indices didn't work!")
}


trends <- era_more %>%
  .[, FitLm(hgt, time, se = TRUE), by = .(part, cEOF)] %>%
  rm_intercept() %>%
  .[, p_val := Pvaluate(estimate, std.error, df)] %>%
  .[, p_report := report_p(p_val)]

# era_less <-   ceof %>%
#   .[, eof[[1]]$left, by = season] %>%
#   sep_ReIm(hgt) %>%
#   .[season == "SON"] %>% 
#   .[, hgt := as.numeric(scale(hgt)), by = .(part, cEOF)] 


era_more %>%
  copy() %>% 
  .[, ref := year(time) > 1979] %>% 
   # .[, hgt := scale(hgt, center = FALSE, scale = sd(hgt[ref])), by = .(part, cEOF)] %>%
  ggplot(aes(time, hgt*1e3)) +
  # Zero line + rangeframe
  geom_hline(data = ~.x[, mean(hgt)*1e3, by  = .(cEOF, part)], 
             aes(yintercept = V1), size = 0.1, color = "gray30") +
  ggthemes::geom_rangeframe(sides = "lr", size = 0.1, color = "gray30") +
  geom_line(aes(color = part)) +
  # geom_line(data = era_less) +
  scale_alpha_manual(values = c(1, 0.2)) +
  geom_smooth(method = "lm", aes(color = part)) +
  scale_x_datetime(NULL, date_labels = "%Y") +
  scale_y_continuous("EOF") +
  scale_color_brewer(NULL, palette = "Dark2") +
  facet_grid(cEOF ~ part, scales = "free_y") +
  theme(panel.spacing = grid::unit(1.5, "lines"))  +
  tag_facets("cr") +
  panel_background
```

Therefore, we extend the cEOFs time series using the preliminary ERA5 back extension going back to 1950 by projecting the older SON geopogential height zonal anomaly fields onto the spatial patterns shown in Figure \@ref(fig:ceofs-1).
There is a significant upward trend in the real component of cEOF1 (Fig. \@ref(fig:extended-series)a.1, p-value `r trends[part == "Real" & cEOF == "cEOF1"]$p_report`) and no significant trend in any of the complex components of cEOF2.
The positive trend in the real cEOF1 translates into a positive trend in cEOF1 magnitude, but not in the phase (not shown).

\textcolor{red}{Revisa la figura 4 que te están quedando bastante desparejos los subplots. También sugieron mantener la convención de colores de la figura anterior (real/imaginario) para hacer más directa la interpretación.}

This long-term change indicates an increase in the magnitude of the high latitude zonal wave 1.
A similar observation was made by @raphael2003, who detected a step after around 1975 in the leading EOF of August-September-October 500 hPa zonal geopotential height anomalies.

## cEOFs Regressions

The spatial patterns shown in Figure \@ref(fig:ceofs-1) are derived by removing the zonally symmetric circulation, so they might not include all the variability that is actually associated with the cEOF time series.
To understand the full geopotential height field changes associated with each cEOF, we computed regression patterns of each cEOF with the complete geopotential fields.

```{r compute-regression}
regr <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[season == "SON"] %>%
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))),
    by = .(season, cEOF)] %>%
  dcast(time ~ cEOF, value.var = c("Real", "Imaginary")) %>%
  .[melt(era5, id.vars = c("time", "lon", "lat", "lev")), on = "time", allow.cartesian = TRUE] %>%
  .[lev %in% c(850, 700, 200, 50)] %>%
  # .[variable == "hgt"] %>%
  .[, FitLm(value, Imaginary_cEOF1, Real_cEOF1, Imaginary_cEOF2, Real_cEOF2, se = TRUE),
    by = .(lev, lon, lat, variable)] %>%
  .[, c("term", "cEOF") := tstrsplit(term, "_")] %>%
  rm_intercept() %>%
  .[, term := factor_ReIm(term)]
```

```{r plot_regr}
plot_regr <- function(data, which_cEOF, which_levs, which_var) {
  data <- data %>%
    .[ cEOF %in% which_cEOF] %>%
    .[variable == which_var]
  
  var_title <- switch(which_var,
                      hgt = "Geopotential height",
                      t = "Temperature")
  
  
  if (length(which_cEOF) > 1) {
    facet <- ggh4x::facet_nested(cEOF ~  term)
  } else {
    facet <- ggh4x::facet_nested(lev ~ cEOF +  term, 
                                 labeller = labeller(lev = lab_lev))
  }
  
  if ("lev" %in% colnames(data)) {
    data <- data[lev %in% which_levs]
  } else {
    data[, lev := which_levs]
  }

  data[lat <= -20] %>%
    # .[term == "I" & lev == 50] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(lev, cEOF, term)] %>%
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(exclude = 0),
                      global.breaks = FALSE) +
    geom_contour_tanaka(aes(z = estimate), 
                        breaks = AnchorBreaks(exclude = 0), global.breaks = FALSE) +
    scale_fill_divergent(var_title, breaks = AnchorBreaks(0, exclude = 0),
                         guide = guide_colorstrip_bottom(15)) +
    geom_contour_pval(aes(z = p.value)) +
    
    geom_qmap(~ .x[lat <= -20]) +
    
    scale_x_longitude() +
      scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
    grid_y +
    facet +
    coord_polar() +
    axis_labs_smol +
    tag_facets("rc")
}
```

(ref:eof1-regr-gh-cap) Regression coefficients of the real and imaginary part of the first cEOF on SON geopotential height anomalies for the 1979 -- 2019 period. 
These coefficients come from multiple linear regression involving the real and imaginary part of both cEFOs.

```{r eof1-regr-gh, fig.cap = "(ref:eof1-regr-gh-cap)", fig.height=1.2*width_column, fig.width=width_column, dependson="plot_regr"}
plot_regr(regr , "cEOF1", c(200, 50), "hgt") +
  scale_fill_divergent("Geopotential height", breaks = AnchorBreaks(0, exclude = 0),
                       guide = guide_colorstrip_bottom(15), 
                       limits = c(-1800, 1800))
```

\textcolor{red}{Creo que te había hecho el mismo comentario en la versión anterior. Tenés que ser más preciso cuando hablas/mostras regresiones indicando en qué dirección va la regresión "regressed upon". Revisalo a lo largo del texto. En la figura 5, ¿no está al revés?}

\textcolor{red}{En el caption de la Figura 5 falta aclarar qué son los puntos.}

Figure \@ref(fig:eof1-regr-gh) shows regression maps of SON geopotential height anomalies upon cEOF1.
At 50 hPa (Figure \@ref(fig:eof1-regr-gh) row a), both the Real and Imaginary cEOF1 are associated with planetary wave 1 patterns, that are 90º off phase.
Their phases coincide with the ones shown in Figure \@ref(fig:ceofs-1)a.1, with the positive centre of the real cEOF1 located towards the dateline, and the one of the Imaginary cEOF1 located over Eastern Antarctica.
However, the Real cEOF1 pattern is substantially altered by the zonally symmetric circulation.
Instead of a clear wave 1 pattern, the regression pattern can be better describes as a monopole with its centre displaced from the South Pole.

The regression patterns at 200 hPa (Figure \@ref(fig:eof1-regr-gh) row b) are similarly influenced by the zonally symmetric circulation.
It is only possible to distinguish partially the wave 1 pattern in relation with the real cEOF1 (Figure \@ref(fig:eof1-regr-gh)b.1).
The imaginary cEOF1 shows a much more zonally symmetrical pattern resembling the negative SAM phase.

With the exception of the imaginary cEOF1, it is clear that these patterns are very different than the fully zonally asymmetric versions (Fig. \@ref(fig:ceofs-1)), particularly at 200 hPa.
Moreover, only in the stratosphere these patterns actually show a distinguishable wave 1 pattern shifted in phase by 90º, suggesting that using the cEOF method is artificially generating a wave structure at 200hPa.
Therefore, the magnitude and phase of the cEOF1 are associated with the magnitude and phase of a zonal wave only in the stratosphere.
While in the troposphere, they are associated with slightly off-centre monopoles.

(ref:eof2-regr-gh-cap) Same as Figure \@ref(fig:eof1-regr-gh) but for the second cEOF.

```{r eof2-regr-gh, fig.cap = "(ref:eof2-regr-gh-cap)", fig.height=1.3*width_column, fig.width=width_column, dependson="plot_regr"}
plot_regr(regr, "cEOF2", c(200, 50), "hgt") +
    scale_fill_divergent("Geopotential height", 
                         breaks = AnchorBreaks(0, 200, exclude = 0),
                       guide = guide_colorstrip_bottom(15), 
                       limits = c(-1000+1, 1000-1))
```

Figure \@ref(fig:eof2-regr-gh) shows the regression pattern of geopotential height anomalies upon the cEOF2. Unlike for cEOF1, in this case the regression patterns are similar to the fully zonally asymmetric patterns from Figure \@ref(fig:ceofs-1). Although there are some differences (particularly in 50 hPa), the wave trains identified before are well characterised and patterns associated with the real cEOF2 are 90º out of phase with those associated with the imaginary cEOF2. Zonal wave 3 dominates all fields, but only in the western hemisphere, over the Pacific and Atlantic Oceans. cEOF2 then represents a equivalent barotropic wave train that is very similar to the the Pacific South American Patterns [@mo2001].
Comparing the location of the positive anomaly near 90ºW in column b of Figure \@ref(fig:eof2-regr-gh) with Figures 1.a and b from @mo2001, the real cEOF2 can roughly be identified with PSA2, while the imaginary cEOF2 resembles PSA1.

```{r zonal-waves, fig.cap = "Amplitud de ondas zonales de la regresión con altura geopotencial (figuras anteriores)"}
# regr %>%
#   .[lat <= -20] %>%
#   .[lev %in% c(200, 50)] %>%
#   # .[cEOF == "cEOF1"] %>%
#   .[, FitWave(estimate, 0:3), by = .(lev, cEOF, term, lat)] %>%
#   # .[, pseudor2 := amplitudepseudor2^2/sum(amplitude^2), by = .(lev, cEOF, term, lat)] %>% 
#   ggplot(aes(lat, amplitude)) +
#   geom_line(aes(color = factor(k))) +
#   ggh4x::facet_nested(cEOF + lev ~ term, scales = "free", labeller = labeller(lev = lab_lev)) +
#   scale_color_brewer("Wavenumber", palette = "Dark2") +
#   scale_y_continuous("Amplitude") +
#   scale_x_latitude() +
#   coord_flip() +
#   panel_background
```

## cEOFs relationship with other variables 

\textcolor{red}{Quedo medio rara la divsión con los títulos. Me parece que convendrá discutir primero la relación con otros modos de circulación conocidos (SAM, Ozono) y después con las otras variables(Temp, TOC, SST, precip)}

### Temperature and Ozone

(ref:eof1-regr-t-cap) Same as Figure \@ref(fig:eof1-regr-gh) but for air temperature.

```{r eof1-regr-t, fig.cap = "(ref:eof1-regr-t-cap)",  dependson="plot_regr", fig.height=1.3*width_column, fig.width=width_column}
plot_regr(regr, "cEOF1", c(200, 50), "t") +
    scale_fill_divergent("Temperature", breaks = AnchorBreaks(0, exclude = 0),
                       guide = guide_colorstrip_bottom(15), 
                       limits = c(-4.5, 4.5))
```

```{r t}
t <- ERA5() %>% 
  ReadNetCDF(vars = c("t", hgt = "z", "o3"), 
             subset = list(latitude = c(-90, -20))) %>% 
  normalise_coords() %>% 
  .[season(time) == "SON"] %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(t   = mean(t*w),
        o3  = mean(o3*w),
        hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))]
```

(ref:t-vertical-cap) Regression coefficients between cEOF1 and zonal anomalies of mean air temperature (shaded) and ozone mixing ratio (contours, negative contours with dashed lines, labels in parts per billion by mass) averaged between `r knitr::combine_words(LatLabel(o3wave_lats))` for the period 1979 -- 2019.

```{r lable_placement_min}
lable_placement_min <- function(direction = c("vertical", "horizontal"))  {
  direction <- direction[1]
  function(x, y) {
    if (direction == "vertical") {
      return(which.min(y))
    }
    else if (direction == "horizontal") {
      return(which.min(x))
    }
  }
}
```

```{r t-vertical, fig.cap = "(ref:t-vertical-cap)", fig.height=2.5, fig.width=width_column}
t %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(hgt = weighted.mean(hgt, cos(lat*pi/180)),
        o3 = weighted.mean(o3, cos(lat*pi/180)),
        t = weighted.mean(t, cos(lat*pi/180))), by = .(lev, time, lon)] %>%  
  melt(id.vars = c("lev", "time", "lon")) %>% 
  .[, value := Anomaly(value), by = .(time, lev, variable)] %>%
  .[cut(ceof$eof[[1]], 1)$left, on = "time"] %>% 
  sep_ReIm(format = "wider") %>% 
  .[, ":="(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))), by = .(cEOF)] %>% 
  .[, FitLm(value, Real, Imaginary, se = TRUE), by = .(lev, lon, variable)] %>% 
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)] %>% 
  # .[, z := metR:::standard_atmosphere$altitude(lev*100)] %>% 
  # .[, dz1 := c(NA, diff(estimate)/diff(z)) , by = .(term, lon, variable)] %>% 
  # .[, dz2 := c(diff(estimate)/diff(z), NA) , by = .(term, lon, variable)] %>% 
  # .[, dz := (dz1 + dz2)/2] %>% 
  # .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, variable)] %>%
  # .[lev < 900] %>% 
  ggplot(aes(lon, lev)) +
  geom_contour_fill(data = ~.x[variable == "t"],
                    aes(z = estimate, fill = ..level..),
                    breaks = AnchorBreaks(0, binwidth = 0.3, exclude = 0)) +
  geom_contour_tanaka(data = ~.x[variable == "t"],
                      aes(z = estimate),
                      breaks = AnchorBreaks(0, binwidth = 0.3, exclude = 0)) +
  geom_contour2(data = ~.x[variable == "o3"], 
                aes(z = estimate, linetype = factor(-sign(..level..))), 
                breaks = AnchorBreaks(0, exclude = 0)) +
  geom_text_contour(data = ~.x[variable == "o3"], 
                aes(z = estimate*1e9, label = signif(..level.., 2)),
                size = 2,
                skip = 1, stroke = 0.15, stroke.colour = "white", 
                label.placement = lable_placement_min(),
                breaks = AnchorBreaks(0, exclude = 0)) +
 
  scale_fill_divergent_discretised("Air temperature", 
                                   # limits = c(-2.25, 2.25),
                                   guide = guide_colorsteps_bottom(15)) + 
  scale_y_level() +
  scale_linetype(guide = "none") +
  scale_x_longitude(ticks = 60) +
  facet_grid(~term) +
  axis_labs_smol +
  coord_cartesian(clip = "off") 
```

The relation between cEOFs and temperature was also evaluated.
Figure \@ref(fig:eof1-regr-t) shows regression patterns of air temperature at 50hPa and 200hPa onto cEOF1.
In both levels, the Real cEOF1 is associated with positive monopole over the South Pole with its centre moved slightly towards 150ºE (Fig. \@ref(fig:eof1-regr-t) column 1).
On the other hand, the regression maps on the Imaginary cEOF1 show a more clear wave 1 pattern with its maximum around 60ºE.
The distribution of temperature regression coefficients at 50 hPa and at 200 hPa mirror the geopotential height regression maps at 50 hPa (Fig. \@ref(fig:eof1-regr-gh)).

Figure  \@ref(fig:t-vertical) shows the vertical distribution of the regression coefficientes on cEOF1 from zonal anomalies of air temperature and zonal anomalies of ozone mixing ratio averaged between `r knitr::combine_words(LatLabel(o3wave_lats))`.
\textcolor{red}{Deberias aclarar qué significa la terminología que estas utilizando. Lo podes hacer en los métodos y ya queda para todo el texto}.
Temperature zonal anomalies associated with cEOF1 show a clear wave 1 pattern for both real and imaginary components throughout the atmosphere above 250 hPa with a change in sign above 10 hPa.
Following hydrostatic balance, this is the level in which the geopotential anomaly have maximum amplitude (not shown).

The maximum ozone anomalies are co-located with the minimum temperature anomalies above 10 hPa and with the maximum temperature anomalies below 10 hPa (Fig. \@ref(fig:t-vertical))). Therefore, the ozone zonal wave 1 is anticorrelated with the temperature zonal wave 1 in the upper stratosphere, and directly correlated in the upper stratosphere . This change in phase is observed in ozone anomalies forced by planetary waves that reach the stratosphere. In the photochemically-dominated upper stratosphere, cold temperatures inhibit the destruction of ozone, and the advectively-dominated lower stratosphere, ozone anomalies are 90º out of phase with horizontal and vertical transport, which is 90º our of phase with temperature anomalies [@hartmann1979; @wirth1993; @smith1995].

\textcolor{red}{Revisa que todos los captions tengan las unidades correspondientes}

```{r o3-t-phase}
# t %>% 
#   .[lat %between% c(-80, -35)] %>% 
#   .[, .(o3 = weighted.mean(o3, cos(lat*pi/180)),
#         t = weighted.mean(t, cos(lat*pi/180))), by = .(lev, time, lon)] %>%  
#   melt(id.vars = c("lev", "time", "lon")) %>% 
#   # .[, value := Anomaly(value), by = .(time, lev, variable)] %>%
#   .[cut(ceof$eof[[1]], 1)$left, on = "time"] %>% 
#   sep_ReIm(format = "wider") %>% 
#   .[, ":="(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))), by = .(cEOF)] %>% 
#   .[, FitLm(value, Real, Imaginary, se = TRUE), by = .(lev, lon, variable)] %>% 
#   rm_intercept() %>% 
#   .[, term := factor_ReIm(term)] %>% 
#   .[, FitWave(estimate, 1), by = .(lev, variable, term)] %>% 
#   dcast(lev + term ~ variable, value.var = c("phase", "amplitude")) %>%
#   ggplot(aes(lev, acos(cos(phase_t - phase_o3)))) +
#   geom_line(aes(color = term)) +
#   scale_x_level() +
#   scale_colour_brewer(NULL, palette = "Dark2") +
#   scale_y_continuous("Wave-1 phase difference\nbetween Temperature and Ozone",
#                      breaks = seq(-pi, pi, by = 30*pi/180),
#                      labels = function(x) paste0(round(x*180/pi, 5), "º"))  +
#   coord_flip()
```

```{r o3_regr}
temp <- ceof$eof[[1]]$left %>% 
  .[cEOF == "cEOF1"] %>% 
  copy() %>% 
  sep_ReIm(format = "wider") %>% 
  .[, `:=`(Real = as.numeric(scale(Real)), 
           Imaginary = as.numeric(scale(Imaginary))),
    by = .(cEOF)]
o3_mean <- o3 %>% 
  .[, .(toc = mean(toc)), by = .(lon, lat)] %>% 
  .[, toc_z := Anomaly(toc), by = .(lat)]
o3_regr <- temp %>% 
  o3[., on = "time", allow.cartesian = TRUE] %>% 
  .[, FitLm(toc, Real, Imaginary, se = TRUE), by = .(lon, lat, cEOF)] %>% 
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)]
```

(ref:o3-regr-cap) Regression coefficients (shaded) of SON mean Total Ozone Column anomalies onto the real (a) and imaginary (b) components of the cEOF1 for the 1979 -- 2019 period. On contours, the mean zonal anomaly of Total OZone Column (negative contours in dashed lines, Dobson Units).

```{r o3-regr, fig.cap = "(ref:o3-regr-cap)", fig.height=3, fig.width = width_column}
o3_regr %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(cEOF, term)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..),
                    breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = estimate), breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour2(data = periodic(o3_mean, lon = c(0, 360)),
                aes(z = toc_z, linetype = factor(-sign(..level..))), 
                breaks = AnchorBreaks(0, exclude = 0), 
                bins = 5) +
  
  geom_contour_pval(aes(z = p.value)) +
  geom_hline(yintercept = o3wave_lats, size = 0.3, alpha = 0.8) +
  geom_qmap(~.x[lat <= -20]) +
  scale_fill_divergent_discretised("Total Ozone Column", 
                                   limits = c(-30, 30),  
                                   guide = guide_colorsteps_bottom(15)) + 
  scale_x_longitude() +
    scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  grid_y +
  scale_linetype(guide = "none") +
  coord_polar() +
  
  facet_grid(cEOF~term) +
  axis_labs_smol +
  tag_facets("panel")

```

The regression maps of cEOF1 with fields of Total Ozone Column (TOC) (Fig.  \@ref(fig:o3-regr)) show zonal wave 1 pattens in TOC associated with both phases of cEOF1. Climatologically, the springtime Ozone minimum is located off the South Pole and towards the Weddell Sea [@wirth1993, \textcolor{red}{¿Alguna referencia más nueva?}].
Thus, the Real cEOF1 regression pattern (Figure \@ref(fig:o3-regr)a) coincides with the climatological position of the ozone hole while the one for the Imaginary cEOF1 is shifted by 90º.

(ref:wave1-o3-cap) Relationship between cEOF1 amplitude and phase with amplitude and phase of the zonal wave 1 in Total Ozone Column averaged between `r knitr::combine_words(LatLabel(o3wave_lats))` for the period 1979 -- 2019.

```{r wave1-o3, fig.cap = "(ref:wave1-o3-cap)", fig.width=width_column, fig.height=width_column*.7, include = FALSE}
wave1_o3 <- o3 %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(toc = mean(toc, na.rm = TRUE)), by = .(time, lon)] %>% 
  .[, FitWave(toc, 1), by = .(time)] 

temp <- ceof$eof[[1]]$left %>% 
  .[cEOF == "cEOF1"] %>% 
  .[wave1_o3, on = "time"]
  
# temp %>% 
#   copy() %>% 
#   na.omit() %>% 
#   sep_ReIm() %>% 
#   .[, hgt := scale(hgt), by  = .(part)] %>% 
#   ggplot(aes(amplitude, hgt)) +
#   geom_point() +
#   geom_smooth(method = "lm", color = "black") +
#   facet_grid(cEOF ~ part) +
#   panel_background
wave1_cor <- rbind(temp %>%
                     .[, correlate(amplitude, Mod(hgt))] %>% 
                     .[, with := "amplitude"],
                   
                   temp %>%
                     .[, correlate(phase, Arg(hgt))] %>% 
                     .[, with := "phase"])


correlation_statistics <- function(x, n, signif = 2) {
  z <- atanh(x)
  se <- 1/sqrt(n - 3)
  
  low <- qnorm(.025, mean = z, sd = se)
  low <- tanh(low)
  hig <- qnorm(.975, mean = z, sd = se)
  hig <- tanh(hig)
  
  p.value <- pnorm(abs(x)/se, lower.tail = FALSE)
  
  text <- paste0(signif(x, signif), " (CI: ",
                 signif(low, signif), " -- ", signif(hig, signif), ")")
  
  list(estimate = x, 
       p.value = p.value, 
       low = low,
       hig = hig,
       text = text
  )
}


wave_correlation <- temp %>% 
  na.omit() %>% 
  .[, .(cor = mean(cos(phase - Arg(hgt))),
        n = .N)] %>% 
  .[, correlation_statistics(cor, n)]

temp %>% 
  ggplot(aes(Mod(hgt), amplitude)) +
  scale_x_continuous("EOF1 Amplitude") +
  scale_y_continuous("O3 Wave-1\nAmplitude") +
  
temp %>% 
  copy() %>%
  na.omit() %>% 
  qwrap(phase = c(0, 2*pi) ~ c(-pi, pi)) %>% 
  ggplot(aes(Arg(hgt), phase)) +
  scale_x_continuous("EOF1 Phase",
                     breaks = seq(-pi, pi, by = 15*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  scale_y_continuous("O3 Wave-1\nPhase",
                     breaks = seq(-pi, pi, by = 30*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º"))  +
  plot_layout(ncol  = 1) &
  geom_point()  &
  geom_smooth(method = "lm") 


```

There is a close spatial relationship between amplitudes and phases of the cEOF1 and TOC planetary wave 1 between `r knitr::combine_words(LatLabel(o3wave_lats))`.
The correlation between the amplitude of both indices is `r wave1_cor[with == "amplitude"]$text` the overall correlation between the zonal wave 1 of ozone and cEOF1 (computed as the mean cosine of the difference in phase) is `r wave_correlation$text`.
As expected from the location of regressions in Figure \@ref(fig:o3-regr), the Real cEOF1 drives the relationship of amplitudes and the Imaginary cEOF1 drives the relationship of phases between the timeseries (not shown).

### SAM

(ref:sam-eof-vertical-cap) Coefficient of determination between the real and imaginary part of each cEOF and the SAM, Asymmetric SAM (A-SAM) and Symmetric SAM (S-SAM) indices computed at each level according to @campitelli2021. Thick lines represent estimates with p-value \< 0.01 corrected for False Detection Rate [@benjamini1995].

```{r sam-eof-vertical, fig.cap = "(ref:sam-eof-vertical-cap)", fig.height=4, fig.width=width_column}
time <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part)]

sam_r2 <- sams %>%
  .[time, on = .NATURAL, allow.cartesian = TRUE] %>%
  .[, correlate(hgt, estimate), by = .(lev, term, part, cEOF)]


max_r2 <- sam_r2[part == "Imaginary" & term == "asym"] %>% 
  .[, .SD[which.max(estimate^2)], by = .(cEOF)]

sam_r2 %>%
  .[, p.value_a := p.adjust(p.value, "fdr")] %>% 
  ggplot(aes(lev, estimate^2)) +
  geom_vline(xintercept = c(50, 200),  size = 0.2, color = "gray50") +
  # geom_point(data = ~.x[p.adjust(p.value, "fdr") < 0.01], aes(color = term)) +
  geom_line(data = ~copy(.x)[p.value_a > 0.01, estimate := NA], 
            aes(colour = stage(term, after_scale = scales::alpha(colour, 0.5))), 
            size = 2) +
  geom_line(aes(color = term, group = term)) +
  
  scale_x_level() +
  scale_y_continuous(r2, limits = c(0, 1)) +
  scale_size_manual("p-value", values = c("TRUE" = 1, 
                                      "FALSE" = 0.5), 
                    guide = "none") +
  scale_color_brewer(NULL, palette = "Dark2", labels = c(full = "SAM",
                                                         asym = "A-SAM",
                                                         sym = "S-SAM")) +
  facet_grid(part ~ cEOF) +
  coord_flip() +
  tag_facets("rc") +
  panel_background
```

To explore the relationship between SAM and the modes described from the cEOF, we compute the coefficient of determination between the cEOFs timeseries and the three SAM indices (SAM, A-SAM and S-SAM) at each vertical level (Fig. \@ref(fig:sam-eof-vertical)).
The SAM index is moderately correlated with the Real cEOF1 in all levels, and with the Imaginary cEOF1 and Imaginary cEOF2 in the troposphere.
It is not correlated with the Real cEOF2 at any level.

The relationship between the tropospheric SAM and cEOF1 is explained entirely by the zonally symmetric component of the SAM as shown by the low and statistically non-significant correlations between the A-SAM and either the Real or Imaginary cEOF1 and the high correlation with the S-SAM below 100 hPa.
In the stratosphere, the Real cEOF1 is correlated with both A-SAM and S-SAM, while the Imaginary cEOF1 is highly correlated only with the A-SAM.
These correlations are consistent with the regression patterns of geopotential height in Figure \@ref(fig:eof1-regr-gh).

```{r eof-filtered, fig.cap = "Spatial pattern of the leading EOF of 200 hPa geopotential height with the variability of cEOF2 filtered out South of 20º. Arbitrary units.", fig.width=2.5, fig.height=2.5}
cEOF2 <- ceof$eof[[1]]$left[cEOF == "cEOF2"] %>% 
  copy() %>% 
  .[, cEOF := NULL] %>% 
  .[]

eof_filtered <- era5 %>% 
  .[sep_ReIm(cEOF2, format = "wide")[, hgt := NULL], on = .NATURAL] %>% 
  .[lev == 200] %>% 
  .[lat <= -20] %>% 
  .[season(time) == "SON"] %>% 
  .[, hgt := resid(.lm.fit(cbind(1, Real, Imaginary), hgt)), .(lon, lat, lev, season(time))] %>%
  .[, eof := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(lon, lat, lev, season(time))] %>% 
  EOF(eof ~ lon + lat | time, n = 1, data = .) 


eof_filtered_cor <- eof_filtered$right[sams, on = "time"] %>% 
  .[lev == 200] %>% 
  .[, correlate(estimate, eof), by = term]

# eof_filtered %>% 
#   .$left %>% 
#   periodic(lon = c(0, 360)) %>% 
#   ggplot(aes(lon, lat)) +
#   geom_contour_fill(aes(z = eof), breaks = AnchorBreaks(0, exclude = 0)) +
#   geom_contour_tanaka(aes(z = eof), breaks = AnchorBreaks(0, exclude = 0)) +
#   scale_fill_divergent(guide = "none") +
#   geom_qmap(~.x[lat <= -20]) +  
#   scale_x_longitude() +
#   scale_y_latitude() +
#   coord_polar() +
#   theme(axis.text = element_blank())
```

In the case of cEOF2, the moderate correlation between SAM and Imaginary cEOF2 becomes extremely high only when the zonally asymmetric variability of the SAM is considered.
The Imaginary cEOF2 and the A-SAM share up to `r scales::percent(max_r2[cEOF == "cEOF2"]$estimate^2, 2)` of their variance, reached at `r max_r2[cEOF == "cEOF2"]$lev` hPa (Figure \@ref(fig:sam-eof-vertical).b2).
Such extremely high correlation between the asymmetric SAM and the Imaginary cEOF2 suggests that these might be different ways of characterising the same phenomenon.

<!-- As a further illustration \textcolor{red}{(¿De qué?)}, Figure\ @ref(fig:eof-filtered) shows the spatial pattern of the leading EOF of 200 hPa geopotential height when the variability associated with cEOF2 is removed. The resulting pattern is an nearly zonally symmetrical annular mode. This mode is highly correlated with SAM (`r eof_filtered_cor[term == "full"]$text`), but only with the symmetrical part (`r eof_filtered_cor[term == "sym"]$text`). Note that the usual definition of the PSA modes as the second and third EOFs creates modes orthogonal to the SAM (defined as the first EOF) and thus impedes this kind of filtering.   -->

(ref:fake-eof-cap) Row a: The three components used to create a synthetic dataset of 41 years of geopotential height at 200 hPa. Row b: The three EOF computed from the synthetic dataset with the variance explained by each EOF in parenthesis. Units are arbitrary.

```{r fake_eof}
cEOF2 <- ceof$eof[[1]]$left[cEOF == "cEOF2"] %>% 
  copy() %>% 
  .[, cEOF := NULL] %>% 
  .[]

pattern <- eof_filtered$right %>% 
  .[era5[lev == 200], on = "time"] %>% 
  .[, FitLm(hgt, eof), by = .(lon, lat)] %>% 
  .[, estimate := mean(estimate), by = .(lat, term)] %>%
  dcast(lon + lat ~ term, value.var = "estimate")


set.seed(42)
fake_sam <- eof_filtered$right %>% 
  copy() %>% 
  .[, eof := sample(eof, replace = TRUE)] 

cor_with_eof2 <- fake_sam[cEOF2, on = "time"] %>% 
  sep_ReIm() %>% 
  .[, correlate(eof, hgt), by = part]

fake_sam <- fake_sam %>% 
  setnames("eof", "value") %>% 
  .[, pattern[, .(sam = value*eof), by = .(lon, lat)], by = time]

# fake_sam %>% 
#   .[time %in% unique(time)[1:4]] %>% 
#   ggplot(aes(lon, lat)) +
#   geom_contour_fill(aes(z = sam)) +
#   facet_wrap(~factor(time)) +
#   coord_polar()


fake_eof <- era5 %>% 
  .[sep_ReIm(cEOF2, format = "wide")[, hgt := NULL], on = .NATURAL] %>% 
  .[lev == 200] %>% 
  .[lat <= -20] %>% 
  .[season(time) == "SON"] %>% 
  .[, hgt := hgt - .lm.fit(cbind(1, Imaginary, Real), hgt)$residuals,
    .(lon, lat, lev, season(time))] %>% 
  .[, hgt := Anomaly(hgt), by = .(lat)] %>% 
  fake_sam[., on = .NATURAL] %>% 
  .[, hgt := hgt + sam] %>% 
  .[, eof := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(lon, lat, season(time))] %>% 
  EOF(eof ~ lon + lat | time, n = 1:3, data = ., suffix = "EOF")  
```

```{r fake-eof, fig.cap = "(ref:fake-eof-cap)", fig.width=3.7, fig.height=3.3}
north_thumb <- function(sdev, n){
  sdev <- sdev^2
  delta <- sqrt(2 / n) * sdev
  
  # Separation between each pair of eofs must be 
  # greater than the sum of their errors.
  separation <- abs(diff(sdev))
  separation >  delta[-length(delta)] + delta[-1]
}

separated <- north_thumb(fake_eof$sdev$sd^2, 41)
stopifnot(all(separated))

var <- fake_eof$sdev %>%
  copy() %>% 
    .[, setNames(paste0(EOF, " (", scales::percent(r2), ")"),
                 EOF)]
var <- c(var, setNames(c("SAM", "Imaginary", "Real"), c("SAM", "Imaginary", "Real")))


era5 %>%
  .[sep_ReIm(cEOF2, format = "wide")[, hgt := NULL], on = .NATURAL] %>%
  .[lev == 200] %>%
 
  .[season(time) == "SON"] %>%
  .[, FitLm(hgt, Real, Imaginary), .(lon, lat)] %>%
  rm_intercept() %>%
  .[, .(lon, lat, eof = estimate, EOF = term)] %>%
  rbind(pattern[, .(lon, lat, eof, EOF = "SAM")]) %>%
  rbind(fake_eof$left, use.names = TRUE) %>% 
   .[lat <= -20] %>%
  .[, EOF := factor(EOF, c("SAM", "Imaginary", "Real", paste0("EOF", 1:3)),
                    ordered = TRUE)] %>% 
  .[EOF %in% c("EOF1", "EOF3"), eof := -eof] %>% 
  .[!(EOF %in% c("SAM", "Imaginary", "Real")), eof := eof/sd(eof)] %>% 
  .[EOF %in% c("SAM", "Imaginary", "Real"), eof := eof/sd(eof)] %>% 
  
  # geom_contour_tanaka has problem with the perfectly symemtric SAM
  # adding just a tiny bit of noise solves it. 
  .[EOF == "SAM", eof := eof + rnorm(.N, sd = 1e-5)] %>%
  
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = eof, fill = ..level..), global.breaks = TRUE, 
                    breaks = AnchorBreaks(0, 0.5, exclude = 0)) +
  
  geom_contour_tanaka(aes(z = eof), global.breaks = TRUE, 
                      breaks = AnchorBreaks(0,0.5,  exclude = 0)) +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(), 
                                   limits = c(-4, 4)) +
  geom_qmap(~.x[lat <= -20]) +
  scale_x_longitude() +
    scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  grid_y +
  coord_polar() +
  facet_wrap(~EOF, ncol = 3, labeller = labeller(EOF = var)) +
  axis_labs_smol +
  theme(axis.text = element_blank()) +
  tag_facets("rc")
```

\textcolor{red}{Esta parte creo que quedaría mejor como una subsección, aunque no se me viene rápido a la cabeza el título y la pondría después de la parte de PSA}

To test the hypothesis that a PSA-like feature can appear as statistic contamination of an otherwise zonally symmetrical and uncorrelated SAM, we create a synthetic dataset of `r uniqueN(fake_sam$time)` fields by reconstructing the SON 200 hPa geopotential height field explained by the cEOF2 and adding a perfectly zonally symmetric SAM-like structure with random sign and value sampled with replacement from the real SAM index.
To this synthetic dataset (\textcolor{red}{No me suena mucho la palabra "synthetic", ¿se usa en este contexto?}) we then apply traditional EOF.
By construction this dataset contains two independent components: a zonally symmetric standing oscillation and a PSA-like of varying amplitude and phase (Figure \@ref(fig:fake-eof) row a).
While the former is a standing oscillation which could be represented by a single EOF, the latter is a wave which can change phase, so it needs two EOFs to be represented correctly.
Thus, the full variance of this synthetic dataset can be perfectly explained by three EOFs.

\textcolor{red}{Los titulos de la figura 11 superior se prestan a la confusión, ya que no es exactamente el SAM y no se entiende qué sería "Imaginary" y "Real"}

The three EOFs of the synthetic dataset are shown in Figure \@ref(fig:fake-eof) row b.
The synthetic SAM can be seen in the first EOF while the cEOF2 is explained by the second and third.
However, even though the synthetic SAM is perfectly zonally symmetric by construction, the leading EOF is not.
The EOF decomposition mixes this mode with parts of the the zonally asymmetric cEOF2 pattern, resulting in a pattern pretty similar to the real SAM pattern (\textcolor{red}{REF}).
This happens because, although in this synthetic dataset the zonally symmetrical SAM and the cEOF2 are uncorrelated by construction, the sample correlation is not null \\textcolor{red}{No me quedo 100% clara esta parte, ¿podrías expresarla un poco distinto?}
.
In this particular example, it is `r cor_with_eof2[part == "Real"]$text` with the Real part and `r cor_with_eof2[part == "Imaginary"]$text` with the Imaginary part.
Of note, the three EOFs are well separated according to North's rule of thumb [@north1982].

This suggests that the zonal asymmetries of the SON SAM could very well be mostly a statistical artefact.
Since many surface impacts are mediated by the asymmetric component, as well as the relationship between SAM and ENSO [@campitelli2021], this potential issue could affect the interpretability of many results involving the SAM.
Studies on the relationship between the SAM and PSA-like patterns would be particularly difficult to interpret.

### PSA

(ref:psa-eof2-cap) Correlations between the Real and Imaginary parts of cEOF2 and the PSA1 and PSA2 modes computed as the second and third EOFs of seasonal geopotential height anomalies [following @mo2001] for the 1979 -- 2019 period. 95% confidence intervals in parenthesis. 
Background colour indicates the value of correlation.


```{r psa-eof2, fig.cap = "(ref:psa-eof2-cap)", fig.width=7, fig.height=3, fig.env="figure*"}
psa2 <- psa$left[PC == "PSA2"][season(time) == "SON"]

rotations_psa <- lapply(angles, function(a) {
  cEOF2 %>% 
    copy() %>% 
    .[, hgt := rotate(hgt, a)] %>% 
    .[psa2, on = "time"] %>% 
    .[, cor(value, Re(hgt))] 
}) 

psa_angle <- angles[which.min(unlist(rotations_psa))]

make_numeric <- function(x) {
  x <- strsplit(x, "\ ")
  vapply(x, function(x) as.numeric(x[[1]]), numeric(1))
}

background_palette <- grDevices::colorRampPalette(c(scales::muted("blue"),
                                                    "white",
                                                    scales::muted("red")),
                                                  space = "Lab")

cEOF2[psa_time, on = "time"] %>% 
  .[PC != "SAM"] %>% 
  copy() %>% 
  sep_ReIm() %>% 
  .[, correlate(value, hgt), by = .(PC, part)] %>% 
  dcast(PC ~ part, value.var = "text") %>% 
  kbl2(booktabs = TRUE, caption = "(ref:psa-eof2-cap)") %>%
  column_spec2(2:3, background = spec_color2(make_numeric(.table[[.col]]),
                                             option = background_palette,
                                             scale_from = c(-1, 1)), 
               color = ifelse(abs(make_numeric(.table[[.col]])) > .5, "white", "black")) %>%
  add_header_above(c("", "cEOF2" = 2)) %>%
  kable_classic() 

# cEOF2[psa_time, on = "time"] %>% 
#   .[PC != "SAM"] %>% 
#   copy() %>% 
#   # .[, hgt := rotate(hgt, psa_angle)] %>%
#   sep_ReIm() %>% 
#   ggplot(aes(value, hgt)) +
#   geom_hline(yintercept = 0, size = 0.2, color = "gray50") +
#   geom_vline(xintercept = 0, size = 0.2, color = "gray50") +
#   geom_point() +
#   geom_smooth(method = "lm") +
#   geom_smooth(method = "lm") + 
#   scale_y_continuous("EOF2") +
#   scale_x_continuous("PSA") +
#   facet_grid(part ~ PC) +
#   panel_background +
#   tag_facets("rc")
```

The relationship between PSAs and the modes described from the cEOFs is also studied.
Table \@ref(tab:psa-eof2) shows the correlations between the two PSA indices and the timeseries for Real and Imaginary phase of cEOF2.
As anticipated by Figure \@ref(fig:eof2-regr-gh), there is a strong correlation between PSA1 and Imaginary cEOF2, and between PSA2 and Real cEOF2.
Conversely, there is no relationship between PSA1 and Real cEOF2, and between PSA2 and Imaginary cEOF2.
As a result, cEOF2 represents well both the spatial structure and temporal evolution of the PSA modes, as well as it is possible to make a rather clean association between its two phases and the two PSA modes.
So, It could be concluded that the same particular rotation of cEOF2 that maximises the association between cEOF2 parts and PSA modes, is the one which maximises the relationship between ENSO and Imaginary cEOF2.

The reason the conventional EOF analysis arrives at the same separation than our particular cEOF rotation is probably the fact that not all phases are equal.
\textcolor{red}{No me quedo claro ese "equal", ¿igual de probables/posibles/factibles?}.
To visualize that, Figure \@ref(fig:phase-histogram) shows an histogram that counts the number of SON years in which the cEOF2 was close to each of the four particular phases (positive/negative Real/Imaginary), with the observations for each season marked as rugs on the horizontal axis.
For instance, years with cEOF2 phase within 45º of 0º are nearest the "positive Real" phase.
About two thirds of time cEOF2 has a phase similar to either the negative or positive Imaginary phase.
It could be seen that Imaginary phase is the most common phase and It is also the direction that has the maximum relationship with ENSO.
Therefore, the Imaginary cEOF2 explains more variance than the Real cEOF2 and conventional EOF analysis will tend to separate the two.

(ref:phase-histogram-cap) Histogram of phase distribution of cEOF2 for the 1979 -- 2019 period. Bins are centred at 90º, 0º, -90º, -180º with a binwidth of 90º. \textcolor{red}{Rugs...}

```{r phase-histogram, fig.cap = "(ref:phase-histogram-cap)", fig.width=width_column*.8, fig.height=2.5}
N <- nrow(cut(ceof$eof[[1]], 2)$left)
cut(ceof$eof[[1]], 2)$left %>% 
  .[, arg := Arg(hgt)] %>% 
  .[, w := Mod(hgt)/mean(Mod(hgt))] %>% 
  qwrap(arg = c(-pi, pi) ~  c(-pi - 1/4*pi, pi - 1/4*pi)) %>% 
  ggplot(aes(arg)) +
  geom_histogram(binwidth = 90*pi/180, center = 0, size = 0.2,
                 color = "black", fill = "gray70") +
  annotate("text",
           label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary"),
           color = "black", size = 3,
           y = 0.5, x = c(-pi, -pi/2, 0, pi/2), angle = 90, hjust = 0) +
  geom_rug() +
  scale_y_continuous("Number of years", 
                     sec.axis = sec_axis(~.x/N, 
                                         name = "Proportion of years", 
                                         labels = scales::percent)) +
  scale_x_continuous("Phase", trans = scales::reverse_trans(),
                     breaks = seq(-pi - 1/4*pi, pi - 1/4*pi, by = 45*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The result obtaneid here is similar to the one obtained by @irving2016.
From their Fourier decomposition of reprojected meridional wind fields \textcolor{red}{¿En qué región?}, they show that the phase distribution is bimodal and isolate the PSA pattern from the rest of the PSA-like variability by selecting events that are near the peaks of the distribution (compare our Figure \@ref(fig:phase-histogram) with their Figure 6).

The advantage of our method is that it is much simpler to implement, it provides magnitude and phase naturally, and it facilitates the description of this mode as a propagating wave instead of as standing oscillation.
As a consequence, the cEOF2 offers an alternative way of representing the PSA which has several advantages over using the second and third EOFs.

## Tropical sources

```{r regr_psi}
regr_psi <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), 
    by = .(season, cEOF)] %>%
  .[psi, on = "time", allow.cartesian = TRUE] %>%
  .[season(time) == "SON"] %>%
  .[, FitLm(psi.z, Real, Imaginary, se = TRUE),by = .(lon, lat, lev, cEOF, season)] %>%
  rm_intercept() %>%
  .[, psi.z := Anomaly(estimate), by = .(cEOF, season, lev, lat)] %>%
  .[, c("fx", "fy") := shceof::WaveFlux(.SD, p = 200), by = .(lev, cEOF, season, term)] %>%
  .[, term := factor_ReIm(term)]
```

```{r sst}
sst <- ERSST() %>%
  readRDS() %>% 
  .[season(time) == "SON"] %>%
  normalise_coords() %>%
  .[, w := season_weights(time)] %>% 
  .[, .(t = mean(t*w)), by = .(lon, lat, time = seasonally(time))]
```

```{r regr_sst}
regr_sst <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), 
    by = .(season, cEOF)] %>%
  .[sst, on = "time", allow.cartesian = TRUE] %>%
  .[season(time) == "SON"] %>%
  .[, FitLm(t, Imaginary, Real, se = TRUE), by = .(lon, lat, cEOF, season)] %>%
  rm_intercept() %>%
  .[, term := factor_ReIm(term)]

```

```{r enso_cor}
enso_cor <-  ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part)] %>%
  enso[., on = "time"] %>%
  na.omit() %>%
  .[, correlate(hgt, oni), by = .(cEOF, part)]
```

```{r plot_sst_psi}
plot_sst_psi <- function(which_cEOF, which_lev) {
  sst_gdata <- regr_sst[cEOF == which_cEOF] %>%
    .[lat %between% c(-90, 10)] %>%
    .[, p_val := Pvaluate(estimate, std.error, df, "fdr"), by = .(cEOF, term)] %>%
    .[, var := "SST"]
  
  regr_psi %>%
    .[cEOF == which_cEOF] %>%
    .[lev == which_lev] %>%
    # .[abs(estimate) > 1, estimate := NA] %>%
    .[lat %between% c(-90, 10)] %>%
    .[, p_val := Pvaluate(estimate, std.error, df, "fdr"), by = .(cEOF, term)] %>%
    .[, var := "Streamfunction"] %>%
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate*1e8, fill = ..level..),
                      breaks = AnchorBreaks(exclude = 0)) +
    geom_contour_pval(aes(z = p_val)) +
    geom_streamline(aes(dx = fx, dy = fy), min.L = 3, L = 10, n = 30,
                    size = 0.2, res = 2, nx = 25, ny = 15, 
                    arrow.angle = 14, arrow.length = 0.2) +
    geom_qmap(keep = .015) +
    scale_fill_divergent_discretised("Streamfunction", guide = "none") +
    ggnewscale::new_scale_fill() +
    
    geom_contour_fill(data = sst_gdata,
                      aes(z = estimate, fill = ..level..), breaks = AnchorBreaks(exclude = 0)) +
    geom_contour_pval(data = sst_gdata, aes(z = p_val)) +
    scale_fill_divergent_discretised("SST", guide = guide_colorsteps_bottom(order = 2)) +
    scale_x_longitude() +
    scale_y_latitude() +
    scale_mag(guide = "none") +
    facet_grid(term ~ var) +
    coord_quickmap(ylim = c(NA, 10)) +
    theme(legend.box = "horizontal") +
    axis_labs_smol +
    tag_facets("cr", position = "bl")
}
```

(ref:sst-psi-2-cap) Regression maps of cEOF2 with SST (column a) and streamfunction zonal anomalies (shaded) with their corresponding activity wave flux (vectors) (column b). Areas marked with dots have p-values smaller than 0.05 adjusted for FDR.

```{r sst-psi-2,  fig.cap = "(ref:sst-psi-2-cap)", fig.width = 7, fig.height=4, dependson="plot_sst_psi", fig.env="figure*"}
plot_sst_psi(which_cEOF = "cEOF2", which_lev = 200) +
  scale_fill_divergent_discretised("SST",
                                   limits = c(-1, 1),
                                   guide = guide_colorsteps_bottom(20, order = 2)) 
```

The connections between cEOFs and Tropical sources is also assesed.
Figure \@ref(fig:sst-psi-2) shows the regression maps of Sea Surface Temperatures (SST) and Streamfunction at 200 hPa respectively upon cEOF2. The Imaginary cEOF2 is associated with strong positive SST anomalies on the Central Pacific and negative anomalies over an area across the North of Australia and New Zealand, the South Pacific Convergence Zone (SPCZ) (Figure \@ref(fig:sst-psi-2).a2). This pattern is almost canonically positive ENSO (\textcolor{red}{REF ENSO}) and indeed, the correlation between the Imaginary cEOF2 and the Oceanic Niño Index [@bamston1997] is very high `r enso_cor[cEOF == "cEOF2" & part == "Imaginary"]$text`.
Besides, the Imaginary cEOF2 is associated with strong wave-like streamfunction anomalies emanating from the tropics (Figure \@ref(fig:sst-psi-2).b2). This is consistent with the effect of ENSO on the extratropics: SST anomalies initiate anomalous convection that excites Rossby waves that propagate meridionally towards higher latitudes [@mo2000].

\textcolor{red}{Revisa los labels de la colorbar para la figura 13. Además ojo que solamente sirven para la columna a, faltan los correspondientes a la streamfunction y el vector de referencia para wave flux}

Since the Real cEOF2 represents just a different phase of the same wave train, it would be expected to show a similar forcing pattern to the Imaginary cEOF with a slight translation of its location.
However, Figure \@ref(fig:sst-psi-2).a1 and b1 show that the Real cEOF2 is not associated either with any significant SST nor streamfunction anomalies in the tropics.
The correlation between the Real cEOF2 and ENSO is also not significant (`r enso_cor[cEOF == "cEOF2" & part == "Real"]$text`).
This lack of tropical signal suggests different natures of the different phases of the Real cEOF2 wave train, which has the maximum amplitudes in the surroundings of southern South America.

```{r enso-phase, fig.cap = " ONI plotted against cEOF2 phase for th 1979 -- 2019 period. Years with magnitude of cEOF2 greater or smaller than the 50th percentile are shown as orange circles and green diamomnds respectively. Black line is the fit ONI ~ sin(phase) computed by OLS weighted by the magnitude of cEOF2.", fig.width = width_column, fig.height=3}
gdata <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[cEOF == "cEOF2"] %>% 
  # .[, hgt := Anomaly(hgt)] %>% 
  .[, arg := Arg(hgt)] %>%
  .[, mag := Mod(hgt)] %>%
  .[enso, on = "time"] %>%
  na.omit()
  

cor_enso_mag <- gdata[, correlate(mag, abs(oni))]

cor_enso_spearman <- gdata[, cor.test(mag, abs(oni), method = "spearman")]

cor_enso_mag_outlier <- gdata[oni < 1.5][, correlate(mag, abs(oni))]


cos_model <- gdata %>% 
  .[, lm(oni ~ I(sin(arg)) - 1, weights = mag )]



equation <- latex2exp::TeX(paste0("$\\mathrm{ONI} = ", 
        signif(coef(cos_model)[1], 2), "\\sin{(\\mathrm{phase})}$"),
        output = "text")

gdata %>% 
  ggplot(aes(arg, oni)) +
  geom_hline(yintercept = c(-0.5, 0, 0.5), size = 0.2, color = "gray50") +
  geom_vline(xintercept = 0, size = 0.2, color = "gray50") +
   annotate(shadowtext:::GeomShadowText,
           label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary", "- Real"),
           color = "gray60", bg.colour = "white", bg.r = 0.2,
           size = 3,
           y = -Inf, x = c(-pi, -pi/2, 0, pi/2, pi), angle = 90, hjust = 0) +
  
  geom_smooth(data = ~qwrap(.x, arg = c(-pi, pi) ~ c(-2*pi, 2*pi)),
              method = "lm", aes(weight = mag),
              formula = y ~ I(sin(x)) -1,
              se = FALSE, color = "black", size = 0.5) +
  geom_point(aes(colour = mag >= quantile(mag, 0.5),
                 shape  = mag >= quantile(mag, 0.5)),
             size = 3) +

  scale_color_brewer(NULL, palette = "Dark2",
                     labels = c("TRUE"  = "|EOF2| > 50%",
                                "FALSE" = "|EOF2| < 50%")) +
  scale_shape_manual(NULL, values = c("TRUE" = 20,
                                      "FALSE" = 18),
                     labels = c("TRUE"  = "|EOF2| > 50%",
                                "FALSE" = "|EOF2| < 50%")) +
  scale_y_continuous("ONI") +
  scale_x_continuous("Phase",
                     breaks = seq(-pi, pi, by = 45*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  coord_cartesian(xlim = c(-pi, pi)) +
  labs(subtitle = equation) +
  panel_background
```

To better explore the relationship between tropical forcing and phase of the cEOF2, Figure \@ref(fig:enso-phase) shows the ONI index against the cEOF2 phase for each SON trimester between 1979 and 2019, highlighting years in which the magnitude of cEOF2 is above the median.
In years with positive ONI, the phase of the cEOF2 is mostly around +90º (corresponding with positive imaginary part) and vice versa.
In years with near neutral ENSO, the phase of the cEOF2 is much more variable.
The black line in Figure \@ref(fig:enso-phase) is a sinusoidal fit of the relationship between ONI and cEOF2 phase.
The $r^2$ corresponding to the fit is `r signif(summary(cos_model)$r.squared, 2)`, with p-value `r report_p(coef(summary(cos_model))[4])`, indicating a quasi-sinusoidal relation between these two variables.

\textcolor{red}{¿Qué significa para el fit "weighted by the magnitude of cEOF2"?}

Furthermore, Figure \@ref(fig:enso-phase) suggest that higher amplitude cEOF2 years tend to coincide with stronger ENSO years.
The correlation between the absolute magnitude of the ONI and the magnitude of the cEOF2 is `r cor_enso_mag$text`.
This relationship, however, appears to be driven only by the three years with strongest ENSO events in the period (`r knitr::combine_words(year(gdata[order(-oni)][1:3]$time))`) which also coincide with the three years with strongest cEOF2 magnitude.
If those years are removed, the correlation becomes non-significant (`r cor_enso_mag_outlier$text`).
Furthermore, even when using all the datapoints, the Spearman correlation --which is robust to outliers-- is also non-significant (`r signif(cor_enso_spearman$estimate, 2)`, p-value`r report_p(cor_enso_spearman$p.value)`).
Therefore, the relationship between the magnitude of the cEOF2 train wave and ONI remains uncertain.

\textcolor{red}{Se que la cantidad de años hace bastante limitada la muestra, pero creo que es un resultado a tener en cuenta que en esos eventos muy intensos se alineen. ¿Probaste hacer la correlación con todos los puntos naranjas?}

It could be concluded that the wave train represented by cEOF2 can be both part of the internal variability of the extratropical atmosphere or forced by tropical SSTs.
In the former case, the wave train has little phase preference.
However, when cEOF2 is excited by tropical SST variability, it tends to remain locked to the imaginary phase.
This explains the relative overabundance of years with cEOF2 near positive and negative imaginary phase in Figure \@ref(fig:phase-histogram).

(ref:sst-psi-1-cap) Same as Figure \@ref(fig:sst-psi-2) but for cEOF1.

```{r sst-psi-1, fig.cap = "(ref:sst-psi-1-cap)", fig.width = 7, fig.height=4, dependson="plot_sst_psi", fig.env = "figure*"}
plot_sst_psi(which_cEOF = "cEOF1", which_lev = 200) +
  scale_fill_divergent_discretised("SST",
                                   limits = c(-.3, .3),
                                   guide = guide_colorsteps_bottom(20, order = 2)) 
```

Figure \@ref(fig:sst-psi-1) shows SST and streamfunction regression maps for cEOF1.
Unlike the cEOF2 case, there is no significant pattern of SST anomalies associated with either the Real or Imaginary cEOF1.
Consistently, streamfunction anomalies do not show any tropical influence.
Instead of that, the real and imaginary CEOF1 are associated with zonally wave activity fluxes in the extra-tropics around 60ºS, except for an equatorward flow from the coast of Antarctica around 150ºE in the real component.

## Precipitation

```{r cmap}
cmap <- ReadNetCDF(CMAP(), vars = c(pp = "precip"),
                   subset = list(lat = -90:10)) %>%
  normalise_coords() %>%
  .[, w := season_weights(time)] %>% 
  .[, .(pp = mean(pp*w)), by = .(lon, lat, time = seasonally(time))]
```

```{r regr_pp}
regr_pp <- ceof[, eof[[1]]$left, by = season] %>%
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), 
    by = .(season, cEOF)] %>%
  .[melt(cmap, id.vars = c("lon", "lat", "time")), on = "time", allow.cartesian = TRUE] %>%
  .[season == "SON"] %>%
  .[, FitLm(value, Imaginary, Real, se = TRUE), by = .(lon, lat, cEOF, variable, season)] %>%
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)]
```

```{r add_continents}
continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -13)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))

add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon &
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon &
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>%
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>%
    .[]
}
```

```{r plot_pp}
plot_pp <- function(data, which_cEOF, which_term = c("Real", "Imaginary"), which_continent = NULL) {
  filter_continent <- function(data) {
    if (!is.null(which_continent)) {
      data[continent == which_continent]
    } else {
      data
    }
    
  }
  data %>%
    .[cEOF %in% which_cEOF] %>%
    .[term %in% which_term] %>%
    .[, lev := "sfc"] %>%
    .[lat >= -60] %>%
    add_continent() %>%
    filter_continent() %>%
    # .[abs(estimate) <= 2] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "none"), by = .(lev, cEOF, term)] %>%
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    # geom_raster(aes(fill = estimate)) +
    geom_contour_fill(aes(z = estimate, fill = ..level..), 
                      breaks = AnchorBreaks(exclude = 0)) +
    geom_contour_tanaka(aes(z = estimate), breaks = AnchorBreaks(exclude = 0)) +
    
    # scale_fill_divergent() +
    scale_fill_divergent_discretised(NULL, 
                         # limits = c(-.8, .8),
                         # oob = scales::squish,
                         low = "#8E521C",
                         high = "#00665E",
                         guide = guide_colorsteps_bottom(15)) +
    # scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(15)) +
    geom_contour_pval(aes(z = p.value)) +
    geom_qmap(~.x %>% .[lat %between% c(-60, max(data$lat))] %>% add_continent() %>% filter_continent(),
              keep = 1) +
    
    scale_x_longitude(ticks = 15) +
    scale_y_latitude(ticks = 15) +
    ggh4x::facet_nested(term ~ cEOF) +
    axis_labs_smol +
    tag_facets("cr") +
    coord_quickmap()
}
```

```{r sesa}
sesa <- list(lon = c(300, 315),
             lat = c(-35, -22))
```

(ref:pp-america-cap) Regression of SON mean precipitation anomalies in South America (mm per day, shaded) and (column a) cEOF1 the (row 1) Imaginary and (column 1) Real phase. For the 1979 -- 2018 \textcolor{red}{¿Cambiaste el año o es un typo?} period. Black contours with dots indicate areas with p-value smaller than 0.05 controlling for False Detection Rate.

```{r pp-america, fig.cap = "(ref:pp-america-cap)", fig.width=width_column, fig.height=width_column*1.1}
plot_pp(data = regr_pp, which_cEOF = c("cEOF1", "cEOF2"), which_continent = "america")  +
  scale_fill_divergent_discretised(NULL, 
                         limits = c(-1, 1),
                         # oob = scales::squish,
                         low = "#8E521C",
                         high = "#00665E",
                         guide = guide_colorsteps_bottom(15)) 
  # annotate("rect", xmin = min(sesa$lon), xmax = max(sesa$lon), 
  #          ymin = min(sesa$lat), ymax = max(sesa$lat),
  #          fill = NA, color = "gray50", size = 0.3)
  #          
```

The influence of cEOFs variability in continental rainfall of extra-tropical Southern Hemisphere is also explored.
We focus on South America and Oceania sectors, because there are not relevant signals in Southern Africa (not shown).

```{r sinusoidal-sesa}
gdata <- cmap %>% 
  .[lon %between% sesa$lon  & lat %between% sesa$lat] %>% 
  .[, .(pp = weighted.mean(pp, cos(lat*pi/180))), by = time] %>% 
  .[, pp := Anomaly(pp), by = season(time)] %>% 
  .[ceof$eof[[1]]$left, on  = "time"] %>% 
  .[cEOF == "cEOF2"] %>% 
  .[, arg := Arg(hgt)] %>% 
  .[, mag := Mod(hgt)]

model <- lm(pp ~ I(sin(arg)) + I(cos(arg)) - 1, data = gdata)

fstatistic <- summary(model)$fstatistic
p_value <- pf(fstatistic["value"], fstatistic["numdf"], fstatistic["dendf"], 
        lower.tail = FALSE)
```

Figure \@ref(fig:pp-america) shows regression maps of seasonal precipitation with each cEOF in South America. cEOF1 is associated with slight decreases \textcolor{red}{Revisa como estás expresando toda esta parte (y en el resto del texto), recorda que son regresiones así que no corresponde decir postive/negative sino haces alguna referencia a la variable con las que los estás regresionando.} in precipitation in Southern Brazil and Paraguay, although these are not statistically significant (Fig. \@ref(fig:pp-america) column a). The strongest precipitation regression coefccients are the ones associated with the Imaginary cEOF2. The positive anomalies on Southeastern South America (SESA) and Central Chile, and negative anomalies over South Atlantic Convergence Zone is a well known springtime precipitation signature of ENSO [@cai2020a] and it is also similar to the precipitation anomalies associated with the A-SAM [@campitelli2021].
This is not surprising considering the close relationship between the ONI, the A-SAM index and the Imaginary cEOF2 shown previously, but further consolidates the identification of this mode with the PSA pattern.
On the other hand, the Real cEOF2 is associated with negative precipitation anomalies in a smaller area of SESA.
Resembling the relationship between ONI and the phase of cEOF2 (Fig. \@ref(fig:enso-phase)), there is a cEOF2 phase dependence of the precipitation anomalies in SESA (not shown).
These variable could be related wth a signficant sinusoidal fit that has a coefficient of determination of `r round(summary(model)$r.squared, 2)` (p-value `r report_p(p_value)`).

(ref:pp-oceania-cap) As Figure \@ref(fig:pp-america) but for Oceania.

```{r box_australia}
box_australia <- data.frame(cEOF = "cEOF2", 
                            lon = c(130, 155),
                            lat = c(-40, -15))
```

```{r pp-oceania, fig.cap = "(ref:pp-oceania-cap)", fig.width=width_column, fig.height=width_column*.8}
plot_pp(regr_pp, c("cEOF1", "cEOF2"), which_continent =  "oceania") +
  geom_rect(data = box_australia, aes(xmin = min(lon), xmax = max(lon),
                                      ymin = min(lat), ymax = max(lat)),
            fill = NA, colour = "gray20") 
```

The precipitation anomalies in Oceania associated with cEOF1 are also weak and not statistically significant (Figure \@ref(fig:pp-oceania) column a) whereas EFO2 is associated with large and widespread anomalies. The Real cEOF2 is associated with positive seasonal anomalies in Northern and Eastern Australia, and negative ones over New Zealand, while precipitation anomalies associated with Imaginary cEOF2 are negative over all Eastern Australia. Again, these negative anomalies are similar to the springtime precipitation anomalies observed in relation with the Asymmetric SAM [@campitelli2021] and ENSO [@cai2011].

(ref:australia-pp-phase-cap) Same as Figure \@ref(fig:enso-phase) but for precipitation anomalies averaged between `r knitr::combine_words(LonLabel(box_australia$lon))` and `r knitr::combine_words(LatLabel(box_australia$lat))` (box shown in Figure \@ref(fig:pp-oceania) column b).

```{r australia-pp-phase, fig.cap = "(ref:australia-pp-phase-cap)", fig.width = width_column, fig.height=3}
gdata <- cmap %>% 
  .[lon %between% box_australia$lon  & lat %between% box_australia$lat] %>% 
  .[, .(pp = weighted.mean(pp, cos(lat*pi/180))), by = time] %>% 
  .[, pp := Anomaly(pp), by = season(time)] %>% 
  .[ceof$eof[[1]]$left, on  = "time"] %>% 
  .[cEOF == "cEOF2"] %>% 
  .[, arg := Arg(hgt)] %>% 
  .[, mag := Mod(hgt)]

model <- lm(pp ~ I(sin(arg)) + I(cos(arg)) - 1, data = gdata)
fstatistic <- summary(model)$fstatistic
p_value <- pf(fstatistic["value"], fstatistic["numdf"], fstatistic["dendf"], 
        lower.tail = FALSE)


equation <- latex2exp::TeX(paste0("$\\mathrm{Precipitation} = ", 
        signif(coef(model)[1], 2), "\\sin{(\\mathrm{phase})} + ", 
        signif(coef(model)[2], 2), "\\cos{(\\mathrm{phase})}$"), output = "text")
  
  
gdata %>% 
  ggplot(aes(Arg(hgt), pp)) +
  geom_hline(yintercept = 0, size = 0.2, color = "gray50") +
  geom_vline(xintercept = 0, size = 0.2, color = "gray50") +
  annotate(shadowtext:::GeomShadowText,
           label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary", "- Real"),
           color = "gray60", bg.colour = "white", bg.r = 0.2,
           size = 3,
           y = -Inf, x = c(-pi, -pi/2, 0, pi/2, pi), angle = 90, hjust = 0) +
  
  geom_smooth(data = ~qwrap(.x, arg = c(-pi, pi) ~ c(-2*pi, 2*pi)),
              method = "lm", aes(weight = mag),
              formula = y ~ I(sin(x)) + I(cos(x)) -1,
              se = FALSE, color = "black", size = 0.5, 
              fullrange = TRUE) +
    geom_point(aes(colour = mag >= quantile(mag, 0.5),
                 shape  = mag >= quantile(mag, 0.5)),
             size = 3) +


  # annotate("text", x = 90*pi/180, y = 1, label = equation, parse = TRUE) +
  
  scale_color_brewer(NULL, palette = "Dark2",
                     labels = c("TRUE"  = "|EOF2| > 50%",
                                "FALSE" = "|EOF2| < 50%")) +
  scale_shape_manual(NULL, values = c("TRUE" = 20,
                                      "FALSE" = 18),
                     labels = c("TRUE"  = "|EOF2| > 50%",
                                "FALSE" = "|EOF2| < 50%")) +
  scale_y_continuous("Precipitation anomaly") +
  scale_x_continuous("Phase",
                     breaks = seq(-pi, pi, by = 30*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  coord_cartesian(xlim = c(-pi, pi)) +
  labs(subtitle = equation) +
  panel_background
```

To better understand the relationship between precipitation anomalies over Western Australia and the cEOF2, Figure \@ref(fig:australia-pp-phase) plots precipitation anomalies averaged over Eastern Australia (box in Figure \@ref(fig:pp-oceania)) as a function of cEOF2 phase.
The black line shows a sinusoidal fit, whose coefficients are fitted by weighted least squares using the magnitude of the EFO2 as weight.
The $r^2$ corresponding to the fit is `r signif(summary(model)$r.squared, 2)` (p-value `r report_p(p_value)`).
There is a strong relationship between the phase of the cEOF2 and precipitation anomalies in Eastern Australia, but the Real and Imaginary phases we chose are not exactly aligned with the direction that maximises this relationship.
To perform a more in-depth analysis of the relationship between this pattern and precipitation in this region, it would be recommended to align one of the axis (either the Real or the Imaginary) to the phase that maximises the described relationship.

\textcolor{red}{¿Había alguna razón para poner SA antes que Oceanía? Sino invertiría el orden, porque creo que es más obvio lo que decis en Sudamérica sobre el sinusoidal fit, si mostras antes de lo de Oceanía.}

\textcolor{red}{La formula en la figura trata de escribirla en una forma más precisa "precipitación"/"phase" son muy generales, y también teniendo en cuenta las unidades. También incluilo en el caption.}

(ref:pp-africa-cap) Same as Figure \@ref(fig:pp-america) but for South of Africa.

```{r pp-africa, fig.cap = "(ref:pp-africa-cap)"}
# plot_pp(regr_pp, c("cEOF1", "cEOF2"), which_continent = "africa")
```

# Conclusions

\textcolor{red}{Al igual que en la introducción, te falta establecer más claro el objetivo, después iría lo que escribiste.}

We studied the two leading modes of co-variability of September-October-November tropospheric and stratospheric zonal anomalies by applying complex Empirical Orthogonal Functions.

The first complex EOF represents the variability of the zonal wave 1 in the stratosphere, but represents a more zonally symmetric monopole in the troposphere.
There is a statistically positive trend in the magnitude of this cEOF, which is consistent with previous studies which showed secular changes in springtime wave-1-like patterns [e.g. @raphael2003].
This mode is closely related to anomalies in Total Ozone Column.

THe second complex EOF represents a wave-3 pattern with maximum magnitude in the Pacific sector.
Essentially, it is an alternate representation of the PSA1 and PSA2 patterns [@mo2001].
We show that the Imaginary cEOF2 can be identified with the PSA1 and the Real cEOF2 with the PSA2.
This cEOF prefers a phase aligned with the Imaginary cEOF2.
This is because the when ENSO is active, it forces the cEOF2 to be in the Imaginary phase.
When ENSO is neutral, the cEOF2 is still active, but with no particular phase.
This mirrors the results of @cai2002, who showed that the CSIRO Model can create PSA-like variability even in the absence of ENSO forcing (with a climatological run), but the variability of one of the PSA modes was enhanced when adding the ENSO signal.

We further show that the Imaginary cEOF2 is closely related to the Southern Annular Mode in the troposphere.
In fact, it has a closer resemblance of the zonally asymmetric portion of the SAM.

To the extreme that the leading EOF of geopotential height with the cEOF2 removes results in an annular mode that has none of the typical zonal asymmetries of the observed SAM.\textcolor{red}{No me pareció del todo claro lo que estás queriendo expresar acá}

This raises the possibility that the asymmetric component of the SAM is actually a statistical contamination of the PSA mode.

Precipitation anomalies in South America associated with the Imaginary cEOF2 show a clear ENSO-like impact, with positive anomalies in South-Eastern South America, negative anomalies in Southern Brazil and positive anomalies in central Chile.
Precipitation anomalies associated with the Real cEOF2 are low and not statistically significant, showing that the Imaginary phase is optimally aligned with the direction of maximum precipitation impacts.

On the other hand, over Australia, both the Real and Imaginary phase are associated with significant precipitation anomalies, and we further show that the direction of maximum impact is not aligned with our chosen rotation of cEOF2.
However, this underscore the benefit of using complex EOF, since it would trivial to rotate it.

\textcolor{red}{Debería cerrarse con algún parráfo que diga qué tiene de bueno trabajar con esta metodología y qué permitiría hacer a futuro (se puede poner que sería deseable extenderlo a otras estaciones, etc.)}

## Code availability {.unnumbered}

A version-controlled repository of the code used to create this analysis, including the code used to download the data can be found at <https://github.com/eliocamp/shceof>.

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
