---
classoptions: 
  - sn-basic
year: 2022
title:  "Revisiting the Austral Spring Extratropical Southern Hemisphere zonally asymmetric circulation using complex Empirical Orthogonal Functions"
titlerunning: SH zonally asymmetric circulation with cEOF

authors: 
  - firstname: Elio
    lastname: Campitelli
    email: elio.campitelli@cima.fcen.uba.ar
    affiliation: [1,2,3]
    corresponding: TRUE
  - firstname: Leandro B.
    lastname: Díaz
    affiliation: [1,2,3]
  - firstname: Carolina
    lastname: Vera
    affiliation: [1,2,3]

affiliations:
  - number: 1
    corresponding: TRUE
    info:
      orgname: Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos
    address:
        city: Buenos Aires
        country: Argentina
  - number: 2
    corresponding: TRUE
    info:
      orgname: CONICET – Universidad de Buenos Aires. Centro de Investigaciones del Mar y la Atmósfera (CIMA)
    address:
        city: Buenos Aires
        country: Argentina  
  - number: 3
    corresponding: TRUE
    info:
      orgname: CNRS – IRD – CONICET – UBA. Instituto Franco-Argentino para el Estudio del Clima y sus Impactos (IRL 3351 IFAECI)
    address:
        city: Buenos Aires
        country: Argentina          

 
keywords:
  - Southern Hemisphere circulation
  - Teleconnections
  - Pacific South American Mode
  - Southern Annular Mode
  - Stratosphere

bibliography: 
  - references.bib
  - data.bib
  - packages.bib

# bibstyle: spbasic

output: 
  bookdown::pdf_document2:
      latex_engine: "xelatex"
      keep_tex: true
      citation_package: "natbib"
      template: "template.tex"
      pandoc_args: ["--lua-filter=abstract-to-meta.lua", "--wrap=preserve"]
always_allow_html: true
header-includes: 
 - \usepackage{gensymb}
 - \usepackage{subfig}
 - \usepackage[inline]{showlabels}
 - \usepackage{chngcntr}
 # - \usepackage{natbib}
 # - \usepackage{lineno}
 # - \linenumbers 
---

```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  cache = TRUE,
  comment = "#>",
  cache.extra = 41,
  cache.path = "../cache/paper/",
  fig.path = "../figures/",
  dpi = 300,
  dev = c("pdf", "png")
)

width_column <- 3.3

library(metR)
library(data.table)
library(magrittr)
library(ggplot2)
library(tagger)
library(ggperiodic)
library(kableExtra)
library(shceof)

theme_set(theme_shceof(base_size = 10) +
            theme(legend.box.spacing = grid::unit(-.5, "lines")))

panel_background <- theme(panel.background = element_rect(fill = "#fbfbfb", color = NA), 
                          panel.ontop = FALSE,
                          tagger.panel.tag.background = ggplot2::element_rect(color = NA, 
                                                                              fill = "#fbfbfb"))

grid <- theme(panel.grid = element_line(color = "gray10", size = 0.4, linetype = 3))
no_grid <- theme(panel.grid = element_blank())
grid_y <- theme(panel.grid.major.y = element_line(color = "gray60", size = 0.1))

guide_colorstrip_bottom <- function(width = 15, height = 0.5, 
                                    title.position = "top",...) {
  guide_colorstrip(title.position = title.position, title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}

guide_colorsteps <- function (even.steps = TRUE, show.limits = NULL, ticks = FALSE, 
                              ...) {
  guide <- guide_colourbar(raster = FALSE, ticks = ticks, 
                           nbin = 300, ...)
  guide$even.steps <- even.steps
  guide$show.limits <- show.limits
  class(guide) <- c("colorsteps", class(guide))
  guide
}
guide_colorsteps_bottom <- function(width = 15, height = 0.5, even.steps = FALSE, 
                                    title.position = "top", show.limits = TRUE, ticks = TRUE,
                                    ...) {
  guide_colorsteps(show.limits = show.limits, even.steps = even.steps,
                   title.position = title.position, title.hjust = 0.5,
                   barheight = height, ticks = ticks,
                   ticks.colour = "black",
                   barwidth = width, frame.colour = "black", ...)
}

axis_labs_smol <- theme(axis.text = element_text(size = 6))

pattern_dots <- ggplot2::ggproto("GeomDots", ggpattern::GeomPolygonPattern)
ggplot2::update_geom_defaults(pattern_dots, 
                              list(pattern = "circle",
                                   colour = NA,
                                   pattern_colour = NA,
                                   pattern_fill = "black",
                                   pattern_density = 0.3,
                                   pattern_alpha = 1,
                                   pattern_spacing = 0.02,
                                   fill = NA
                              ))
update_geom_defaults(GeomSmooth, list(colour = "#0d52bf"))

f <- formals(geom_contour_tanaka)
f$range <-  c(0.01, 0.2)
formals(geom_contour_tanaka) <- f

geom_contour_pval <- function(mapping, p.value = 0.01, size = 0.1, ...) {
  mapping2 <- mapping
  mapping2$fill <- aes(fill = NA)$fill
  list(
    stat_contour_filled(mapping2, breaks = c(0, p.value), fill = NA, geom = pattern_dots, ...),
    geom_contour2(mapping, breaks = p.value, size = size, ...)
  )
}

# There's a bunch of issues with s2 right now
sink <- capture.output(sf::sf_use_s2(FALSE))

geom_coords <- function() {
  
  list(
    no_grid,
    annotate("segment",
             y = seq(-90, 0, by = 15),
             yend = seq(-90, 0, by = 15),
             x = 0,
             xend = 360,
             size = 0.1, alpha = 0.5),
    
    annotate("segment",
             x = seq(0, 360 - 30, by = 30),
             xend =  seq(0, 360 - 30, by = 30),
             y = -90 + 15,
             yend = Inf,
             size = 0.1, alpha = 0.5),
    shadowtext::geom_shadowtext(data = data.frame(x = 0, y = seq(-90 + 15, 0, 
                                                                 by = 15)),
                                aes(x, y, label = LatLabel(y)), size = 1.5, 
                                alpha = 0.7,
                                colour = "black",
                                bg.colour = "white")
  )
}

coord_polar <- function(ymax = -20, ...) {
  x <- c(seq(0, 360, length.out = 40), 
         seq(360, 0, length.out = 40), 
         0)
  y <- c(rep(ymax, length.out = 40), 
         rep(60, length.out = 40), 
         ymax)
  
  cbind(x, y) %>% 
    list() %>% 
    sf::st_polygon() %>% 
    sf::st_sfc(crs = "+proj=latlong") -> white
  
  list(
    geom_sf(data = white, inherit.aes = FALSE, 
            fill = "white", 
            colour = "white", size = 2),
    coord_sf(ylim = c(-90, ymax), 
             lims_method = "box",
             crs = "+proj=laea +lat_0=-90",
             default_crs = "+proj=longlat",
             label_axes =  "----", ...)
  )
}

one_less <- function(x) {
  n <- length(x)
  if (n < 4) return(x)
  x <- round(x, 5)
  
  c( rev(JumpBy(rev(x[x < 0]), 2, fill = "")),
     JumpBy(x[x > 0], 2, fill = ""))
}

AnchorBreaks <- function (anchor = 0, binwidth = NULL, exclude = NULL, bins = 10, sym = FALSE) {
  force(anchor)
  force(binwidth)
  force(exclude)
  force(bins)
  force(sym)
  function(x, binwidth2 = NULL) {
    if (sym) {
      length <- max(abs(x - anchor))
      x <- c(anchor - length, anchor + length)
    }
    if (!is.null(binwidth)) 
      binwidth2 <- binwidth
    if (is.null(binwidth2)) {
      binwidth2 <- diff(pretty(x, bins))[1]
    }
    mult <- ceiling((x[1] - anchor)/binwidth2) - 1L
    start <- anchor + mult * binwidth2
    b <- seq(start, x[2] + binwidth2, binwidth2)
    b[!(b %in% exclude)]
  }
}


lab_lev <- AddSuffix(" hPa")
lab_cplx <- c(R = "Real", 
              I = "Imaginary")

combine_lists <- function(...) {
  # browser(expr = length(x) != length(y))
  X <- list(...)
  names <- names(X[[1]])
  names(names) <- names
  lapply(names, function(n) {
    unlist(lapply(X, function(x) x[[n]]))
  })
}

correlation_statistics <- function(x, n, signif = 2) {
  z <- atanh(x)
  se <- 1/sqrt(n - 3)
  
  low <- qnorm(.025, mean = z, sd = se)
  low <- tanh(low)
  hig <- qnorm(.975, mean = z, sd = se)
  hig <- tanh(hig)
  
  p.value <- pnorm(abs(x)/se, lower.tail = FALSE)
  
  text <- paste0(signif(x, signif), " (CI: ",
                 signif(low, signif), " -- ", signif(hig, signif), ")")
  
  list(estimate = x, 
       p.value = p.value, 
       low = low,
       hig = hig,
       text = text
  )
}

r2 <- expression(`$r^2$` = paste("", "r", phantom()^{
  paste("2")
}, "", ""))
```

```{r read-indices}
enso <- ENSO() %>%
  fread() %>% 
  .[, .(time = lubridate::as_datetime(Date), oni = ONI)] %>% 
  na.omit() %>%
  .[season(time) == "SON"] %>%
  .[, oni := oni*season_weights(time)] %>% 
  .[, .(oni = mean(oni)), by = .(time = seasonally(time))]

dmi <- DMI() %>%
  fread() %>% 
  .[, .(time = lubridate::as_datetime(Date), dmi = DMI)] %>% 
  na.omit() %>%
  .[season(time) == "SON"] %>%
  .[, dmi := dmi*season_weights(time)] %>% 
  .[, .(dmi = mean(dmi)), by = .(time = seasonally(time))]

sams <- SAM() %>% 
  fread() %>%
  .[season(time) == "SON"] %>%
  .[, estimate := estimate*season_weights(time)] %>% 
  .[, .(estimate = mean(estimate)),
    by = .(lev, term, time = seasonally(time))]

levs <- unique(sams$lev)

for (l in seq_along(levs)[-1]) {
  cor <- sams[lev %in% levs[seq(l - 1, l)]] %>% 
    .[term == "full"] %>%
    dcast(time ~ lev, value.var = "estimate") %>% 
    setnames(., colnames(.), c("time", "old", "new")) %>% 
    .[, cor(old, new)]
  
  sams[lev == levs[l], estimate := sign(cor)*estimate]
}
```

```{r test-irlba}
x <- "irlba"
has_irlba <- requireNamespace(x, quietly = TRUE)
if (has_irlba) {
  stop("If installed, metR::EOF uses irlba, but that package has a bug with complex matrices\n(see: https://github.com/bwlewis/irlba/issues/55). Uninstall irlba with renv::remove(\"irlba\") and try again.")
}

```

```{r read-data}
era5 <- ERA5_geopotential() %>% 
  ReadNetCDF(vars = c(hgt = "z"),
             subset = list(level = list(200, 50),
                           latitude = -90:10)) %>% 
  normalise_coords() %>% 
  .[season(time) == "SON"] %>%
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))]
```

```{r compute-psi}
# Scaling magical numbers. (come from psi-test.Rmd)
# Not really important, though.
scaling <- c(add = -2.364646e+06, mult = 3.954828e+13)
psi <- ERA5_vorticity() %>% 
  ReadNetCDF(vars = "vo") %>%
  normalise_coords() %>%
  .[, lev := 200] %>% 
  .[season(time) == "SON"] %>%
  .[, w := season_weights(time)] %>% 
  .[, .(vo = mean(vo*w)), by = .(lon, lat, lev, time = seasonally(time))] %>%
  .[, solve_poisson(vo, lon, lat), by = .(lev, time)] %>%
  setnames("value", "psi") %>% 
  .[, psi := psi*scaling[2] + scaling[1]] %>%
  .[, psi.z := Anomaly(psi), by = .(time, lev, lat)] 
```

```{r o3}
o3 <- ERA5_TOC() %>% 
  ReadNetCDF(vars = c(toc = "tco3")) %>% 
  normalise_coords() %>% 
  .[lat <= -20] %>% 
  .[, toc := toc/2.1415e-5] %>%    # transform to Dobson Units (https://sacs.aeronomie.be/info/dobson.php)
  .[, w := season_weights(time)] %>% 
  .[, .(toc = mean(toc*w)), by = .(lon, lat, time = seasonally(time))]

o3wave_lats <- c(-75, -45)
```

```{r psa}
psa <- ERA5_geopotential() %>% 
  ReadNetCDF(vars = c(hgt = "z"),
             subset = list(level = list(500),
                           latitude = -90:0)) %>% 
  normalise_coords() %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lon, lat, time = seasonally(time))] %>% 
  .[, value := Anomaly(hgt)*sqrt(cos(lat*pi/180)), 
    by = .(lon, lat, season(time))] %>%
  EOF(value ~ time | lon + lat, n = 1:3, data = .)

psa <- lapply(psa, function(x) {
  copy(x)[, PC := fcase(PC == "PC1", "SAM", 
                        PC == "PC2", "PSA1", 
                        PC == "PC3", "PSA2")] 
})

psa_time <- psa$left[season(time) == "SON"]
```

# Abstract 

The large-scale extratropical circulation in the Southern Hemisphere is strongly zonally symmetric, but its zonal departures, albeit highly relevant for regional impacts, have been less studied.
In this study we analyse the joint variability of the zonally asymmetric springtime stratospheric and tropospheric circulation using Complex Empirical Orthogonal Functions (cEOF) to characterise planetary waves of varying amplitude and phase.
The leading cEOF represents variability of a zonal wave 1 in the stratosphere that correlates slightly with the Symmetric Southern Annular Mode (S-SAM).
The second cEOF (cEOF2) is an alternative representation of the Pacific-South American modes. 
One phase of this cEOF is also extremely correlated with the Asymmetric SAM (A-SAM) in the troposphere. 
Springs with an active ENSO tend to phase-lock the cEOF2, but have no consistent impact on its magnitude.
Furthermore, we find indications that the location of Pacific Sea Surface Temperature anomalies affect the phase of the cEOF2. 
As a result, the methodology proposed in this study provides a deeper understanding of the zonally asymmetric springtime extratropical SH circulation.

# Introduction

The large-scale extratropical circulation in the Southern Hemisphere (SH) is strongly zonally symmetric, but its zonal departures are highly relevant for regional impacts [e.g. @hoskins2005].
They strongly modulate weather systems and regional climate through promoting longitudinally different latitudinal transport of heat, humidity, and momentum [@trenberth1980a; @raphael2007] and could even be related to the occurrence of high-impact climate extremes [@pezza2012].

Zonally asymmetric circulation is typically described by the amplitude and phase of zonal waves obtained by Fourier decomposition of geopotential heights or sea-level pressures at each latitude [e.g. @vanloon1972; @trenberth1980a; @turner2017].
This approach suggests that zonal waves 1 and 3 explain almost 99% of the total variance in the annual mean 500-hPa pattern at 50ºS [@vanloon1972].
@trenberth1985 concluded that wave 3 plays a role in the development of blocking events.
In addition, previous works have identified at extratropical and subpolar latitudes, wave-like patterns with dominant wavenumbers 3-4, also exerting distinctive regional impacts.
@raphael2007 shows that variability in the planetary wave 3 projected onto its climatological location is associated with anomalies in the Antarctic sea-ice concentration.

The Fourier decomposition relies on the assumption that the circulation can be meaningfully described in terms of zonal waves of constant amplitude along a latitude circle.
However, this is not valid for meridionally propagating waves or zonal waves with localised amplitudes.
Addressing this limitation, the Fourier technique can be generalized to integrate all planetary wave amplitude regardless of wave number, by computing the wave envelope [@irving2015].
The latter makes it possible to represent planetary waves with different amplitude at different longitudes, but it removes all information about phase and wave number.
With this approach, @irving2015 showed that planetary wave amplitude in general is associated to Antarctic sea-ice concentration and temperature, as well as to precipitation anomalies in regions of significant topography in SH mid-latitudes and Antarctica.

Another extensively used approach to characterise the SH tropospheric circulation anomalies, is by computing Empirical Orthogonal Functions (EOF, also known as Principal Component Analysis).
Within the EOF framework, the Southern Annular Mode (SAM) appears as the leading mode of variability of the SH circulation [@fogt2020].
SAM represents a relatively zonally symmetric pattern of alternating low pressures in polar latitude and a ring of high pressures in high latitudes with an embedded wave 3 pattern that is more prominent in the Pacific sector.
The 2nd and 3rd EOFs, usually known as Pacific--South American Patterns (PSA) 1 and PSA2 patterns, respectively, describe meridionally propagating wave trains that originate in the eastern equatorial Pacific and Australian-Indian Ocean sector, and travel towards the South Atlantic following a great-circle arch along the Antarctic coast [@mo2001].
These patterns influence precipitation anomalies in South America [@mo2001].
Although these patterns are usually derived by applying EOF to temporal anomalies, @raphael2003 also applied EOF methods specifically to zonal anomalies.
@irving2016 proposed a novel methodology for objectively identifying the PSA pattern using Fourier decomposition. 
More recently @goyal2022 created an index of amplitude and phase of zonal wave 3-like variability by combining the two leading EOFs of meridional wind anomalies. 

Some of the zonally asymmetric patterns of the SH circulation variability described previously, appear to have experienced secular changes.
For instance, @raphael2003 found that the amplitude of the zonal wave 1 experienced a large increase and that the zonal wave 3 experienced changes in its annual cycle between 1958 and 1996.
However, little is known yet about variability and trends of these patterns.

Patterns resulting from EOF analyses are more flexible than Fourier decomposition derived modes in the sense that they can capture oscillation patterns that cannot be characterised by purely sinusoidal waves with constant amplitude.
Nonetheless, they are restricted to standing oscillation modes and could not properly represent propagating or phase-varying features such as zonal waves.
A single EOF can also represent a mixture of two or more physical modes.

A third methodology commonly used to describe circulation anomalies consists on identifying particular features of interest and creating indices using simple methods such as averages and differences.
Examples of this methodology are the SAM Index of @gong1999, the SH wave 3 activity index defined by @raphael2004 and the SH zonally asymmetric circulation index from @hobbs2010.
These derived methods are grounded on other methods such as Fourier decomposition or EOF to identify the centres of action for the described phenomena and can be useful to characterise features that are not readily apparent with these methods.
It is commonly easy the computation of these kind of indices, but they could be unable to capture non-stationary patterns.

An alternative methodology that has been proposed to study travelling and standing waves is complex Empirical Orthogonal Functions [cEOF; @horel1984].
This method extends EOF analysis to capture oscillations with varying amplitude and phase and has been applied to the time domain.
For instance, @krokhin2007 applied cEOF to station-based monthly precipitation anomalies and monthly temperature anomalies in the Eastern Siberia and the Far East region to characterise the main modes of variability and their connection to teleconnection indices.
Similarly, @gelbrecht2018 used cEOF applied to daily precipitation from reanalysis to study the propagating characteristics of the South American Monsoon.
To our knowledge, cEOF analysis has not been applied in the spatial domain to capture the phase-varying nature of planetary waves in the atmosphere.

The general goal of this study is to improve the description and understanding of the zonally asymmetric extratropical SH circulation using cEOF, which allow to describe phase varying planetary waves with variable amplitudes along a latitude circle.
In addition, it is proposed to expand the knowledge of the simultaneous behaviour of SH asymmetric circulation in the troposphere and the stratosphere.

We restrict this paper to the spring September-October-November (SON) trimester because this season experiences a maximum in tropical teleconnections over South America [@cazes-boezio2003] and SH stratosphere-troposphere interactions [@lim2018].

In Section\ \@ref(methods) we describe the methods.
In Section\ \@ref(spatial) we analyse the spatial patterns of each complex EOF.
In Section\ \@ref(regressions) we study the spatial regressions with geopotential height, temperature and ozone anomalies.
In Section\ \@ref(psa) and \@ref(sam) we analyse the relationship between cEOF2 the PSA and SAM modes.
In Section\ \@ref(tropical) we study tropical forcings that explain the variability of each cEOF.
In Section\ \@ref(precipitation) we show the relationship between these modes of variability and precipitation and surface temperature anomalies in South America and Oceania.
In Section\ \@ref(discussion) we compare our results with previous studies and discuss the benefits of our methodology.

# Data and Methods {#methods}

## Data

We used monthly geopotential height, air temperature, ozone mixing ratio, and total ozone column (TOC) at 2.5\degree longitude by 2.5\degree latitude of horizontal resolution and 37 vertical isobaric levels from the European Centre for Medium-Range Weather Forecasts Reanalysis version 5 [ERA; @era5] for the period 1979 -- 2019.
Most of our analysis is restricted to the post-satellite era to avoid any confounding factors arising from the incorporation of satellite observations, but we also used the preliminary back extension of ERA5 from 1950 to 1978 [@era5be] to describe long-term trends.
We derived streamfunction at 200 hPa from ERA5 vorticity using the FORTRAN subroutine FISHPACK [@fishpack] and we computed horizontal wave activity fluxes following @plumb1985.
Sea Surface Temperature (SST) monthly fields are from Extended Reconstructed Sea Surface Temperature (ERSST) v5 [@huang2017] and precipitation monthly data from the CPC Merged Analysis of Precipitation [@cmap], with a 2\degree and 2.5\degree horizontal resolution respectively.
The rainfall gridded dataset is based on information from different sources such as rain gauge observations, satellite inferred estimations and the NCEP-NCAR reanalysis, and it is available since 1979 to the present.

The Oceanic Niño Index [ONI, @bamston1997] comes from NOAA's Climate Prediction Center and the Dipole Mode Index [DMI, @saji2003] from Global Climate Observing System Working Group on Surface Pressure.

## Methods

The study is restricted to the spring season, defined as the September-October-November (SON) trimester.
We compute seasonal means for the different variables, averaging monthly values weighted by the number of days in each month.
We use the 200 hPa level to represent the high troposphere and 50 hPa to represent the lower stratosphere.

The amplitude of the zonal waves was obtained through the Fourier transform of the spatial field at each latitude circle.
For the analysis of wave 1, we computed its amplitude and phase by averaging (area-weighted) the data for each variable and each SON between `r knitr::combine_words(LatLabel(o3wave_lats))`, and then extracting the wave-1 component of the Fourier spectrum.
We chose this latitude band because it is wide enough to capture most of the relevant anomalies of SH mid-latitudes.

We computed the level-dependent SAM index as the leading EOF of year-round monthly geopotential height anomalies south of 20ºS at each level for the whole period [@baldwin2009].
We further split the SAM into its zonally symmetric and zonally asymmetric components (S-SAM and A-SAM indices respectively).
These indices were obtained by projecting the zonally asymmetric and zonally symmetric part of the SAM spatial pattern onto monthly geopotential height fields, as proposed by @campitelli2022.
Seasonal indices of the PSA patterns (PSA1 and PSA2) were calculated, in agreement with @mo2001, as the third and fourth leading EOF of seasonal mean anomalies for 500-hPa geopotential heights at SH.

Linear trends were computed by Ordinary Least Squares (OLS) and the 95% confidence interval was computed assuming a t-distribution with the appropriate residual degrees of freedom [@wilks2011].

## Complex Empirical Orthogonal Functions (cEOF)

(ref:eof-naive-cap) Spatial patterns of the four leading EOFs of SON zonal anomalies of geopotential height at 50 hPa south of 20\degree S for the 1979 -- 2019 period (arbitrary units).

```{r compute-eof-naive}
eof_naive <- era5[lev %in% c(50, 200) & lat %between% c(-90, -20)] %>% 
  # .[, hgt := Anomaly(hgt), by = .(season(time), lon, lat, lev)] %>%
  .[, hgt  := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(time, lev, lat)] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1:4, data = .SD, suffix = "EOF"))), 
    by = lev]

explained <- eof_naive[, eof[[1]]$sdev, by = lev] %>% 
  .[order(lev, EOF)] %>% 
  .[, scales::percent(r2, accuracy = .1)]

```

```{r eof-naive, fig.cap = "(ref:eof-naive-cap)", fig.width=width_column, fig.height=width_column*1.2}
eof_naive[, eof[[1]]$right, by = lev] %>%
  .[lev == 50] %>% 
  .[ , hgt := hgt/sd(hgt)] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = hgt, fill = ..level..),
                    breaks = AnchorBreaks(0, 1, exclude = 0)) +
  geom_contour_tanaka(aes(z = hgt), breaks = AnchorBreaks(0, 1, exclude = 0), 
                      range = c(0.01, 0.2)) +
  
  geom_qmap(size = 0.1) +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(10))  +
  scale_y_latitude(labels = NULL,
                   minor_breaks = NULL, 
                   limits = c(NA, -20)) +
  scale_x_longitude() +
  geom_coords() +
  coord_polar() +
  theme(axis.text = element_blank(), 
        legend.box.spacing = grid::unit(-1, "lines")) +
  facet_wrap(.~EOF, ncol = 2)  +
  tagger::tag_facets("rc")

```

In the standard EOF analysis, zonal waves may appear as pairs of (possibly degenerated) EOFs representing similar patterns but shifted in phase [@horel1984].
Figure \@ref(fig:eof-naive) shows the four leading EOFs of SON geopotential height zonal anomalies at 50 hPa south of 20\degree S.
It is clear that the first two EOFs represent a single phase-varying zonal wave 1 pattern and the last two represent a similarly phase-varying pattern with shorter wavenumber and four centres of action shifted by 1/4 wavelength.
A similar EOF structure can be seen in 200 hPa (not shown).
Since each pair of EOFs seems to represent the same phase-varying structure, it would be desirable to combine them into a single pattern described by amplitude and phase.

Complex Empirical Orthogonal Functions (cEOF) are a useful method for characterising zonal waves, associated with phase-varying structures [@horel1984].
This method involves computing EOF on the analytic representation of the original field.
That representation is a complex field in which the real part is the original data and the imaginary part is the original data shifted by 90\degree at each spectral frequency -- i.e. its Hilbert transform.
The Hilbert transform is usually understood in terms of time-varying signal.
However, in this work we apply the Hilbert transform at each latitude circle and at each considered time.
Since each latitude circle is a periodic domain, this procedure does not suffer from edge effects.

The result of the cEOF methodology is a set of complex spatial patterns and complex time series.
The real and imaginary part of each spatial pattern represent the two phases of wave-like spatial patterns that are in quadrature.
The magnitude and argument of each complex time series represent the amplitude and phase of each zonal wave.

```{r compute-ceof}
invisible(
  ERA5_geopotential() %>% 
    ReadNetCDF(vars = c(hgt = "z"),
               subset = list(latitude = -90:10,
                             level = list(200, 50))) %>%
    normalise_coords() %>%
    .[season(time) == "SON"] %>%
    .[, w := season_weights(time)] %>% 
    .[, .(hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))] %>%
    .[, season := season(time)] %>%
    {
      ceof <<- .[, .(eof = list(compute_ceof(.SD))), by = .(season)]
      ceof_splitted <<-  .[, levs := lev] %>%
        .[, .(eof = list(compute_ceof(.SD, n = 1:3))), by = .(season, levs)]
      
    }
)
```

(ref:corr-ceof-splitted-cap) Coefficient of determination ($R^2$) between the absolute magnitude of complex EOFs computed separately at 200 hPa and 50 hPa (p-values lower than 0.01 in bold).

```{r corr-ceof-splitted}
table <- ceof_splitted[, eof[[1]]$left, by = .(lev = levs)] %>%
  copy() %>%
  .[, mag  := abs(hgt)] %>%
  .[, item := paste(lev, cEOF, sep = "_")]

n <- uniqueN(table$time)

table2 <- table %>%
  widyr::pairwise_cor(item, time, mag) %>% 
  setDT() %>%
  .[, p.value := correlation_statistics(correlation, n)$p.value] %>% 
  .[tstrsplit(item1, "_")[[1]] != tstrsplit(item2, "_")[[1]], ] %>%
  .[tstrsplit(item1, "_")[[1]] != 50] %>%
  .[, item1 := tstrsplit(item1, "_")[[2]]] %>%
  .[, item2 := tstrsplit(item2, "_")[[2]]] %>%
  .[, r2 := round(correlation^2, 2)] 

pval <- table2 %>% 
  dcast(item1 ~ item2, value.var = c("p.value"))

table2 %>% 
  dcast(item1 ~ item2, value.var = c("r2")) %>% 
  setnames("item1", "200 hPa") %>%
  kbl2(booktabs = TRUE, caption = "(ref:corr-ceof-splitted-cap)") %>%
  column_spec2(2:4, bold = pval[[.col]] < 0.01) %>%
  add_header_above(c("", "50 hPa" = 3)) %>%
  kable_classic() 
```

The cEOF methodology is applied to SON geopotential height zonal anomalies south of 20\degree S separately at 50 and 200 hPa.
Table \@ref(tab:corr-ceof-splitted) shows the coefficient of determination between time series of the amplitude of each cEOF across levels.
There is a high degree of correlation between the magnitude of the respective cEOF1 and cEOF2 at each level.
The spatial patterns of the 50 hPa and 200 hPa cEOFs are also similar (not shown).

Both the spatial pattern similarity and the high temporal correlation of cEOFs computed at 50 hPa and 200 hPa suggest that these are, to a large extent, modes of joint variability.
This motivates the decision of performing complex EOF jointly between levels.
Therefore cEOFs were computed using data from both levels at the same time.
In that sense each cEOF has a spatial component that depends on longitude, latitude and level, and a temporal component that depends only on time.

The phase of cEOFs is defined up to an additive constant.
For real EOFs, this constant can be either 0 or $\pi$, corresponding to a change in sign.
For cEOFs, it can be any real number between 0 and $2\pi$ [@horel1984], corresponding to rotations in the complex plane.
Since any choice is arbitrary and equally valid, we chose the phase of each cEOF so that the real or imaginary parts are aligned with meaningful phases in our analysis.
This procedure does not create spurious correlations, it only takes an existing relationship and aligns it with a specific phase.

Preliminary analysis showed that the first cEOF was closely related to the zonal wave 1 of Total Ozone Column and the second cEOF was closely related to ENSO.
Therefore, to aid in the interpretation we chose the phase of cEOF1 so that the time series corresponding to the real part has the maximum correlation with the zonal wave 1 of Total Ozone Column between `r knitr::combine_words(LatLabel(o3wave_lats))`.
Similarly, we chose the phase of cEOF2 so that the coefficient of determination between the Oceanic Niño Index [@bamston1997] and the real part is minimised, which also nearly maximises the correlation with the imaginary part.

```{r rotate_eofs}
rotate <- function(z, angle = 0) {
  complex(real = cos(angle), imaginary = sin(angle)) * z
}

angles <- seq(-pi, pi, by = .5*pi/180)

# rotations_cEOF1 <- lapply(angles, function(a) {
#   ceof$eof[[1]]$left[cEOF == "cEOF1"] %>%
#     copy() %>%
#     .[, hgt := rotate(hgt, a)] %>%
#     sep_ReIm() %>%
#     .[, .(mean = mean(hgt)), by = part] %>%
#     .[, rotation := a]
# }) %>%
#   rbindlist()
# 
# 
# best_rotation_cEOF1 <- rotations_cEOF1[part == "Real"][which.min(mean)]$rotation

wave1_o3 <- o3 %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(toc = weighted.mean(toc, w = cos(lat*pi/180), na.rm = TRUE)), by = .(time, lon)] %>% 
  .[, FitWave(toc, 1), by = .(time)] 

with_o3 <- ceof$eof[[1]]$left %>% 
  .[cEOF == "cEOF1"] %>% 
  .[wave1_o3, on = "time"]

rotations_o3 <- lapply(angles, function(a) {
  with_o3 %>% 
    copy() %>% 
    .[, hgt := rotate(hgt, a)] %>% 
    na.omit() %>% 
    sep_ReIm() %>% 
    .[, .(cor = cor(amplitude, hgt)), by = part] %>% 
    .[, rotation := a]
}) %>% 
  rbindlist()

best_rotation_cEOF1 <- rotations_o3[part == "Real"][which.max(cor)]$rotation

with_enso <-  cut(ceof$eof[[1]], 2)$left %>%
  copy() %>%
  .[enso, on = "time"] %>% 
  na.omit() 

rotations_cEOF2 <- lapply(angles, function(a) {
  with_enso %>%
    .[, hgt2 := rotate(hgt, a)] %>%
    .[, .(R = cor(Re(hgt2), oni),
          I = cor(Im(hgt2), oni))] %>%
    .[, rotation := a]
}) %>%
  rbindlist()

best_rotation_cEOF2 <- rotations_cEOF2[I > 0][which.min(abs(R))]$rotation

eof_rotated_left <- ceof$eof[[1]]$left %>%
  copy() %>%
  .[cEOF == "cEOF2", hgt := rotate(hgt, best_rotation_cEOF2)] %>%
  .[cEOF == "cEOF1", hgt := rotate(hgt, best_rotation_cEOF1)]

eof_rotated_right <-  ceof$eof[[1]]$right %>%
  copy() %>%
  .[cEOF == "cEOF2", hgt := rotate(hgt, best_rotation_cEOF2)] %>%
  .[cEOF == "cEOF1", hgt := rotate(hgt, best_rotation_cEOF1)]

ceof_unrotated <- copy(ceof)

ceof$eof[[1]]$left <- eof_rotated_left
ceof$eof[[1]]$right <- eof_rotated_right

ceof <- rbindlist(list(rotated = ceof,
                       unrotated = ceof_unrotated),
                  idcol = "rotation")

rotated <- function(x) x[rotation == "rotated"]
unrotated <- function(x) x[rotation == "unrotated"]
```

```{r check-rotation}
# Check that rotated and unrotated eofs
# predict the same fields (up to floating point errors)
bad_cells <- ceof[, predict(eof[[1]]), by = rotation] %>%
  .[, hgt := as.numeric(Re(hgt))] %>%
  dcast(time + lon + lat + lev ~ rotation, value.var = "hgt") %>%
  .[, dif := rotated - unrotated] %>%
  .[abs(rotated - unrotated)  > 1e-10]

if (nrow(bad_cells) != 0) {
  stop("Rotated and unrotated eofs are not equivalent!")
}

ceof <- ceof[rotation == "rotated"][, rotation := NULL][]
```

While we compute these complex principal components using data from 1979 to 2019, we extended the complex time series back to the 1950 -- 1978 period by projecting monthly geopotential height zonal anomalies standardised by level south of 20ºS onto the corresponding spatial patterns.

We performed linear regressions to quantify the association between the cEOFs and other variables (e.g. geopotential height, temperature, precipitation, and others).
For each cEOF, we computed regression maps by fitting a multiple linear model involving both the real and the imaginary part.
To obtain the linear coefficients of a variable $X$ with the imaginary and real parts of each cEOF we fit the equation

$$
X(\lambda, \phi, t) = \alpha(\lambda, \phi) \operatorname{Im}(\mathrm{cEOF}) + \beta(\lambda, \phi) \mathrm{Re}(\mathrm{cEOF}) + X_0(\lambda, \phi) + \epsilon(\lambda, \phi, t)
$$

where $\lambda$ and $\phi$ are the longitude and latitude, $t$ is the time, $\alpha$ and $\beta$ are the linear regression coefficients for imaginary and real parts respectively, $X_0$ and $\epsilon$ are the constant and error terms respectively.

We evaluated statistical significance using a two-sided t-test and, in the case of regression maps, p-values were adjusted by controlling for the False Discovery Rate [@benjamini1995; @wilks2016] to avoid misleading results from the high number of regressions [@walker1914; @katz1991].

## Computation procedures

We performed all analysis in this paper using the R programming language [@rcoreteam2020], using data.table [@dowle2020] and metR [@campitelli2020] packages.
All graphics are made using ggplot2 [@wickham2009].
We downloaded data from reanalysis using the ecmwfr package [@hufkens2020] and indices of ENSO and Indian Ocean Dipole (IOD) with the rsoi package [@albers2020].
The paper was rendered using knitr and rmarkdown [@xie2015; @allaire2020].

```{r}
# Hacer citas automáticamente. Manejarlo manual con zotero en una colección 
# global no sirve porque pueden cambiar las versiones.

# knitr::write_bib(c("data.table",
#                    "base",
#                    "metR",
#                    "ggplot",
#                    "ecmwfr",
#                    "rsoi",
#                    "knitr",
#                    "rmarkdown"), file = "autopackages.bib")
```

# Results

## cEOF spatial patterns {#spatial}

```{r ceofs-1, fig.cap = "Spatial patterns for the two leading cEOFs of SON zonal anomalies of geopotential height at 50 hPa and 200 hPa for the 1979 -- 2019 period. The shading (contours) corresponds to real (imaginary) part. Arbitrary units. The proportion of variance explained for each mode with respect to the zonal mean is indicated in parenthesis.", fig.width=width_column, fig.height=width_column*1.2}
gdata <- ceof[, eof[[1]]$right, by = .(season)] %>% 
  copy() %>% 
  .[, hgt := hgt/sd(abs(hgt))]

var <- ceof[, eof[[1]]$sdev, by = .(season)] %>%
  .[, setNames(paste0(cEOF, " (", scales::percent(r2), ")"),
               cEOF)]

gdata %>%
  ggperiodic::periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  
  geom_contour_fill(aes(z = Re(hgt), fill = ..level..),
                    breaks = AnchorBreaks(0, 1, exclude = 0)) +
  geom_contour2(aes(z = Im(hgt),  linetype = factor(sign(..level..))),
                breaks = AnchorBreaks(0, 1, exclude = 0)) +
  
  scale_fill_divergent_discretised(guide = guide_colorsteps_bottom()) +
  geom_qmap() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  scale_linetype_manual(values = c("1" = 1, "-1" = 2),
                        labels = c("1" = "+", "-1" = "-"),
                        guide = "none") +
  facet_grid( lev  ~  cEOF,
              labeller = labeller(lev = lab_lev,
                                  cEOF = var)) +
  theme(legend.title = element_blank()) +
  geom_coords() +
  coord_polar() +
  
  tag_facets(tag = "cr")

```

```{r era_more}
pattern <- ceof$eof[[1]]$right %>%
  sep_ReIm() %>%
  setnames("hgt", "EOF")

era_more <- rbind( 
  ReadNetCDF(ERA5_BE(), vars = c(hgt = "z"),
             subset = list(latitude = range(pattern$lat),
                           level = list(200, 50))),
  ReadNetCDF(ERA5_geopotential(), vars = c(hgt = "z"),
             subset = list(latitude = range(pattern$lat),
                           level = list(200, 50)))) %>%
  normalise_coords() %>%
  .[season(time) == "SON"] %>%
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))] %>%
  .[, season := season(time)] %>%
  .[, hgt := hgt/sd(hgt), by = .(lev)] %>%
  .[pattern, on = .NATURAL, allow.cartesian = TRUE] %>%
  .[, .(hgt = weighted.mean(hgt*EOF, w = cos(lat*pi/180))),  by = .(part, cEOF, time)] 

```

(ref:extended-series-cap) Time series of the two leading cEOFs of SON zonal anomalies of geopotential height at 50 hPa and 200 hPa. cEOF1 (row a) and cEOF2 (row b) separated in their real (column 1) and imaginary (column 2) components. Dark straight line is the linear trend. Black horizontal and vertical line mark the mean value and range of each time series, respectively.

```{r extended-series, fig.cap = "(ref:extended-series-cap)", fig.height=3, fig.width = 5, fig.env = "figure*"}
# Check that the extended index coincides with the
# original index.
cors <- era_more %>%
  .[sep_ReIm(ceof$eof[[1]]$left), on = c("time", "cEOF", "part")] %>%
  na.omit() %>%
  .[, cor(hgt, i.hgt), by = .(cEOF, part)]

if (any(cors$V1 < 0.98)) {
  stop("Extended indices didn't work!")
}

trends <- era_more %>%
  .[, FitLm(hgt, time, se = TRUE), by = .(part, cEOF)] %>%
  rm_intercept() %>%
  .[, p_val := Pvaluate(estimate, std.error, df)] %>%
  .[, p_report := report_p(p_val)]

# era_less <-   ceof %>%
#   .[, eof[[1]]$left, by = season] %>%
#   sep_ReIm(hgt) %>%
#   .[season == "SON"] %>% 
#   .[, hgt := as.numeric(scale(hgt)), by = .(part, cEOF)] 

era_more %>%
  copy() %>% 
  .[, ref := year(time) > 1979] %>% 
  # .[, hgt := scale(hgt, center = FALSE, scale = sd(hgt[ref])), by = .(part, cEOF)] %>%
  ggplot(aes(time, hgt*1e3)) +
  # Zero line + rangeframe
  geom_hline(data = ~.x[, mean(hgt)*1e3, by  = .(cEOF, part)], 
             aes(yintercept = V1), size = 0.2, color = "gray30") +
  geom_segment(data = ~.x[, .(min = min(hgt)*1e3,
                              max = max(hgt)*1e3), by  = .(cEOF, part)],
               aes(x = structure(Inf, class = "Date"),
                   xend = structure(Inf, class = "Date"),
                   y = min,
                   yend = max), size = 0.2, color = "gray30") +
  geom_line(aes(color = part)) +
  geom_point(aes(color = part), size = 0.25) +
  # geom_line(data = era_less) +
  scale_alpha_manual(values = c(1, 0.2)) +
  geom_smooth(method = "lm", aes(color = stage(part, after_scale = scales::muted(color))),
              show.legend = FALSE, size = 0.8) +
  scale_x_date(NULL, 
               breaks = seq(as.Date("1950-01-01"),
                            as.Date("2020-01-01"), by = "10 years"),
               labels = function(x) JumpBy(format(x, "%Y"), 2, fill = " "),
               minor_breaks = seq(as.Date("1950-01-01"),
                                  as.Date("2020-01-01"), by = "2 years")) +
  scale_y_continuous(NULL, minor_breaks = NULL, sec.axis = dup_axis()) +
  scale_color_brewer(NULL, palette = "Dark2", 
                     guide = guide_legend(override.aes = list(fill = NA))) +
  facet_grid(cEOF ~ part) +
  theme(panel.spacing = grid::unit(1.5, "lines"),
        strip.placement = "outside", 
        panel.grid.minor.x = element_line(linetype = 2))  +
  tag_facets("rc") +
  panel_background 
```

To describe the variability of the circulation zonal anomalies, the spatial and temporal parts of the first two leading cEOFs of zonal anomalies of geopotential height at 50 hPa and 200 hPa, computed jointly at both levels, are shown in Figures \@ref(fig:ceofs-1) and \@ref(fig:extended-series).
The first mode (cEOF1) explains 82% of the variance of the zonally anomalous fields, while the second mode (cEOF2) explains a smaller fraction (7%).
In the spatial patterns (Fig. \@ref(fig:ceofs-1)), the real and the imaginary components are in quadrature by construction, so that each cEOF describe a single wave-like pattern whose amplitude and position (i.e. phase) is controlled by the magnitude and phase of the temporal cEOF.
The wave patterns described by these cEOFs match the patterns seen in the standard EOFs of Figure \@ref(fig:eof-naive).

The cEOF1 (Fig. \@ref(fig:ceofs-1) column a) is a hemispheric wave 1 pattern with maximum amplitude at high latitudes.
At 50 hPa the Real cEOF1 has the maximum of the wave 1 at 150ºE and at 200 hPa, the maximum is located at around 175ºE indicating a westerly shift in phase.
The cEOF2 (Fig. \@ref(fig:eof-naive) column b) shows also a zonal wave-like structure with maximum amplitude at high latitudes, but with shorter spatial scales.
In particular, the dominant structure at both levels is a wave 3 but with larger amplitude in the pacific sector.
This modulated amplitude is more evident at 200 hPa.
There is no apparent phase shift with height but the amplitude of the pattern is greatly reduced in the stratosphere, suggesting that this barotropic mode represents mainly tropospheric variability.

There is no significant simultaneous correlation between cEOFs time series.
Both cEOFs show year-to-year variability but show no evidence of decadal variability (Fig. \@ref(fig:extended-series)).
Because the geopotential fields that enter into the cEOFs algorithm are anomalies with respect to the zonal mean instead of the time mean, the cEOFs time series have non zero temporal mean. 
However, cEOF2 temporal mean is almost zero, which indicates that only cEOF1 includes variability that significantly projects onto the mean zonally anomalous field.

A significant positive trend in the real component of cEOF1 is evident (Fig. \@ref(fig:extended-series)a.1, p-value `r trends[part == "Real" & cEOF == "cEOF1"]$p_report`) while there is no significant trend in any of the complex components of cEOF2.
The positive trend in the Real cEOF1 translates into a positive trend in cEOF1 magnitude, but not systematic change in phase (not shown).
This long-term change indicates an increase in the magnitude of the high latitude zonal wave 1.
In agreement, @raphael2003 detected a step change after around 1975 in the temporal evolution of leading EOF computed from August-September-October 500 hPa zonal geopotential height anomalies, which is similar to the cEOF1.

## cEOFs Regression maps {#regressions}

### Geopotential 

In the previous section, cEOFs analysis was applied to zonal anomalies, that is anomalies derived by removing the zonally mean values in order to isolate the main characteristics of the main zonal waves characterizing the circulation in the SH.
In addition, regression fields were computed using the full fields of the variables in order to describe the influence of the cEOFs on the temporal anomalies.

```{r compute-regression}

era5 <- ERA5_temperature() %>% 
  ReadNetCDF(vars = c("t"), 
             subset = list(level = list(50, 200))) %>% 
  normalise_coords() %>% 
  .[season(time) == "SON"] %>%
  .[, w := season_weights(time)] %>% 
  .[, .(t = mean(t*w)), by = .(lev, lon, lat, time = seasonally(time))] %>% 
  .[era5, on = .NATURAL]

regr <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[season == "SON"] %>%
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))),
    by = .(season, cEOF)] %>%
  .[melt(era5, id.vars = c("time", "lon", "lat", "lev")), on = "time", allow.cartesian = TRUE] %>%
  .[, FitLm(value, Imaginary, Real, se = TRUE),
    by = .(lev, lon, lat, variable, cEOF)] %>%
  rm_intercept() %>%
  .[, term := factor_ReIm(term)]
```

```{r plot_regr}
plot_regr <- function(data, which_cEOF, which_levs, which_var) {
  data <- data %>%
    .[ cEOF %in% which_cEOF] %>%
    .[variable == which_var]
  
  var_title <- switch(which_var,
                      hgt = "Geopotential height",
                      t = "Temperature")
  
  
  if (length(which_cEOF) > 1) {
    stop("More than one ceof")
  }
  
  if ("lev" %in% colnames(data)) {
    data <- data[lev %in% which_levs]
  } else {
    data[, lev := which_levs]
  }
  
  data[lat <= -20] %>%
    # .[term == "I" & lev == 50] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(lev, cEOF, term)] %>%
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(exclude = 0),
                      global.breaks = FALSE) +
    geom_contour_tanaka(aes(z = estimate), 
                        breaks = AnchorBreaks(exclude = 0), global.breaks = FALSE) +
    scale_fill_divergent(var_title, breaks = AnchorBreaks(0, exclude = 0),
                         guide = guide_colorstrip_bottom(15)) +
    geom_contour_pval(aes(z = p.value)) +
    
    geom_qmap() +
    
    scale_x_longitude(labels = NULL) +
    scale_y_latitude(labels = NULL,
                     minor_breaks = NULL) +
    grid_y +
    facet_grid(lev ~ term, 
               labeller = labeller(lev = lab_lev)) +
    geom_coords() +
    coord_polar() +
    tag_facets("rc") +
    labs(title = which_cEOF) +
    theme(plot.title = element_text(hjust = 0.5, size = theme_get()$strip.text$size))
}

# From latex2exp::TeX('Geopotential height ($m^2s^{-1}$)')
mpg <- expression('Geopotential height ('*m^{2}*s^{phantom() - 1}*')')
```

(ref:eof1-regr-gh-cap) Regression of SON geopotential height anomalies ($m^2s^{-1}$) with the (column 1) real and (column 2) imaginary parts of the first cEOF for the 1979 -- 2019 period at (row a) 50 hPa and (row b) 200 hPa. These coefficients come from multiple linear regression involving the real and imaginary parts. Areas marked with dots have p-values smaller than 0.01 adjusted for False Detection Rate.

```{r eof1-regr-gh, fig.cap = "(ref:eof1-regr-gh-cap)", fig.height=1.2*width_column, fig.width=width_column, dependson="plot_regr"}
plot_regr(regr , "cEOF1", c(200, 50), "hgt") +
  scale_fill_divergent(mpg,
                       breaks = AnchorBreaks(0, exclude = 0),
                       guide = guide_colorsteps_bottom(15, even.steps = TRUE), 
                       limits = c(-2000, 2000)) 
```

Figure \@ref(fig:eof1-regr-gh) shows regression maps of SON geopotential height anomalies upon cEOF1.
At 50 hPa (Figure \@ref(fig:eof1-regr-gh) row a), the Real cEOF1 is associated with a centre located over the Ross Sea.
The Imaginary cEOF1 is associated with a distinctive wave 1 pattern with maximum over the coast of East Antarctica. 
At 200 hPa (Figure \@ref(fig:eof1-regr-gh) row b) the Real cEOF1 shows a single centre of positive anomalies spanning West Antarctica surrounded by opposite anomalies in lower latitudes, with is centre shifted slightly eastward compared with the upper-level anomalies.
The Imaginary cEOF1 shows a much more zonally symmetrical pattern resembling the negative SAM phase [e.g. @fogt2020].
Therefore, the magnitude and phase of the cEOF1 are associated with the magnitude and phase of a zonal wave mainly in the stratosphere.

(ref:eof2-regr-gh-cap) Same as Figure \@ref(fig:eof1-regr-gh) but for cEOF2.

```{r eof2-regr-gh, fig.cap = "(ref:eof2-regr-gh-cap)", fig.height=1.3*width_column, fig.width=width_column, dependson="plot_regr"}
plot_regr(regr, "cEOF2", c(200, 50), "hgt") +
  scale_fill_divergent(mpg, 
                       breaks = AnchorBreaks(0, 200, exclude = 0),
                       guide = guide_colorsteps_bottom(15, even.steps = TRUE), 
                       limits = c(-1000, 1000))
```

Figure \@ref(fig:eof2-regr-gh) shows the regression maps of geopotential height anomalies upon the cEOF2.
In the troposphere (Fig. \@ref(fig:eof2-regr-gh) column b), wave trains similar to those identified for cEOF2 patterns (Fig \@ref(fig:ceofs-1)) can be distinguished.
Regressed anomalies associated with the Real cEOF2 are 90º out of phase with those associated with the Imaginary cEOF2.
All fields have a dominant zonal wave 3 limited to the western hemisphere, over the Pacific and Atlantic Oceans.
cEOF2 then represents an equivalent barotropic wave train that is very similar to the the PSA Patterns [@mo2001].
Comparing the location of the positive anomaly near 90ºW in column b of Figure \@ref(fig:eof2-regr-gh) with Figures 1.a and b from @mo2001, the Real cEOF2 regression map could be identified with PSA2, while the Imaginary cEOF2 resembles PSA1.

These wave patterns are also present in the stratosphere (Fig. \@ref(fig:eof2-regr-gh) column a) supporting their  equivalent barotropic nature. 
But also present is a monopole over the pole with negative sign associated with the Real cEOF2 and positive sign associated with the Imaginary cEOF2. 
This monopole might indicate strengthening of the polar vortex associated with positive values of the Real cEOF2 and weakening associated with positive Imaginary cEOF2.

### Temperature and Ozone {#temp-ozone}

(ref:eof1-regr-t-cap) Same as Figure \@ref(fig:eof1-regr-gh) but for air temperature (K).

```{r eof1-regr-t, fig.cap = "(ref:eof1-regr-t-cap)",  dependson="plot_regr", fig.height=1.3*width_column, fig.width=width_column}
plot_regr(regr, "cEOF1", c(200, 50), "t") +
  scale_fill_divergent("Temperature (K)", breaks = AnchorBreaks(0, exclude = 0),
                       guide = guide_colorsteps_bottom(15, even.steps = TRUE), 
                       limits = c(-4.5, 4.5))
```

```{r t}
t <- ERA5_temperature() %>% 
  ReadNetCDF(vars = c("t"), 
             subset = list(latitude = o3wave_lats)) %>% 
  normalise_coords() %>% 
  .[season(time) == "SON"] %>% 
  .[, .(t = weighted.mean(t, cos(lat*pi/180))), by = .(lon, lev, time)]

o3_temp <- ERA5_ozone() %>% 
  ReadNetCDF(vars = c("o3"), 
             subset = list(latitude = o3wave_lats)) %>% 
  normalise_coords() %>% 
  .[season(time) == "SON"] %>% 
  .[, .(o3 = weighted.mean(o3, cos(lat*pi/180))), by = .(lon, lev, time)]

t <- t[o3_temp, on = .NATURAL]
rm(o3_temp)

t <- t %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(t   = mean(t*w),
        o3  = mean(o3*w)), by = .(lev, lon, time = seasonally(time))]
```

(ref:t-vertical-cap) Regression of SON zonal anomalies  averaged between `r knitr::combine_words(LatLabel(o3wave_lats))` of mean air temperature (shaded, Kelvin) and ozone mixing ratio (contours, negative contours with dashed lines, labels in parts per billion by mass) with the (a) Real and (b) Imaginary components of the cEOF1 for the 1979 -- 2019 period.

```{r lable_placement_min}
label_placement_min <- function(direction = c("vertical", "horizontal"))  {
  direction <- direction[1]
  function(x, y) {
    browser()
    y <- x[[1]]$y
    x <- x[[1]]$x
    
    if (direction == "vertical") {
      return(which.min(y))
    }
    else if (direction == "horizontal") {
      return(which.min(x))
    }
  }
}
```

```{r t-vertical, fig.cap = "(ref:t-vertical-cap)", fig.height=2.5, fig.width=width_column}
t %>% 
  melt(id.vars = c("lev", "time", "lon")) %>% 
  .[, value := Anomaly(value), by = .(time, lev, variable)] %>%
  .[cut(ceof$eof[[1]], 1)$left, on = "time"] %>% 
  sep_ReIm(format = "wider") %>% 
  .[, ":="(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))), by = .(cEOF)] %>% 
  .[, FitLm(value, Real, Imaginary, se = TRUE), by = .(lev, lon, variable)] %>% 
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)] %>% 
  ggplot(aes(lon, lev)) +
  geom_contour_fill(data = ~.x[variable == "t"],
                    aes(z = estimate, fill = ..level..),
                    breaks = AnchorBreaks(0, binwidth = 0.25, exclude = 0, sym = TRUE)) +
  geom_contour_tanaka(data = ~.x[variable == "t"],
                      aes(z = estimate),
                      breaks = AnchorBreaks(0, binwidth = 0.25, exclude = 0, sym = TRUE)) +
  geom_contour2(data = ~.x[variable == "o3"],
                aes(z = estimate, linetype = factor(-sign(..level..))),
                breaks = AnchorBreaks(0, exclude = 0)) +
  geom_text_contour(data = ~.x[variable == "o3"],
                    aes(z = estimate*1e9, label = signif(..level.., 2)),
                    size = 2,
                    skip = 1, stroke = 0.15, stroke.colour = "white",
                    # label.placement = label_placement_min(),
                    breaks = AnchorBreaks(0, exclude = 0)) +
  
  scale_fill_divergent_discretised("Air temperature (K)",
                                   # limits = c(-2.25, 2.25),
                                   labels = one_less,
                                   guide = guide_colorsteps_bottom(15, show.limits = TRUE)) +
  scale_y_level(minor_breaks= NULL,
                sec.axis = sa_height_axis(breaks = seq(0, 50, by = 10),
                                          labels = function(x) paste0("~", x, " km"))) +
  scale_linetype(guide = "none") +
  scale_x_longitude(ticks = 60) +
  facet_grid(~term) +
  axis_labs_smol +
  coord_cartesian(clip = "off") +
  tag_facets() +
  NULL
```

The signature of cEOFs variability on air temperature was also evaluated.
Figure\ \@ref(fig:eof1-regr-t) shows regression maps of air temperature anomalies at 50 hPa and 200 hPa upon cEOF1. 
The distribution of temperature regression coefficients at 50 hPa and at 200 hPa mirror the geopotential height regression maps at 50 hPa (Fig. \@ref(fig:eof1-regr-gh)).
In both levels, the Real cEOF1 is associated with a positive centre over the South Pole with its centre moved slightly towards 150ºE (Fig. \@ref(fig:eof1-regr-t) column 1).
On the other hand, the regression maps on the Imaginary cEOF1 show a more clear wave 1 pattern with its maximum around 60ºE. 

Figure\ \@ref(fig:t-vertical) shows the vertical distribution of the regression coefficients on cEOF1 from zonal anomalies averaged between `r knitr::combine_words(LatLabel(o3wave_lats))` of air temperature and of ozone mixing ratio. 
Temperature zonal anomalies associated with cEOF1 show a clear wave 1 pattern for both real and imaginary components throughout the atmosphere above 250 hPa with a sign reversal above 10 hPa.
As a result of the hydrostatic balance, this is the level in which the geopotential anomaly have maximum amplitude (not shown).

The maximum ozone regressed anomalies match with the minimum temperature anomalies above 10 hPa and with the maximum temperature anomalies below 10 hPa (Fig. \@ref(fig:t-vertical)).
Therefore, the ozone zonal wave 1 is anticorrelated with the temperature zonal wave 1 in the upper stratosphere, and directly correlated in the upper stratosphere. 
This change in phase is observed in ozone anomalies forced by planetary waves that reach the stratosphere [@hartmann1979; @wirth1993; @smith1995]. 
In the photochemically-dominated upper stratosphere, cold temperatures inhibit the destruction of ozone, explaining the opposite behaviour for both variables.
On the other hand, in the advectively-dominated lower stratosphere, ozone anomalies are 90º out of phase with horizontal and vertical transport, which are in addition 90º out of phase with temperature anomalies, resulting in same sign anomalies for the response of both variables [@hartmann1979; @wirth1993; @smith1995].


```{r o3_regr}
temp <- ceof$eof[[1]]$left %>% 
  .[cEOF == "cEOF1"] %>% 
  copy() %>% 
  sep_ReIm(format = "wider") %>% 
  .[, `:=`(Real = as.numeric(scale(Real)), 
           Imaginary = as.numeric(scale(Imaginary))),
    by = .(cEOF)]
o3_mean <- o3 %>% 
  .[, .(toc = mean(toc)), by = .(lon, lat)] %>% 
  .[, toc_z := Anomaly(toc), by = .(lat)]
o3_regr <- temp %>% 
  o3[., on = "time", allow.cartesian = TRUE] %>% 
  .[, FitLm(toc, Real, Imaginary, se = TRUE), by = .(lon, lat, cEOF)] %>% 
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)]
```

(ref:o3-regr-cap) Regression of SON mean Total Ozone Column anomalies (shaded, Dobson Units) with the (a) real and (b) imaginary components of the cEOF1 for the 1979 -- 2019 period. On contours, the mean zonal anomaly of Total Ozone Column (negative contours in dashed lines, Dobson Units). Areas marked with dots have p-values smaller than 0.01 adjusted for False Detection Rate.

```{r o3-regr, fig.cap = "(ref:o3-regr-cap)", fig.height=3, fig.width = width_column}
o3_regr %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(cEOF, term)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..),
                    breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = estimate), breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour2(data = periodic(o3_mean, lon = c(0, 360)),
                aes(z = toc_z, linetype = factor(-sign(..level..))), 
                breaks = AnchorBreaks(0, exclude = 0), 
                bins = 5) +
  
  geom_contour_pval(aes(z = p.value)) +
  annotate("segment", 
           y  = o3wave_lats,
           yend = o3wave_lats,
           x = 0,
           xend = 360,
           size = 0.3, alpha = 0.8
  ) +
  geom_qmap() +
  scale_fill_divergent_discretised("Total Ozone Column (DU)", 
                                   limits = c(-30, 30), 
                                   breaks = AnchorBreaks(exclude = 0, binwidth = 5)(c(-30, 30)),
                                   guide = guide_colorsteps_bottom(15)) + 
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  scale_linetype(guide = "none") +
  geom_coords() +
  coord_polar() +
  facet_grid(cEOF~term) +
  tag_facets("panel")

```

```{r wave1-o3, fig.cap = "(ref:wave1-o3-cap)", fig.width=width_column, fig.height=width_column*.7, include = FALSE}
wave1_o3 <- o3 %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(toc = mean(toc, na.rm = TRUE)), by = .(time, lon)] %>% 
  .[, FitWave(toc, 1), by = .(time)] 

temp <- ceof$eof[[1]]$left %>% 
  .[cEOF == "cEOF1"] %>% 
  .[wave1_o3, on = "time"]

wave1_cor <- rbind(temp %>%
                     .[, correlate(amplitude, Mod(hgt))] %>% 
                     .[, with := "amplitude"],
                   
                   temp %>%
                     .[, correlate(phase, Arg(hgt))] %>% 
                     .[, with := "phase"])

wave_correlation <- temp %>% 
  na.omit() %>% 
  .[, .(cor = mean(cos(phase - Arg(hgt))),
        n = .N)] %>% 
  .[, correlation_statistics(cor, n)]

# temp %>% 
#   ggplot(aes(Mod(hgt), amplitude)) +
#   scale_x_continuous("EOF1 Amplitude") +
#   scale_y_continuous("O3 Wave-1\nAmplitude") +
#   
#   temp %>% 
#   copy() %>%
#   na.omit() %>% 
#   qwrap(phase = c(0, 2*pi) ~ c(-pi, pi)) %>% 
#   ggplot(aes(Arg(hgt), phase)) +
#   scale_x_continuous("EOF1 Phase",
#                      breaks = seq(-pi, pi, by = 15*pi/180),
#                      labels = function(x) paste0(round(x*180/pi, 5), "º")) +
#   scale_y_continuous("O3 Wave-1\nPhase",
#                      breaks = seq(-pi, pi, by = 30*pi/180),
#                      labels = function(x) paste0(round(x*180/pi, 5), "º"))  +
#   plot_layout(ncol  = 1) &
#   geom_point()  &
#   geom_smooth(method = "lm") & 
#   panel_background

```

(ref:wave1-o3-cap) Relationship between cEOF1 amplitude and phase with amplitude and phase of the zonal wave 1 in Total Ozone Column averaged between `r knitr::combine_words(LatLabel(o3wave_lats))` for the period 1979 -- 2019.

The regression maps of  TOC anomalies upon cEOF1 (Fig.\ \@ref(fig:o3-regr)) show zonal wave 1 patterns  associated with both components of cEOF1.
The climatological position of the springtime Ozone minimum (ozone hole) is  outside the South Pole and towards the Weddell Sea [e.g. @grytsai2011].
Thus, the Real cEOF1 regression field (Figure\ \@ref(fig:o3-regr)a) coincides with the climatological position of the ozone hole, while it is 90° out of phase for the Imaginary cEOF1.
The temporal correlation between the amplitudes of TOC planetary wave 1 and cEOF1 is `r wave1_cor[with == "amplitude"]$text`, while the correlation between their phases is `r wave1_cor[with == "phase"]$text`.
Consequently, cEOF1 is strongly related with the SH ozone variability.

## PSA  {#psa}

(ref:psa-eof2-cap) Correlation coefficients (r) between cEOF2 components and the PSA1 and PSA2 modes computed as @mo2001 for the 1979 -- 2019 period. 95% confidence intervals in parenthesis. p-values lower than 0.01 in bold.

```{r psa-eof2, fig.cap = "(ref:psa-eof2-cap)", fig.width=7, fig.height=3, fig.env="figure*"}
psa2 <- psa$left[PC == "PSA2"][season(time) == "SON"]
cEOF2 <- ceof$eof[[1]]$left[cEOF == "cEOF2"] %>% 
  copy() %>% 
  .[, cEOF := NULL] %>% 
  .[]

rotations_psa <- lapply(angles, function(a) {
  cEOF2 %>% 
    copy() %>% 
    .[, hgt := rotate(hgt, a)] %>% 
    .[psa2, on = "time"] %>% 
    .[, cor(value, Re(hgt))] 
}) 

psa_angle <- angles[which.max(unlist(rotations_psa))]

make_numeric <- function(x) {
  x <- strsplit(x, "\ ")
  vapply(x, function(x) as.numeric(x[[1]]), numeric(1))
}

background_palette <- grDevices::colorRampPalette(c(scales::muted("blue"),
                                                    "white",
                                                    scales::muted("red")),
                                                  space = "Lab")

table <- cEOF2[psa_time, on = "time"] %>% 
  .[PC != "SAM"] %>% 
  copy() %>% 
  sep_ReIm() %>% 
  .[, correlate(value, hgt), by = .(PC, part)] 

p.val <- table %>% 
  dcast(PC ~ part, value.var = "p.value") 

table %>% 
  dcast(PC ~ part, value.var = "text") %>% 
  kbl2(booktabs = TRUE, caption = "(ref:psa-eof2-cap)") %>%
  column_spec2(2:3, bold = p.val[[.col]] < 0.01) %>%
  add_header_above(c("", "cEOF2" = 2)) %>%
  kable_classic() 
```

Given the similarity between the cEOF2 related anomaly structures (Fig. \@ref(fig:eof2-regr-gh)) and documented PSA patterns we study the relationship between them.
Table \@ref(tab:psa-eof2) shows the correlations between the two PSA indices and the time series for Real and Imaginary phases of cEOF2.
As visually anticipated by Figure \@ref(fig:eof2-regr-gh), there is a large positive correlation between PSA1 and Imaginary cEOF2, and between PSA2 and Real cEOF2.
On the other hand, there is no significant relationship between PSA1 and Real cEOF2, and between PSA2 and Imaginary cEOF2.
As a result, cEOF2 represents well both the spatial structure and temporal evolution of the PSA modes, so it is possible to make an association between its two phases and the two PSA modes.
That is, the phase election for cEOF2 that maximises the relationship between ENSO and Imaginary cEOF2, also maximises the association between cEOF2 components and PSA modes (not shown).

(ref:phase-histogram-cap) Histogram of phase distribution of cEOF2 phase for the 1979 -- 2019 period. Bins are centred at 90º, 0º, -90º, -180º with a binwidth of 90º. The small vertical lines near the horizontal axis mark the observations.

```{r phase-histogram, fig.cap = "(ref:phase-histogram-cap)", fig.width=width_column*.8, fig.height=2.5}
N <- nrow(cut(ceof$eof[[1]], 2)$left)
plot <- cut(ceof$eof[[1]], 2)$left %>% 
  .[, arg := Arg(hgt)] %>% 
  .[, w := Mod(hgt)/mean(Mod(hgt))] %>% 
  qwrap(arg = c(-pi, pi) ~  c(-pi - 1/4*pi, pi - 1/4*pi)) %>% 
  ggplot(aes(arg)) +
  geom_histogram(binwidth = 90*pi/180, center = 0, size = 0.2,
                 color = "black", fill = "gray70") + 
  annotate("text",
           label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary"),
           color = "black", size = 3,
           y = 0.5, x = c(-pi, -pi/2, 0, pi/2), angle = 90, hjust = 0) +
  geom_rug() +
  scale_y_continuous("Number of years", 
                     sec.axis = sec_axis(~.x/N, 
                                         name = "Proportion of years", 
                                         labels = scales::percent)) +
  scale_x_continuous("Phase", trans = scales::reverse_trans(),
                     breaks = seq(-pi - 1/4*pi, pi - 1/4*pi, by = 45*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  no_grid

imaginary <- sum(ggplot_build(plot)$data[[1]][c(1, 3), ]$count)/N
plot
```

Figure \@ref(fig:phase-histogram) shows an histogram that counts the number of SON seasons in which the cEOF2 phase was close to each of the four particular phases (positive/negative of real/imaginary component), with the observations for each season marked as rugs on the horizontal axis.
In `r scales::percent(imaginary)` of seasons cEOF2 has a phase similar to either the negative or positive imaginary phase, making the imaginary phase the most common phase. 
This is also, by construction, the phase that is most correlated with ENSO.

Therefore, by virtue of being the most common phase, the Imaginary cEOF2 explains more variance than the Real cEOF2.
Conventional EOF analysis will therefore tend to separate them relatively cleanly, with the EOF representing the Imaginary cEOF2 always leading the one representing the Real cEOF2.
This phase preferences is in agreement with @irving2016, who found a bimodal distribution to PSA-like variability (compare our Figure \@ref(fig:phase-histogram) with their Figure 6).

## SAM {#sam}

(ref:sam-eof-vertical-cap) Coefficient of determination ($r^2$) between each component of cEOFs and the SAM, Asymmetric SAM (A-SAM) and Symmetric SAM (S-SAM) indices computed at each level for the 1979 -- 2019 period. Thick lines represent estimates with p-value < 0.01 corrected for False Detection Rate [@benjamini1995].

```{r sam-eof-vertical, fig.cap = "(ref:sam-eof-vertical-cap)", fig.height=4, fig.width=width_column}
time <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part)]

sam_r2 <- sams %>%
  .[time, on = .NATURAL, allow.cartesian = TRUE] %>%
  na.omit() %>% 
  .[, correlate(hgt, estimate), by = .(lev, term, part, cEOF)]

max_r2 <- sam_r2[part == "Imaginary"] %>% 
  .[, .SD[which.max(estimate^2)], by = .(cEOF, term)]

sam_r2 %>%
  .[, p.value_a := p.adjust(p.value, "fdr")] %>% 
  ggplot(aes(lev, estimate^2)) +
  geom_vline(xintercept = c(50, 200),  size = 0.2, color = "gray50") +
  # geom_point(data = ~.x[p.adjust(p.value, "fdr") < 0.01], aes(color = term)) +
  geom_line(data = ~copy(.x)[p.value_a > 0.01, estimate := NA], 
            aes(colour = stage(term, after_scale = scales::alpha(colour, 0.5))), 
            size = 2) +
  geom_line(aes(color = term, group = term)) +
  
  scale_x_level("Level (hPa)", minor_breaks = NULL, 
                sec.axis = sa_height_axis(breaks = seq(0, 50, by = 10),
                                          labels = function(x) paste0("~", x, " km"))) +
  scale_y_continuous(r2, limits = c(0, 1), 
                     guide = guide_axis(check.overlap = TRUE)) +
  scale_size_manual("p-value", values = c("TRUE" = 1, 
                                          "FALSE" = 0.5), 
                    guide = "none") +
  scale_color_brewer(NULL, palette = "Dark2", labels = c(full = "SAM",
                                                         asym = "A-SAM",
                                                         sym = "S-SAM")) +
  facet_grid(part ~ cEOF) +
  coord_flip() +
  tag_facets("rc") +
  panel_background +
  theme(panel.spacing = grid::unit(1, "lines"), 
        strip.placement = "outside")
```

We now explore the relationship between SAM and the cEOFs motivated by the resemblance between cEOFs regression maps and SAM patterns shown in Section\ \@ref(regressions).
We then computed the coefficient of determination between the cEOFs time series and the three SAM indices (SAM, A-SAM and S-SAM) defined by @campitelli2022 at each vertical level (Fig.\ \@ref(fig:sam-eof-vertical)).
The SAM index is statistically significant correlated with the Real cEOF1 in all levels, and with the Imaginary cEOF1 and Imaginary cEOF2 in the troposphere.
On the other hand, correlations between SAM and the Real cEOF2 are non-significant.

The relationship between the SAM and cEOF1 in the troposphere is explained entirely by the zonally symmetric component of the SAM as shown by the high correlation with the S-SAM below 100 hPa and the low and statistically non-significant correlations between the A-SAM and either the Real or Imaginary cEOF1. 
In the stratosphere, the Real cEOF1 is correlated with both A-SAM and S-SAM, while the Imaginary cEOF1 is highly correlated only with the A-SAM. 
These correlations are consistent with the regression maps of geopotential height in Figure\ \@ref(fig:eof1-regr-gh) and their comparison with those obtained for SAM, A-SAM and S-SAM by @campitelli2022.

In the case of Imaginary cEOF2, its correlation with the SAM for the troposphere is associated to the asymmetric variability of the SAM. 
Indeed, the Imaginary cEOF2 shares up to `r scales::percent(max_r2[cEOF == "cEOF2" & term == "asym"]$estimate^2, 2)` variance with the A-SAM and only `r scales::percent(max_r2[cEOF == "cEOF2" & term == "sym"]$estimate^2, 2)` at most with the S-SAM (Figure \@ref(fig:sam-eof-vertical).b2).
Such extremely high correlation between A-SAM and Imaginary cEOF2 suggests that the modes obtained in this work are able to characterise the zonally asymmetric component of the SAM described previously by @campitelli2022.

## Tropical sources of cEOFs variabitliy {#tropical}

```{r sst}
sst <- ERSST() %>%
  fread() %>% 
  .[season(time) == "SON"] %>%
  normalise_coords() %>%
  .[, w := season_weights(time)] %>% 
  .[, .(t = mean(t*w)), by = .(lon, lat, time = seasonally(time))]
```

```{r cmap}
cmap <- ReadNetCDF(CMAP(), vars = c(pp = "precip"),
                   subset = list(lat = -60:10)) %>%
  normalise_coords() %>%
  .[, w := season_weights(time)] %>% 
  .[, .(pp = mean(pp*w)), by = .(lon, lat, time = seasonally(time))]
```

```{r t2m}
t2m <- ERA5_T2M() %>% 
  ReadNetCDF() %>% 
  normalise_coords() %>%
  .[, w := season_weights(time)] %>% 
  .[, .(t2m = mean(t2m*w)), by = .(lon, lat, time = seasonally(time))]
```

```{r rotated-regressions}
rotate_reim <- function(real, imaginary, angle = 0) {
  z <- complex(real = real, imaginary = imaginary)
  z <- rotate(z, angle)
  list(real = Re(z),
       imaginary = Im(z))
}

angles_regr <- -c(0, 45, 90, 45+90)*pi/180
angles_labs <- setNames(c("Real", "45º", "Imaginary", "135º"), angles_regr*180/pi)

hgt850 <- ERA5_geopotential() %>% 
  ReadNetCDF(vars = c(hgt = "z"), 
             subset = list(level = 850)) %>% 
  normalise_coords() %>%
  .[season(time) == "SON"] %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lon, lat, time = seasonally(time))]

hgt850 <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[season == "SON"] %>%
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = as.numeric(scale(Real)), Imaginary = as.numeric(scale(Imaginary))),
    by = .(season, cEOF)] %>%
  .[hgt850, on = "time", allow.cartesian = TRUE]

hgt850_regr <- lapply(angles_regr, function(a) {
  hgt850 %>% 
    copy() %>% 
    .[, c("Real", "Imaginary") := rotate_reim(Real, Imaginary, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(hgt, Imaginary, Real, se = TRUE), by = .(lon, lat, cEOF, season)] %>%
    rm_intercept() %>%
    .[term == "Real"] %>% 
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
}) %>% 
  rbindlist()

sst_for_regression <- ceof[, eof[[1]]$left, by = .(season)] %>%
  # .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[sst, on = "time", allow.cartesian = TRUE] %>%
  .[season(time) == "SON"] %>% 
  na.omit() 

sst_regr <- lapply(angles_regr, function(a) {
  sst_for_regression %>% 
    copy() %>% 
    .[, c("Real", "Imaginary") := rotate_reim(Real, Imaginary, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(t, Imaginary, Real, se = TRUE), by = .(lon, lat, cEOF, season)] %>%
    rm_intercept() %>%
    .[term == "Real"] %>% 
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
}) %>% 
  rbindlist()

psi_for_regression <-  ceof[, eof[[1]]$left, by = .(season)] %>%
  # .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[psi, on = "time", allow.cartesian = TRUE] %>%
  .[season(time) == "SON"] %>%
  .[lev == 200]

psi_regr <- lapply(angles_regr, function(a) {
  psi_for_regression %>% 
    copy() %>% 
    .[, c("Real", "Imaginary") := rotate_reim(Real, Imaginary, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(psi.z, Real, Imaginary, se = TRUE),by = .(lon, lat, lev, cEOF, season)] %>%
    rm_intercept() %>%
    .[term == "Real"] %>% 
    .[, psi.z := Anomaly(estimate), by = .(cEOF, season, lev, lat)] %>%
    .[, c("fx", "fy") := shceof::WaveFlux(.SD, p = 200), 
      by = .(lev, cEOF, season, term)] %>%
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
}) %>% 
  rbindlist()

pp_for_regression <- ceof[, eof[[1]]$left, by = season] %>%
  # .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[cmap, on = "time", allow.cartesian = TRUE] %>%
  .[season(time) == "SON"] %>% 
  na.omit() %>% 
  .[, pp := pp/sd(pp), by = .(lon, lat)]

pp_regr <- lapply(angles_regr, function(a) {
  pp_for_regression %>% 
    copy() %>% 
    .[, c("Real", "Imaginary") := rotate_reim(Real, Imaginary, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(pp, Imaginary, Real, se = TRUE),
      by = .(lon, lat, cEOF, season)] %>%
    .[term == "Real"] %>% 
    rm_intercept() %>% 
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
  
}) %>%
  rbindlist()

t2m_for_regression <-  ceof[, eof[[1]]$left, by = season] %>%
  # .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  sep_ReIm(hgt, "wide") %>%
  .[, hgt := NULL] %>%
  .[t2m, on = "time", allow.cartesian = TRUE] %>%
  .[season(time) == "SON"] %>% 
  na.omit()

t2m_regr <- lapply(angles_regr, function(a) {
  t2m_for_regression %>% 
    copy() %>% 
    .[, c("Real", "Imaginary") := rotate_reim(Real, Imaginary, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginary = Imaginary/sd(Imaginary)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(t2m, Imaginary, Real, se = TRUE),
      by = .(lon, lat, cEOF, season)] %>%
    .[term == "Real"] %>% 
    rm_intercept() %>% 
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
  
}) %>%
  rbindlist()
```

```{r enso_cor}
enso_cor <-  ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part)] %>%
  enso[., on = "time"] %>%
  na.omit() %>%
  .[, correlate(hgt, oni), by = .(cEOF, part)]
```

```{r dmi_cor}
dmi_cor <-  ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part)] %>%
  dmi[., on = "time"] %>%
  na.omit() %>%
  .[, correlate(hgt, dmi), by = .(cEOF, part)]
```

```{r spoke}
spoke <- function(data, coords) {
  radius <-  grid::unit(.15, "snpc")
  
  outer_circle <-  grid::circleGrob(x = 0, 
                                    y = 0,
                                    r = radius*1.2)
  
  xcentre <- grid::unit(0, "npc") + grid:::grobHeight(outer_circle)/2
  ycentre <-  grid::unit(0, "npc") + grid:::grobWidth(outer_circle)/2
  
  
  circle <- grid::circleGrob(x = xcentre, 
                             y = ycentre,
                             r = radius, 
                             gp = grid::gpar(fill = "white", 
                                             alpha = 0.7))
  # browser()
  dx <- cos(coords$angle[1]*pi/180)*grid::grobHeight(circle)/2
  dy <- sin(coords$angle[1]*pi/180)*grid::grobWidth(circle)/2
  
  
  line <- grid::segmentsGrob(x0 = xcentre, y0 = ycentre, 
                             x1 = xcentre + dx,
                             y1 = ycentre + dy, 
                             gp = grid::gpar(fill = "black"),
                             arrow = grid::arrow(angle = 13, 
                                                 length =  grid::unit(.15/2, "snpc"),
                                                 type = "closed")
  )
  
  grid::gTree(children = grid::gList(circle, line))
  
  
}
```

```{r plot_sst_psi}
plot_sst_psi <- function(sst_regr, psi_regr) {
  sst_gdata <- sst_regr %>%
    # .[cEOF == "cEOF2"] %>% 
    .[lat %between% c(-90, 10)] %>%
    .[, p_val := Pvaluate(estimate, std.error, df, "fdr"), 
      by = .(cEOF, term, angle)] %>%
    .[, var := "SST"]
  
  rsst <- max(range(abs(sst_regr[!is.na(cEOF), ]$estimate), na.rm = TRUE))
  breaks_sst <- AnchorBreaks(0, bins = 20, exclude = 0)(c(-rsst, rsst))
  
  
  stream_gdata <- psi_regr %>%
    # .[cEOF == "cEOF2"] %>% 
    # .[abs(estimate) > 1, estimate := NA] %>%
    .[lat %between% c(-90, 10)] %>%
    .[, p_val := Pvaluate(estimate, std.error, df, "fdr"), by = .(cEOF, angle, term)] %>%
    .[, var := "Streamfunction"]
  
  rstream <- max(range(abs(psi_regr$estimate), 
                       na.rm = TRUE))*1e-7
  breaks_stream <- AnchorBreaks(0, bins = 20, exclude = 0)(c(-rstream, rstream))
  
  #from latex2exp::TeX("Streamfunction ($m^2s^{-1}\\times 1e^{-7}$)")
  psi_expr <- expression('Streamfunction ('*m^{2}*s^{phantom() - 1} %*% 1*e^{phantom() - 7}*')')
  # browser()
  stream_gdata %>% 
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    
    geom_contour_fill(data = sst_gdata,
                      aes(z = estimate, fill = ..level..),
                      breaks = breaks_sst) +
    geom_contour_pval(data = sst_gdata, aes(z = p_val)) +
    
    scale_fill_divergent_discretised("SST (K)",
                                     labels = one_less,
                                     guide = guide_colorsteps_bottom(width = 15,
                                                                     show.limits = FALSE, ticks = TRUE,
                                                                     order = 1)) +
    ggnewscale::new_scale_fill() +
    geom_contour_fill(aes(z = estimate*1e-7, fill = ..level..),
                      breaks = breaks_stream) +
    geom_contour_pval(aes(z = p_val)) +
    # geom_streamline(aes(dx = fx, dy = fy), min.L = 3, L = 10,
    #                 size = 0.1, res = 2, nx = 22, ny = 12, 
    #                 arrow.angle = 14, arrow.length = 0.2) +
    geom_vector(aes(dx = fx, dy = fy), skip = 3, min.mag = 0.002, 
                size = 0.1) +
    scale_mag(max_size = .5, guide = "none") +
    geom_qmap() +
    scale_fill_divergent_discretised(psi_expr, 
                                     labels = one_less,
                                     low = scales::muted("red"),
                                     high = scales::muted("blue"),
                                     guide = guide_colorsteps_bottom(15, show.limits = FALSE,
                                                                     order = 99)) +
    grid_panel(spoke, aes(angle = -angle, var = "SST"), inherit.aes = FALSE) +
    scale_x_continuous(NULL, expand = c(0, 0), 
                       breaks = seq(0, 360, by = 60),
                       labels = LonLabel) +
    
    scale_y_continuous(NULL, breaks  = seq(-90, 0, by = 30), expand = c(0, 0)) +
    
    facet_grid(angle ~ var, labeller = labeller(angle = angles_labs)) +
    # coord_quickmap(ylim = c(NA, 10)) +
    coord_sf(ylim = c(-89, 10), expand = FALSE,
             # crs = "+proj=longlat +pm=180 +over",
             default_crs = "+proj=longlat +lon_wrap=180 +over") + 
    theme(legend.box = "vertical",
          legend.text = element_text(size = rel(0.7)), 
          legend.spacing = grid::unit(0, "lines"),
          legend.box.spacing = grid::unit(0, "lines") ) +
    tag_facets("rc") 
}
```

```{r sst-psi-2,  fig.cap = "(ref:sst-psi-2-cap)", fig.width = 5, fig.height=6, dependson="plot_sst_psi", fig.env="figure*"}
plot_sst_psi(sst_regr[cEOF == "cEOF2"], psi_regr[cEOF == "cEOF2"]) 
```

(ref:sst-psi-2-cap) Regression of SST (K, left column ) and streamfunction zonal anomalies ($m^2/s\times10^-7$, shaded) with their corresponding activity wave flux (vectors) (right column) upon cEOF2 different phases (illustrated in the lower-left arrow) for the 1979 -- 2019 period. Areas marked with dots have p-values smaller than 0.01 adjusted for FDR.

The connections between cEOFs and Tropical sources of variability were also assessed.
Figure \@ref(fig:sst-psi-2) shows the regression maps of Sea Surface Temperatures (SST) and streamfunction anomalies at 200 hPa respectively upon standardised cEOF2.
Besides the regression maps for the Real and Imaginary components, we include the corresponding regressions for two intermediate directions (corresponding to 45° and 135°). 

The Imaginary cEOF2 (second row) is associated with strong positive SST anomalies on the Central Pacific and negative anomalies over an area across northern Australia,  New Zealand the South Pacific Convergence Zone (SPCZ) (Figure \@ref(fig:sst-psi-2).b1).
The regression field of SST anomalies bears a strong resemblance with canonically positive ENSO [@bamston1997].
Indeed, there is a significant and very high correlation (`r enso_cor[cEOF == "cEOF2" & part == "Imaginary"]$text`) between the ONI and the Imaginary cEOF2 time series.
Besides the Pacific ENSO-like pattern, there are positive anomalies in the western Indian Ocean and negative values in the eastern Indian Ocean, resembling a positive IOD [@saji1999].
Consistently, the correlation between the Imaginary cEOF2 and the DMI is `r dmi_cor[cEOF == "cEOF2" & part == "Imaginary"]$text`.

The Imaginary cEOF2 is associated with strong wave-like streamfunction anomalies emanating from the tropics (Figure\ \@ref(fig:sst-psi-2).b2), both from the Central Pacific sector and the Indian Ocean. 
The atmospheric response associated with Imaginary cEOF2 is then consistent with the combined effect of ENSO and the IOD on the extratropics: with SST anomalies inducing anomalous tropical convection that in turn excite Rossby waves propagating meridionally towards higher latitudes [@mo2000; @cai2011; @nuncio2015].

However, the cEOF2 is not associated with the same tropical SST anomaly patterns at all their phases
Figure\ \@ref(fig:sst-psi-2).d1 and d2 show that the Real cEOF2 is not associated either with any significant SST nor streamfunction anomalies in the tropics. 
As a result, the correlation between the Real cEOF2 and ENSO is also not significant  (`r enso_cor[cEOF == "cEOF2" & part == "Real"]$text`).
Meanwhile, Rows a and c in Fig.\ \@ref(fig:sst-psi-2) show that the intermediate phases are still associated with significant SST regressed anomalies over the Pacific Ocean, but at slightly different locations.
The 135º phase is associated with SST anomalies in the central Pacific (Fig.\ \@ref(fig:sst-psi-2)a.1), while the 45º phase is associated with SST anomalies (Fig.\ \@ref(fig:sst-psi-2)c.1) that correspond roughly to the Central Pacific and Eastern Pacific "flavours" of ENSO, respectively [@kao2009].
Both phases could be also associated to wave trains generated in the region surrounding Australia and propagates toward the extra-tropics.

(ref:enso-phase-cap) SON ONI values plotted against cEOF2 phase for the 1979 -- 2019 period. Years with magnitude of cEOF2 greater (smaller) than the 50th percentile are shown as orange diamonds (green circles). Black line is the fit ONI \~ sin(phase) computed by weighted OLS using the magnitude of the cEOF2 as weights.

```{r enso-phase, fig.cap = "(ref:enso-phase-cap)", fig.width = width_column, fig.height=3}
gdata <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[cEOF == "cEOF2"] %>% 
  # .[, hgt := Anomaly(hgt)] %>% 
  .[, arg := Arg(hgt)] %>%
  .[, mag := Mod(hgt)] %>%
  .[enso, on = "time"] %>%
  na.omit() %>%
  .[, q := ifelse(mag >= quantile(mag, 0.5), "|cEOF2| > 50%", "|cEOF2| < 50%")]

cor_enso_mag <- gdata[, correlate(mag, abs(oni))]

cor_enso_spearman <- gdata[, cor.test(mag, abs(oni), method = "spearman")]

cor_enso_mag_outlier <- gdata[oni < 1.5][, correlate(mag, abs(oni))]

cor_enso_mag_quantile <- gdata[mag >= quantile(mag, 0.5)] %>% 
  .[oni < 1.5] %>% 
  .[, correlate(mag, abs(oni))]

cos_model <- gdata %>% 
  .[, lm(oni ~ I(sin(arg)) - 1, weights = mag )]

equation <- bquote(ONI  * {phantom() == phantom()} * .(signif(coef(cos_model)[1], 2)) * sin(Phase) )


gdata %>% 
  ggplot(aes(arg, oni)) +
  geom_hline(yintercept = c(-0.5, 0, 0.5), size = 0.2, color = "gray50") +
  geom_vline(xintercept = 0, size = 0.2, color = "gray50") +
  annotate(shadowtext:::GeomShadowText,
           label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary", "- Real"),
           color = "gray60", bg.colour = "white", bg.r = 0.2,
           size = 3,
           y = -Inf, x = c(-pi, -pi/2, 0, pi/2, pi), angle = 90, hjust = 0) +
  
  geom_smooth(data = ~qwrap(.x, arg = c(-pi, pi) ~ c(-2*pi, 2*pi)),
              method = "lm", aes(weight = mag),
              formula = y ~ I(sin(x)) -1,
              se = FALSE, color = "black", size = 0.5) +
  geom_point(aes(color = q,
                 shape  = q),
             size = 3) +
  ggrepel::geom_text_repel(data = ~.x[order(-oni)][1:3],
                           aes(label = year(time)), size = 2) +
  
  scale_color_brewer("", palette = "Dark2") +
  scale_shape_manual("", values = c(20, 18)) +
  scale_y_continuous("ONI") +
  scale_x_continuous("Phase",
                     breaks = seq(-pi, pi, by = 45*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  coord_cartesian(xlim = c(-pi, pi)) +
  labs(subtitle = equation) +
  panel_background
```

To further explore the relationship between tropical forcing and phases of the cEOF2, Figure\ \@ref(fig:enso-phase) shows the ONI index plotted against the cEOF2 phase for each SON trimester between 1979 and 2019, highlighting years in which the magnitude of cEOF2 is above the median.
In years with positive (negative) ONI, the cEOF2 phase is mostly around 90º (-90°),  corresponding with positive (negative) Imaginary component.
In the neutral ENSO seasons, the cEOF2 phase is much more variable.
The black line in Figure\ \@ref(fig:enso-phase) is a sinusoidal fit of the relationship between ONI and cEOF2 phase.
The $r^2$ corresponding to the fit is `r signif(summary(cos_model)$r.squared, 2)`, statistically significant with p-value `r report_p(coef(summary(cos_model))[4])`, indicating a quasi-sinusoidal relation between these two variables.

The correlation between the absolute magnitude of the ONI index and the  cEOF2 amplitude is `r cor_enso_mag$text`. 
However, this relationship is mostly driven by the three years with strongest ENSO events in the period (`r knitr::combine_words(year(gdata[order(-oni)][1:3]$time))`) which coincide with the three years with strongest cEOF2 magnitude (not shown).
If those years are removed, the correlation becomes non-significant (`r cor_enso_mag_outlier$text`).
Furthermore, even when using all years, the Spearman correlation --which is robust to outliers-- is also non-significant (`r signif(cor_enso_spearman$estimate, 2)`, p-value`r report_p(cor_enso_spearman$p.value)`). 
Therefore, although the location of tropical SST anomalies seem to have an effect in defining the phase of the cEOF2, the relationship between the magnitude of cEOF2 and ONI remains uncertain and might be only evident in very strong ENSO events, that are scarce in the historical observational record.

It could be concluded that the wave train represented by cEOF2 can be both part of the internal variability of the extratropical atmosphere or forced by tropical SSTs.
In the former case, the wave train has little phase preference.
However, when cEOF2 is excited by tropical SST variability, it tends to remain locked to the imaginary phase.
This explains the relative over-abundance of years with cEOF2 near positive and negative imaginary phase in Figure\ \@ref(fig:phase-histogram).

Unlike the cEOF2 case, there are no significant  SST regressed anomalies associated with either the Real or Imaginary cEOF1 (Sup. Figure\ \@ref(fig:sst-psi-1)). 
Consistently, streamfunction anomalies do not show any tropical influence. 
Instead, the real and Imaginary cEOF1 are associated with zonally wave activity fluxes in the extra-tropics around 60ºS, except for an equatorward flow from the coast of Antarctica around 150ºE in the Real component. 
This suggests that the variability of cEOF1 is driven primary by the internal variability of the extra-tropics.

## cEOFs surface impacts {#precipitation}

```{r pp-t2m-r2, fig.cap = "(ref:cap-pp-t2m-r2)", fig.width=5, fig.height=3}
breaks <- seq(.2, 1, by = .1)

rbind(Precipitation = pp_regr,
      `2-metre Temperature` = t2m_regr, idcol = "var") %>% 
  .[angle == 0] %>% 
  .[is.finite(r.squared)] %>% 
  # .[cEOF == "cEOF2"] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = r.squared, fill = ..level..), breaks = breaks) +
  geom_contour_tanaka(aes(z = r.squared), breaks = breaks) +
  # geom_text_contour(aes(z = r.squared, 
  #                       label = ifelse(..level.. > 0.2, scales::percent(..level..), NA)), 
  #                   breaks = breaks, size = 2,
  #                   skip = 1, stroke = 0.15, stroke.colour = "white") +
  geom_qmap() +
  scale_fill_divergent_discretised(name = "Explained variance", midpoint = 0,
                                   labels = scales::percent_format(),
                                   guide = guide_colorsteps_bottom(15, show.limits = TRUE)) +
  
  scale_x_continuous(NULL, expand = c(0, 0),
                     breaks = seq(0, 360, by = 60),
                     labels = LonLabel) +
  scale_y_continuous(NULL, breaks  = seq(-90, 0, by = 30), expand = c(0, 0)) +
  
  facet_grid(var ~ cEOF) +
  # coord_quickmap(ylim = c(NA, 10)) +
  coord_sf(ylim = c(NA, 10),
           default_crs = "+proj=longlat +lon_wrap=180 +over") + 
  theme(legend.box = "horizontal",
        legend.text = element_text(size = rel(0.7)), 
        legend.box.spacing = grid::unit(0, "lines") ) +
  tag_facets("rc") 
```

(ref:cap-pp-t2m-r2) Explained variance ($r^2$ as percentage) of 2-metre temperature (row a) and precipitation (row b) anomalies by the regression upon cEOF1 (column 1) and cEOF2 (column 2).

The influence of cEOFs variability in the anomalies of both 2-metre air temperature and precipitation in the SH was also explored.
Figure\ \@ref(fig:pp-t2m-r2) shows the 2-meter temperature or precipitation anomalies explained variance by the multiple linear model of both Real and Imaginary cEOF1 components (column 1), and both Real  and Imaginary cEOF2 components (column 2).
The variance explained by cEOF1 for precipitation anomalies is extremely low and also for most of the temperature anomalies, except for the northern tip of the Antarctic Peninsula, northern Weddell Sea and the Ross Sea coast (Fig.\  \@ref(fig:pp-t2m-r2)a.1). 

On the other hand, the cEOF2  explained variance is greater than 50% in some regions for both variables (Fig.\ \@ref(fig:pp-t2m-r2) column 2). 
For 2-metre temperature, there are high values in the tropical Pacific and the SPCZ, as well as the region following an arc between New Zealand and the South Atlantic, with higher values in the Southern Ocean.
Over the continents, there are moderate values of about 30% variance explained  in southern Australia, Southern South America and the Antarctic Peninsula.
For precipitation, there are high values over the tropics. At higher latitudes, moderate values are observed over eastern Australia and some regions of southern South America.

Since the cEOF1 has a relatively weak signal in the surface variables explored here, we will only focus on the cEOF2 influence.

```{r add_continents}
continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -13)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))

add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon &
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon &
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>%
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>%
    .[]
}

crop_continent <- function(continent) {
  bbox <- c(xmin = min(continents[[continent]]$lon), 
            xmax = max(continents[[continent]]$lon),
            ymin = min(continents[[continent]]$lat),
            ymax = max(continents[[continent]]$lat))
  
  function(data) {
    s2 <- sf::sf_use_s2(FALSE)
    on.exit(sf::sf_use_s2(s2))
    data <- sf::st_crop(data, bbox)
    data$continent <- continent
    data
  }
}
```

```{r plot_pp}
plot_pp <- function(pp_regr, t2m_regr, hgt850_regr) {
  lats <- c(-55, 10)
  breaks_pp <- AnchorBreaks(exclude = 0)(c(-.9, .9))
  
  pp_regr <- pp_regr %>% 
    copy() %>% 
    .[, var := "Precipitation"] %>% 
    .[, p.value := Pvaluate(estimate, std.error, df, "none"), 
      by = .(cEOF, angle)]
  
  t2m_regr <- t2m_regr %>% 
    copy() %>% 
    .[, var := "2m Temperature"] %>% 
    .[, p.value := Pvaluate(estimate, std.error, df, "none"), by = .(cEOF, angle)]
  
  
  pp_regr %>%
    # .[lat %between% lats] %>% 
    
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    
    geom_contour_fill(aes(z = estimate, fill = ..level..),
                      breaks = breaks_pp) +
    geom_contour_tanaka(aes(z = estimate), breaks = breaks_pp) +
    
    
    scale_fill_divergent_discretised("Precipitation (correlation)", 
                                     # limits = c(-1, 1),
                                     low = "#8E521C",
                                     high = "#00665E",
                                     guide = guide_colorsteps_bottom(15, order = 99)) +
    geom_contour_pval(aes(z = p.value)) +
    
    ggnewscale::new_scale_fill() +
    
    
    geom_contour_fill(data = t2m_regr, 
                      aes(z = estimate, fill = ..level..), 
                      breaks = AnchorBreaks(exclude = 0)) +
    geom_contour_tanaka(data = t2m_regr, 
                        aes(z = estimate),
                        breaks = AnchorBreaks(exclude = 0)) +
    
    scale_fill_divergent_discretised("Temperature",
                                     # limits = c(-1, 1),
                                     guide = guide_colorsteps_bottom(15, order = 1)) +
    geom_contour_pval(data = t2m_regr, aes(z = p.value)) +
    
    geom_contour2(data = copy(hgt850_regr)[, var := "2m Temperature"], 
                  aes(z = estimate, linetype = factor(-sign(..level..))), 
                  size = 0.2, breaks = AnchorBreaks(0, exclude = 0)) +
    
    geom_qmap() +
    
    grid_panel(spoke, aes(angle = -angle, var = "SST"), inherit.aes = FALSE) +
    
    scale_x_continuous("", expand = c(0, 0), breaks = seq(0, 360, by = 30), 
                       labels = LonLabel) +
    scale_y_continuous("", expand = c(0, 0), breaks = seq(-90, 0, by = 15), 
                       labels = LatLabel) +
    # scale_y_latitude(ticks = 15, labels = LatLabel) +
    scale_linetype_discrete(guide = "none") +
    facet_grid(angle ~ var, labeller = labeller(angle = angles_labs)) +
    axis_labs_smol +
    tag_facets("rc") +
    coord_sf(ylim = c(NA, 10),
             default_crs = "+proj=longlat +over") +
    theme(panel.spacing = grid::unit(1, "lines")) +
    theme(legend.box = "vertical",
          legend.spacing = grid::unit(0, "lines"),
          legend.text = element_text(size = rel(0.7)), 
          legend.box.spacing = grid::unit(0, "lines") ) 
  
}
```

```{r boxes}
sesa <- list(lon = c(300, 315),
             lat = c(-35, -22))
box_australia <- data.frame(cEOF = "cEOF2", 
                            lon = c(130, 155),
                            lat = c(-40, -15))
```


Figure\ \@ref(fig:pp-temp-2) shows regression maps of 2-metre temperature (column 1) and precipitation (column 2) anomalies upon different phases of standardised cEOF2.

(ref:pp-temp-cap) Regression of SON mean 2-meter temperature (K, shaded) and 850 hPa geopotential height (m, contours) (column 1), and precipitation (correlation, column 2) upon different phases of cEOF2. For the 1979 -- 2019. Areas marked with dots have p-values smaller than 0.01 adjusted for False Detection Rate.

```{r pp-temp-2, fig.cap="(ref:pp-temp-cap)", fig.width=5, fig.height=6, dependson="plot_pp"}
plot_pp(pp_regr[cEOF == "cEOF2"], t2m_regr[cEOF == "cEOF2"], hgt850_regr[cEOF == "cEOF2"])
```

Temperature anomalies associated with the Imaginary cEOF (Fig.\ \@ref(fig:pp-temp-2).b1) show positive values in the tropical Pacific, consistent with SSTs anomalies associated with the same phase (Fig.\ \@ref(fig:sst-psi-2).b1).

At higher latitudes there is a wave-like pattern of positive and negative values that coincide with the nodes of the 850 hPa geopotential height regression patterns.
This is consistent with temperature anomalies produced by meridional advection of temperature by the meridional winds arising from geostrophic balance.

Over the continents, the Imaginary cEOF2 (Fig.\ \@ref(fig:pp-temp-2)b.1) is associated with positive regressed temperature anomalies in southern Australia and negative regressed anomalies in southern South America and the Antarctic Peninsula, that are a result of the wave train described before.

The temperatures anomalies associated with the Real cEOF2 (Fig.\ \@ref(fig:pp-temp-2)d.1) are less extensive and restricted to mid and high latitudes.   
Over the continents, the temperature anomalies regressions are non significant, except for positive anomalies near the Antarctic Peninsula.

Tropical precipitation anomalies associated with the Imaginary cEOF2 are strong, with positive anomalies in the central Pacific and western Indian, and negative anomalies in the eastern Pacific (Fig.\ \@ref(fig:pp-temp-2)b.2). 
This field is consistent with the SST regression map (Fig.\ \@ref(fig:pp-temp-2)b.1) as the positive SST anomalies enhance tropical convection and the negative SST anomalies inhibits it. 

In the extra-tropics, the positive Imaginary cEOF2 is related to drier conditions over eastern Australia and the surrounding ocean, that it is similar signal as the one associated with ENSO [@cai2011].
However, the Imaginary cEOF2 is not the direction most correlated with precipitation in that area. 
The 135º phase (an intermediate between positive Imaginary and negative Real cEOF2) component is associated with stronger and more extensive temporal correlations  with precipitation over Australia and New Zealand. 
The influence of cEOF2 in Australian precipitation could be more related to the direct impacts of SST anomalies in the surrounded oceans rather than on the interconnection pattern represented by the cEOF2.

Over South America, the Imaginary cEOF2 has positive correlations with precipitation in South Eastern South America (SESA) and central Chile, and negative correlations in eastern Brazil. This correlation field  matches the springtime precipitation signature of ENSO [e.g. @cai2020a] and it is also similar to the precipitation anomalies associated with the A-SAM [@campitelli2022].

This result is not surprising considering the close relationship of the Imaginary cEOF2 with both ONI and A-SAM index, which was shown previously.  
Furthermore, it consolidates the identification of the cEOF2 with the PSA pattern. Resembling the relationship between ONI and the phase of cEOF2 (Fig.\  \@ref(fig:enso-phase)), there is a cEOF2 phase dependence of the precipitation anomalies in SESA (not shown). 

The correlation coefficients between precipitation anomalies and the Real cEOF2 (Fig.\ \@ref(fig:pp-temp-2)d.2) are weaker than for Imaginary cEOF2.
There is a residual positive correlation in the equatorial eastern Pacific and small, not statistically significant positive correlations over eastern Australia and negative ones over New Zealand.

# Discussion and conclusions {#discussion}

In this study we assessed extratropical Southern Hemisphere zonally asymmetric circulation in austral spring. For this purpose, two complex indices were derived using Complex Empirical Orthogonal Functions and used to characterise both amplitude and phase of planetary waves.

The cEOF1 represents the variability of the zonal wave 1 in the stratosphere and is closely related to stratospheric variability such as anomalies in Total Ozone Column. Otherwise, this complex EOF is not related with SST variability and continental precipitation in the Southern Hemisphere. On the other hand, the cEOF2 represents a wave-3 pattern with maximum magnitude in the Pacific sector, that is an alternative representation of the PSA1 and PSA2 patterns (Mo and Paegle 2001). The Imaginary cEOF2 can be identified with the PSA1 and the Real cEOF2 with the PSA2. 

While the cEOF2 variability could be related to surface impacts, the cEOF1 influence is almost negligible. For instance, precipitation anomalies in South America associated with the Imaginary cEOF2 show a clear ENSO-like impact, with positive anomalies in South-Eastern South America, negative anomalies in Southern Brazil and positive anomalies in central Chile for positive Imaginary cEOF2 phase. 

Variability patterns that arise from cEOF methodology describe the zonally asymmetric springtime extratropical SH circulation, reproducing previous features such as the variability related to PSAs or A-SAM.

However the advantage of using the methodology proposed here could be questioned.
Firstly, the spatial fields obtained from both components of cEOF2, that resembles PSA patterns, are in quadrature by construction.
Thus, the cEOF methodology allows to derive a joint PSA index from the resulted amplitude and phase.
Secondly, because of how these components are constructed, they are not forced to be orthogonal to other modes of circulation, as in the standard EOF methodology. 
This allows us to show for example, that the Imaginary cEOF2, that resembles PSA1 variability, is closely associated to the SAM in the troposphere. 
Moreover, the high correlation of this component to the zonally asymmetric portion of the SAM allow us to speculate that the A-SAM might actually be a statistical contamination of the PSA mode on the symmetric SAM. 

@irving2016 argued that there is some disagreement in the literature of whether the phase of the PSA pattern is affected by the location of tropical SST anomalies.
With the methodology used in this study, we were able to show not only that the cEOF2 tends to be in the positive or negative imaginary phase (\~PSA1) when the ENSO region is warm or cold, respectively, but also that central Pacific SST anomalies tend to align the cEOF towards the negative real phase and eastern Pacific SST anomalies tend to align it towards positive real phase.
When ENSO phase is neutral, the cEOF2 is still as active, but with no preferred phase.
The latter agrees with the results of @cai2002, who showed that the CSIRO Model can develop PSA-like variability even in the absence of ENSO forcing (i.e. with a climatological run), but that the variability of one of the PSA modes was enhanced when adding the ENSO signal. 
The sensitivity of the phase of the PSAs to the location of the tropical SST anomalies was also seen by @ciasto2015, who detected similar Rossby wave patterns associated with central Pacific and eastern Pacific SST anomalies but with a change in phase.

The method used in this study have similarities to the one used by @goyal2022 as they construct an index of amplitude and phase of zonal wave 3-like variability by combining the two leading EOFs of meridional wind anomalies. 
The patterns obtained by them bear high resemblance with cEOF2. 
Although a detailed comparison is out of scope for this paper, the cEOF analysis has the advantage of constructing the indices based on patterns that are exactly in quadrature by construction.

The methodology proposed in this study allows for a deeper understanding of the zonally asymmetric springtime extratropical SH circulation such as a better description of PSA like variability using a unique complex index and the understanding of relationship between PSAs and ENSO or SAM variability. 
Further work should extend this analysis to other seasons and further study the relationship between the cEOF2 and the SAM.


## Availability of data and material {.unnumbered}

All data used in this paper available in a version-controlled repository [@campitelli2022a]. 
It is also freely available from their respective sources:

- ERA5 data can be obtained via the Copernicus Climate Data Store (<https://cds.climate.copernicus.eu/cdsapp\#!/dataset/reanalysis-era5-pressure-levels-monthly-means\>).

- ERSSTv5 can be obtained via NOAA's NCEI websiste at <https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00927>

- CMAP Precipitation data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at <https://psl.noaa.gov/data/gridded/data.cmap.html>.

- The Oceanic Niño Index is available via NOAA's Climate Prediction Center: <https://www.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/detrend.nino34.ascii.txt>.

-   The Oceanic Niño Index is available via NOAA's Climate Prediction Center: <https://www.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/detrend.nino34.ascii.txt>.

-   The Dipole Mode Index is available via Global Climate Observing System Working Group on Surface Pressure: <https://psl.noaa.gov/gcos_wgsp/Timeseries/Data/dmi.had.long.data>


## Code availability {.unnumbered}

A version-controlled repository of the code used to create this analysis, including the code used to download the data can be found at <https://github.com/eliocamp/shceof>.



\backmatter


\bmhead{Acknowledgments}

The research was supported by UBACyT20020170100428BA and the CLIMAX Project funded by Belmont Forum/ANR-15-JCL/-0002-01. Elio Campitelli was supported by a PhD grant from CONICET, Argentina.


\appendix

\counterwithin{figure}{section}

# Extra figures

\newpage

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

(ref:sst-psi-1-cap) Same as Figure \@ref(fig:sst-psi-2) but for cEOF1.

```{r sst-psi-1, fig.cap = "(ref:sst-psi-1-cap)", fig.width = 5, fig.height=6, dependson="plot_sst_psi", fig.env = "figure*"}
plot_sst_psi(sst_regr[cEOF == "cEOF1"], psi_regr[cEOF == "cEOF1"]) 
```

(ref:pp-temp-cap-1) Same as Figure \@ref(fig:pp-temp-2) but for cEOF1.


```{r pp-temp-1, fig.cap="(ref:pp-temp-cap-1)", fig.width=6.6, fig.height=5.5, dependson="plot_pp"}
plot_pp(pp_regr[cEOF == "cEOF1"], t2m_regr[cEOF == "cEOF1"], hgt850_regr[cEOF == "cEOF1"])
```
