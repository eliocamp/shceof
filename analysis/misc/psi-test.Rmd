---
title: "Pescaditos"
author: "Elio Campitelli"
date: "02/11/2020"
output: bookdown::html_document2
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)

library(metR)
library(data.table)
library(magrittr)
library(ggplot2)
library(shceof)
```


Este documento documenta el resultado de usar `solve_poisson()` para obtener la funci贸n corriente (en particular, su anomal铆as zonal) a partir de la vorticidad. 

Dado que ERA provee vorticidad pero no funci贸n corriente, ten铆a que usar NCEP. Pero NCEP tiene funci贸n corriente en (algunos) niveles sigma, por lo cual si yo hago el an谩lisis usando ERA5 en niveles de presi贸n, la comparaci贸n con la funci贸n corriente tiene ya dos incompatibilidades (aunque tampoco tan grandes, preliminarmente, los resultados no var铆an mucho usando la funci贸n corriente de NCEP en sigma 0.2101 o la funci贸n corriente derivada de ERA5 en 200 hPa.).

En cualquier caso, antes de usar `solve_poisson()` quiero chequear que funciona correctamente. Lo que voy a hacer es usar la vorticidad de NCEP en sigma 0.2101 para obtener la funci贸n corriente y comparar el resultado con el valor descargado de NCEP. 

Como detalle, si a la funci贸n corriente se le suma y multiplica constantes, sigue siendo soluci贸n de la ecuaci贸n de Poisson, por lo que la soluci贸n obtenida por `solve_poisson()` puede tener cualquier escala que nada que ver. Para resolver esto, voy a escalar la funci贸n corriente derivada con constantes obtenidas a partir de hacer `lm(psi ~ ps_derivada)`. 

```{r}
psi <- NCEP_PSI() %>% 
  ReadNetCDF(subset = list(level =  0.2101, 
                           time = c("1979-01-01", NA))) %>% 
  rm_singleton()
 
vor <-  NCEP_VOR() %>% 
  ReadNetCDF(subset = list(level =  0.2101, 
                           time = c("1979-01-01", NA))) %>% 
  rm_singleton()


ncep <- vor[psi, on = .NATURAL] %>% 
  na.omit()
rm(psi, vor)
```

```{r}
psi_derived <- ncep[, solve_poisson(vor, lon, lat), by = time]
setnames(psi_derived, "value", "psi_derived")
```


```{r}
ncep <- ncep[psi_derived, on = .NATURAL]


scaling <- ncep[, FitLm(psi, psi_derived)]
ncep[, psi_derived := psi_derived*scaling$estimate[2] + scaling$estimate[1]]
ncep[, `:=`(psi         = Anomaly(psi),
           psi_derived = Anomaly(psi_derived)), by = .(lat, time)] 
```

La Figura \@ref(fig:comparacion) muestra cuatro campos de anomal铆a zonal de geopotencial tomados al azar. La funci贸n corriente derivada con es casi indistinguible de la funci贸n corriente "real". La correlaci贸n global durante todo el per铆odo entre la funci贸n corriente real y la derivada es de `r ncep[, cor(psi, psi_derived)]`. Pr谩cticamente perfecto. 



```{r comparacion, fig.cap = "Anomal铆a zonal de funci贸n corriente provista por NCEP (panel izquierdo) y derivada a partir de la vorticidad (panel derecho)"}
set.seed(42)
ncep[time %in% sample(unique(time), 4)] %>% 
  melt(id.vars = c("lon", "lat", "time"), measure.vars = patterns("^psi")) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = value)) +
  scale_fill_divergent() +
  facet_grid(factor(time)~variable)
```
La correlaci贸n es igual de alta para todos los campos (\@ref(fig:cor-tiempo)) y latitudes (\@ref(fig:cor-lat)). 

```{r, cor-tiempo, fig.cap = "Correlaci贸n entre funci贸n corriente derivada y obtenida por NCEP  trav猫s del tiempo."}
ncep %>% 
  .[, cor(psi, psi_derived), by = .(time)] %>% 
  ggplot(aes(time, V1)) +
  geom_line() +
  scale_y_continuous(limits = c(0, 1))
```

```{r cor-lat, fig.cap = "Correlaci贸n entre funci贸n corriente derivada y obtenida por NCEP para cada latitud"}
ncep %>% 
  .[, cor(psi, psi_derived), by = .(lat)] %>% 
  ggplot(aes(lat, V1)) +
  geom_line() +
  scale_y_continuous(limits = c(0, 1))
```

## Conclusi贸n

`solve_poisson` funciona perfecto para obtener funci贸n corriente a partir de vorticidad! コ

